# v7.120 æœç´¢å¼•ç”¨ WebSocket æ¨é€ä¿®å¤

**ä¿®å¤æ—¥æœŸ**: 2026-01-03
**ç‰ˆæœ¬**: v7.120
**ä¼˜å…ˆçº§**: é«˜ï¼ˆCritical Fixï¼‰

## é—®é¢˜æè¿°

æ ¹æ®æœç´¢å·¥å…·è¯Šæ–­æŠ¥å‘Š (`SEARCH_TOOLS_DIAGNOSTIC_REPORT.md`)ï¼Œæœç´¢ç»“æœæœªåœ¨å‰ç«¯æ˜¾ç¤ºçš„æ ¹æœ¬åŸå› æ˜¯ï¼š

**WebSocketæ¨é€ç¼ºå¤±search_referenceså­—æ®µ**

è™½ç„¶åç«¯å·¥ä½œæµæ­£ç¡®æ‰§è¡Œæœç´¢å·¥å…·å¹¶å°†ç»“æœå­˜å‚¨åœ¨stateçš„`search_references`å­—æ®µä¸­ï¼Œä½†WebSocketæ¨é€ç»™å‰ç«¯çš„æ¶ˆæ¯ä¸­ä¸åŒ…å«æ­¤å­—æ®µï¼Œå¯¼è‡´å‰ç«¯`SearchReferences`ç»„ä»¶æ— æ³•æ¥æ”¶æ•°æ®ã€‚

## è¯Šæ–­è¯æ®

```bash
# è¯Šæ–­è„šæœ¬å‘ç°
grep -n "search_references" intelligent_project_analyzer/api/server.py
# ç»“æœ: 0 matches found âŒ
```

- âœ… æ‰€æœ‰4ä¸ªæœç´¢å·¥å…·ï¼ˆTavily, Bocha, ArXiv, RAGFlowï¼‰è¿æ¥æ­£å¸¸
- âœ… æœç´¢æŸ¥è¯¢ç”Ÿæˆæ­£å¸¸
- âœ… æœç´¢æ‰§è¡Œæ­£å¸¸ï¼Œè¿”å›ç»“æœ
- âœ… `ToolCallRecorder` æ­£ç¡®è½¬æ¢ä¸º `SearchReference` æ ¼å¼
- âœ… å‰ç«¯ `SearchReference` TypeScript ç±»å‹å·²å®šä¹‰
- âŒ **WebSocket æ¨é€ä¸åŒ…å« search_references**

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶

`intelligent_project_analyzer/api/server.py`

### ä¿®æ”¹å†…å®¹

#### 1. èŠ‚ç‚¹è¾“å‡ºå¤„ç† (Lines 1417-1432)

**ä¿®æ”¹å‰**:
```python
await session_manager.update(session_id, {
    "current_node": node_name,
    "detail": detail,
    "history": history
})
```

**ä¿®æ”¹å**:
```python
# ğŸ”¥ v7.120: æå–search_referencesï¼ˆå¦‚æœèŠ‚ç‚¹æ›´æ–°äº†æ­¤å­—æ®µï¼‰
update_data = {
    "current_node": node_name,
    "detail": detail,
    "history": history
}

# æ£€æŸ¥å¹¶æå–search_references
if isinstance(node_output, dict) and "search_references" in node_output:
    search_refs = node_output["search_references"]
    if search_refs:  # åªæœ‰éç©ºæ‰æ›´æ–°
        update_data["search_references"] = search_refs
        logger.info(f"ğŸ” [v7.120] èŠ‚ç‚¹ {node_name} æ›´æ–°äº† {len(search_refs)} ä¸ªæœç´¢å¼•ç”¨")

await session_manager.update(session_id, update_data)
```

**ä½œç”¨**: ä»èŠ‚ç‚¹è¾“å‡ºä¸­æå– `search_references` å¹¶å­˜å‚¨åˆ° Redis ä¼šè¯ä¸­ã€‚

#### 2. çŠ¶æ€æ›´æ–°å¹¿æ’­ (Lines 1508-1523)

**ä¿®æ”¹å‰**:
```python
await broadcast_to_websockets(session_id, {
    "type": "status_update",
    "status": current_session["status"],
    "progress": progress,
    "current_node": current_node_name,
    "detail": current_session.get("detail")
})
```

**ä¿®æ”¹å**:
```python
# ğŸ”„ ç›´æ¥ä½¿ç”¨è®¡ç®—å€¼å¹¿æ’­åˆ° WebSocketï¼ˆé¿å… Redis è¯»å–ç«æ€ï¼‰
# ğŸ”¥ v7.120: åŒ…å«search_references
broadcast_data = {
    "type": "status_update",
    "status": current_session["status"],
    "progress": progress,
    "current_node": current_node_name,
    "detail": current_session.get("detail")
}

# æ·»åŠ search_referencesï¼ˆå¦‚æœå­˜åœ¨ï¼‰
search_refs = current_session.get("search_references")
if search_refs:
    broadcast_data["search_references"] = search_refs

await broadcast_to_websockets(session_id, broadcast_data)
```

**ä½œç”¨**: åœ¨æ¯æ¬¡çŠ¶æ€æ›´æ–°å¹¿æ’­ä¸­åŒ…å« `search_references`ï¼Œå‰ç«¯å¯å®æ—¶æ¥æ”¶æœç´¢ç»“æœã€‚

#### 3. å®ŒæˆçŠ¶æ€å¹¿æ’­ (Lines 1617-1632)

**ä¿®æ”¹å‰**:
```python
await broadcast_to_websockets(session_id, {
    "type": "status_update",
    "status": "completed",
    "progress": 1.0,
    "final_report": final_report or "åˆ†æå®Œæˆ",
    "current_node": updated_session.get("current_node") if updated_session else None,
    "detail": updated_session.get("detail") if updated_session else None
})
```

**ä¿®æ”¹å**:
```python
# ğŸ”¥ å¹¿æ’­å®ŒæˆçŠ¶æ€ï¼ˆv7.120: åŒ…å«search_referencesï¼‰
completion_broadcast = {
    "type": "status_update",
    "status": "completed",
    "progress": 1.0,
    "final_report": final_report or "åˆ†æå®Œæˆ",
    "current_node": updated_session.get("current_node") if updated_session else None,
    "detail": updated_session.get("detail") if updated_session else None
}

# æ·»åŠ search_referencesï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if updated_session and updated_session.get("search_references"):
    completion_broadcast["search_references"] = updated_session["search_references"]
    logger.info(f"ğŸ“š [v7.120] å®Œæˆå¹¿æ’­åŒ…å« {len(updated_session['search_references'])} ä¸ªæœç´¢å¼•ç”¨")

await broadcast_to_websockets(session_id, completion_broadcast)
```

**ä½œç”¨**: åœ¨åˆ†æå®Œæˆæ—¶ï¼Œç¡®ä¿å‰ç«¯æ¥æ”¶åˆ°æ‰€æœ‰ç´¯ç§¯çš„æœç´¢å¼•ç”¨ã€‚

## æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æµ

```
[å·¥ä½œæµèŠ‚ç‚¹]
    â†’ è¿”å› {search_references: [...]}
    â†’ [server.py] æå–å¹¶å­˜å‚¨åˆ° Redis session
    â†’ [server.py] WebSocket å¹¿æ’­åˆ°å‰ç«¯
    â†’ [Frontend] SearchReferences ç»„ä»¶æ¥æ”¶å¹¶å±•ç¤º
```

### SearchReference æ•°æ®ç»“æ„

```typescript
interface SearchReference {
  source_tool: 'tavily' | 'bocha' | 'arxiv' | 'ragflow';
  title: string;
  url?: string;
  snippet: string;
  relevance_score?: number;
  deliverable_id: string;
  query: string;
  timestamp: string;
  // ... å…¶ä»–å¯é€‰å­—æ®µ
}
```

### æ—¥å¿—å¢å¼º

æ–°å¢æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºè¿½è¸ª search_references çš„æå–å’Œå¹¿æ’­ï¼š

```
ğŸ” [v7.120] èŠ‚ç‚¹ agent_executor æ›´æ–°äº† 5 ä¸ªæœç´¢å¼•ç”¨
ğŸ“š [v7.120] å®Œæˆå¹¿æ’­åŒ…å« 15 ä¸ªæœç´¢å¼•ç”¨
```

## éªŒè¯æ­¥éª¤

### 1. åç«¯éªŒè¯

å¯åŠ¨åç«¯æœåŠ¡å¹¶è§‚å¯Ÿæ—¥å¿—ï¼š

```bash
python scripts/run_server.py
```

æäº¤æµ‹è¯•ä»»åŠ¡åï¼Œæ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦å‡ºç°ï¼š
- `ğŸ”§ [ToolCallRecorder] Tool START: tavily_search` (å·¥å…·è°ƒç”¨)
- `âœ… [ToolCallRecorder] Tool END: tavily_search` (å·¥å…·å®Œæˆ)
- `ğŸ” [v7.120] èŠ‚ç‚¹ xxx æ›´æ–°äº† N ä¸ªæœç´¢å¼•ç”¨` (æå–æˆåŠŸ)
- `ğŸ“š [v7.120] å®Œæˆå¹¿æ’­åŒ…å« N ä¸ªæœç´¢å¼•ç”¨` (å¹¿æ’­æˆåŠŸ)

### 2. å‰ç«¯éªŒè¯

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network â†’ WS (WebSocket)

æ£€æŸ¥ WebSocket æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«ï¼š

```json
{
  "type": "status_update",
  "status": "running",
  "progress": 0.7,
  "search_references": [
    {
      "source_tool": "tavily",
      "title": "...",
      "snippet": "...",
      // ...
    }
  ]
}
```

### 3. ç»„ä»¶éªŒè¯

å‰ç«¯åº”èƒ½æ­£å¸¸å±•ç¤ºæœç´¢å¼•ç”¨ï¼š

```tsx
// frontend-nextjs/components/SearchReferences.tsx
// åº”èƒ½æ¥æ”¶åˆ° searchReferences prop å¹¶æ¸²æŸ“æœç´¢å¼•ç”¨å¡ç‰‡
```

### 4. è§’è‰²éªŒè¯

**é‡è¦æç¤º**: ä½¿ç”¨ V3/V4/V5/V6 è§’è‰²æµ‹è¯•ï¼Œ**ä¸è¦ä½¿ç”¨ V2 è§’è‰²**ï¼ˆV2 ç¦ç”¨æ‰€æœ‰æœç´¢å·¥å…·ï¼‰

æ¨èè§’è‰²:
- **V4 (è®¾è®¡ç ”ç©¶å‘˜)** - æ‹¥æœ‰å…¨éƒ¨æœç´¢å·¥å…· âœ…
- **V6 (æ€»å·¥ç¨‹å¸ˆ)** - æ‹¥æœ‰å…¨éƒ¨æœç´¢å·¥å…· âœ…

## ç›¸å…³æ–‡ä»¶

### åç«¯æ–‡ä»¶
- `intelligent_project_analyzer/api/server.py` - WebSocket æ¨é€é€»è¾‘ (ä¿®æ”¹)
- `intelligent_project_analyzer/core/state.py` - search_references å­—æ®µå®šä¹‰
- `intelligent_project_analyzer/agents/tool_callback.py` - ToolCallRecorder
- `intelligent_project_analyzer/workflow/main_workflow.py` - è§’è‰²å·¥å…·æ˜ å°„

### å‰ç«¯æ–‡ä»¶
- `frontend-nextjs/types/index.ts` - SearchReference æ¥å£å®šä¹‰
- `frontend-nextjs/components/SearchReferences.tsx` - æœç´¢å¼•ç”¨å±•ç¤ºç»„ä»¶
- `frontend-nextjs/components/report/SearchReferencesDisplay.tsx` - æŠ¥å‘Šé¡µæœç´¢å¼•ç”¨

### è¯Šæ–­æ–‡ä»¶
- `SEARCH_TOOLS_DIAGNOSTIC_REPORT.md` - å®Œæ•´è¯Šæ–­æŠ¥å‘Š
- `scripts/diagnose_search_tools.py` - è‡ªåŠ¨åŒ–è¯Šæ–­è„šæœ¬
- `scripts/quick_check_tools.py` - å¿«é€Ÿè¿é€šæ€§æ£€æŸ¥

## å·²çŸ¥é™åˆ¶

### V2 è§’è‰²æ— æœç´¢åŠŸèƒ½

æ ¹æ® `main_workflow.py:2575`ï¼ŒV2ï¼ˆè®¾è®¡æ€»ç›‘ï¼‰è§’è‰²é»˜è®¤ç¦ç”¨æ‰€æœ‰æœç´¢å·¥å…·ï¼š

```python
role_tool_mapping = {
    "V2": [],  # è®¾è®¡æ€»ç›‘ï¼šç¦æ­¢å¤–éƒ¨æœç´¢
    "V3": ["bocha", "tavily", "ragflow"],
    "V4": ["bocha", "tavily", "arxiv", "ragflow"],  # å…¨éƒ¨å·¥å…·
    "V5": ["bocha", "tavily", "ragflow"],
    "V6": ["bocha", "tavily", "arxiv", "ragflow"],
}
```

**è§£é‡Š**: è¿™æ˜¯è®¾è®¡å†³ç­–ï¼Œè®¾è®¡æ€»ç›‘ä¾é å†…éƒ¨çŸ¥è¯†å’Œä¸“å®¶åä½œï¼Œä¸ç›´æ¥ä½¿ç”¨å¤–éƒ¨æœç´¢ã€‚

**æµ‹è¯•æ—¶åŠ¡å¿…ä½¿ç”¨ V3/V4/V5/V6 è§’è‰²ï¼**

## åç»­ä¼˜åŒ–å»ºè®®

1. **å‰ç«¯æç¤º**: å½“é€‰æ‹© V2 è§’è‰²æ—¶ï¼Œå‰ç«¯å¯æ˜¾ç¤ºæç¤ºï¼š"è®¾è®¡æ€»ç›‘è§’è‰²ä¸ä½¿ç”¨å¤–éƒ¨æœç´¢å·¥å…·"
2. **è´¨é‡è°ƒä¼˜**: æ ¹æ®å®é™…æœç´¢ç»“æœè°ƒæ•´ç›¸å…³æ€§é˜ˆå€¼ï¼ˆå½“å‰ 0.6ï¼‰
3. **æ€§èƒ½ä¼˜åŒ–**: è€ƒè™‘å¢é‡æ¨é€ search_referencesï¼Œé¿å…é‡å¤ä¼ è¾“
4. **å¯è§†åŒ–å¢å¼º**: åœ¨å‰ç«¯æ˜¾ç¤ºæ¯ä¸ªè§’è‰²çš„å·¥å…·æƒé™

## ä¿®å¤éªŒè¯æ¸…å•

- [ ] åç«¯æ—¥å¿—æ˜¾ç¤º "ğŸ” [v7.120] èŠ‚ç‚¹ xxx æ›´æ–°äº† N ä¸ªæœç´¢å¼•ç”¨"
- [ ] WebSocket æ¶ˆæ¯åŒ…å« `search_references` å­—æ®µ
- [ ] å‰ç«¯ SearchReferences ç»„ä»¶æ˜¾ç¤ºæœç´¢å¼•ç”¨å¡ç‰‡
- [ ] ä½¿ç”¨ V4 è§’è‰²æµ‹è¯•ï¼Œç¡®è®¤æœç´¢å·¥å…·è¢«è°ƒç”¨
- [ ] æŠ¥å‘Šé¡µé¢æ˜¾ç¤ºæœç´¢å¼•ç”¨åˆ—è¡¨

---

**ä¿®å¤å®Œæˆ**: âœ…
**æµ‹è¯•çŠ¶æ€**: å¾…éªŒè¯
**å½±å“èŒƒå›´**: å‰ç«¯æœç´¢å¼•ç”¨å±•ç¤ºåŠŸèƒ½
**é£é™©ç­‰çº§**: ä½ï¼ˆæ–°å¢å­—æ®µï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼‰
