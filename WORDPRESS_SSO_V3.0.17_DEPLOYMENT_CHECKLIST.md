# WordPress SSO v3.0.17 部署执行清单

**批准时间**: 2025-12-16
**执行方案**: 方案A - 部署v3.0.17修复版本
**部署状态**: ⏳ 等待执行

---

## 📦 准备就绪

✅ **插件文件**: `nextjs-sso-integration-v3.0.17.zip`
✅ **文件大小**: 18,199 字节
✅ **创建时间**: 2025-12-16 10:54
✅ **文件位置**: 项目根目录

---

## 🚀 部署步骤（严格按顺序执行）

### 第1步：访问WordPress后台（30秒）

1. 打开浏览器
2. 访问: `https://www.ucppt.com/wp-admin`
3. 使用管理员账号登录
4. 进入WordPress后台管理界面

---

### 第2步：停用旧版本插件（30秒）

1. 点击左侧菜单 **"插件"** → **"已安装的插件"**
2. 找到 **"Next.js SSO Integration v3"**
3. 确认版本号显示为 **v3.0.16** 或更早版本
4. 点击插件下方的 **"停用"** 链接
5. 等待页面刷新，确认插件状态变为"未启用"

**⚠️ 注意**: 停用插件不会影响现有的WordPress用户和数据

---

### 第3步：删除旧版本插件（30秒）

1. 在插件列表中，找到刚才停用的 **"Next.js SSO Integration v3"**
2. 插件状态应该是"未启用"
3. 点击插件下方的 **"删除"** 链接
4. 在确认对话框中点击 **"确定"**
5. 等待删除完成，插件应该从列表中消失

**⚠️ 注意**: 删除插件不会删除WordPress用户数据，只删除插件文件

---

### 第4步：上传新版本插件（1分钟）

1. 在WordPress后台，点击 **"插件"** → **"安装插件"**
2. 点击页面顶部的 **"上传插件"** 按钮
3. 点击 **"选择文件"** 按钮
4. 浏览到项目目录，选择: `nextjs-sso-integration-v3.0.17.zip`
5. 点击 **"立即安装"** 按钮
6. 等待上传和安装完成（约10-20秒）

**成功标志**:
- 看到"插件安装成功"的提示
- 显示"启用插件"按钮

**如果上传失败**:
- 检查文件大小限制（当前需要18KB，通常不会超限）
- 尝试通过FTP直接上传到 `/wp-content/plugins/` 目录

---

### 第5步：启用新版本插件（15秒）

1. 在安装成功页面，点击 **"启用插件"** 按钮
2. 等待页面跳转到插件列表
3. 确认 **"Next.js SSO Integration v3"** 显示为"已启用"
4. **关键检查**: 确认版本号显示为 **v3.0.17**

**成功标志**:
- 插件状态: "已启用"
- 版本号: "v3.0.17"
- 无错误提示

---

## ✅ 部署验证（按顺序执行）

### 验证1: WordPress REST API测试（1分钟）

**打开新浏览器标签，访问**:
```
https://www.ucppt.com/wp-json/nextjs-sso/v1/get-token
```

**预期结果A（未登录状态）**:
```json
{
  "success": false,
  "message": "未登录"
}
```

**预期结果B（已登录状态）**:
```json
{
  "success": true,
  "token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "user": {
    "username": "宋词",
    "email": "..."
  }
}
```

**关键检查**:
- ✅ HTTP状态码应该是 **200 OK**（不是401或404）
- ✅ 返回JSON格式数据
- ✅ 如果未登录，返回 `"success": false`
- ✅ 如果已登录，返回Token和用户信息

**如果仍然返回401**:
→ 跳转到"故障排除"部分

---

### 验证2: 检查WordPress调试日志（1分钟）

**步骤**:
1. 通过FTP或文件管理器访问WordPress安装目录
2. 打开文件: `/wp-content/debug.log`
3. 滚动到最底部（最新日志）
4. 搜索: `[Next.js SSO v3.0.17]`

**预期日志内容**:
```
[Next.js SSO v3.0.17] 🌐 REST API /get-token 端点被调用
[Next.js SSO v3.0.17] 📋 请求来源: http://localhost:3000
[Next.js SSO v3.0.17] 🔍 开始获取用户...
[Next.js SSO v3.0.17] 当前所有Cookies: wordpress_logged_in_..., wpcom_...
```

**成功标志**:
- ✅ 看到 `[Next.js SSO v3.0.17]` 日志
- ✅ 日志显示端点被调用
- ✅ 日志显示用户检测过程

**如果没有日志**:
- 检查 `wp-config.php` 中是否启用了 `WP_DEBUG_LOG`
- 检查 `debug.log` 文件权限是否可写

---

### 验证3: 完整登录流程测试（3分钟）

#### 测试场景A: 已登录用户自动进入应用

**步骤**:
1. 在浏览器中访问 `https://www.ucppt.com/account`
2. 确认已登录（显示用户名"宋词"）
3. **清除浏览器缓存** (重要！)
   - 按 `Ctrl + Shift + Delete`
   - 选择"Cookie和其他网站数据"
   - 点击"清除数据"
4. 访问 `http://localhost:3000`
5. 按 `F12` 打开开发者工具，查看控制台

**预期结果**:
```javascript
[AuthContext] 尝试通过 WordPress REST API 获取 Token...
[AuthContext] ✅ 通过 REST API 获取到 Token，验证中...
[AuthContext] ✅ REST API Token 验证成功，用户: {username: "宋词", ...}
[AuthContext] 🔀 检测到已登录，跳转到分析页面
```

**然后自动跳转到**: `http://localhost:3000/analysis` ✅

**用户体验**: 无需任何操作，直接进入应用主界面

---

#### 测试场景B: 未登录用户登录流程

**步骤**:
1. 打开**隐身窗口** (Ctrl + Shift + N)
2. 访问 `http://localhost:3000`
3. 应该看到"请先登录以使用应用"界面
4. 点击 **"立即登录"** 按钮
5. 在WPCOM登录页面输入账号密码，登录
6. 登录成功后，应该自动返回 `http://localhost:3000`

**预期结果**:
- 返回应用后，自动检测到登录状态
- 控制台显示Token验证成功的日志
- 自动跳转到 `http://localhost:3000/analysis` ✅

**用户体验**: 登录后无缝进入应用

---

## 📊 部署成功检查清单

### 必须全部通过 ✅

- [ ] WordPress插件列表显示 "Next.js SSO Integration v3" 版本 **v3.0.17**
- [ ] 插件状态为"已启用"
- [ ] REST API返回200状态码（不是401）
- [ ] debug.log中出现 `[Next.js SSO v3.0.17]` 日志
- [ ] 已登录用户访问应用自动跳转到 `/analysis`
- [ ] 未登录用户可以正常登录并进入应用
- [ ] 浏览器控制台无致命错误（401错误应该消失）

### 如果以上全部通过 → 🎉 部署成功！

---

## 🔧 故障排除

### 问题1: REST API仍然返回401

**可能原因**:
1. 插件未正确启用
2. 上传的是错误版本的文件
3. WordPress缓存未清除

**解决步骤**:
1. 确认WordPress插件列表中版本号是 **v3.0.17**
2. 停用插件 → 重新启用
3. 清除WordPress缓存（如果使用了缓存插件）
4. 访问 `https://www.ucppt.com/wp-json/` 确认REST API可访问

---

### 问题2: debug.log没有v3.0.17日志

**可能原因**:
1. WordPress调试未启用
2. debug.log文件权限问题
3. 插件代码仍然未执行

**解决步骤**:
1. 检查 `wp-config.php` 中的调试配置:
   ```php
   define('WP_DEBUG', true);
   define('WP_DEBUG_LOG', true);
   define('WP_DEBUG_DISPLAY', false);
   ```
2. 检查 `/wp-content/debug.log` 文件权限（应该可写）
3. 手动访问REST API端点触发日志

---

### 问题3: 登录后仍然显示登录界面

**可能原因**:
1. 浏览器缓存未清除
2. Next.js服务未重启（使用了旧代码）
3. REST API仍然返回401

**解决步骤**:
1. 清除浏览器所有数据（包括Cookie）
2. 重启Next.js开发服务器
3. 验证REST API是否返回200
4. 检查浏览器控制台的完整错误信息

---

## 📞 紧急支持

如果遇到以上步骤无法解决的问题，请提供以下信息：

1. **WordPress插件版本截图** （确认是v3.0.17）
2. **REST API响应** （访问get-token端点的完整响应）
3. **debug.log内容** （最后50行，包含所有v3.0.17日志）
4. **浏览器控制台截图** （访问localhost:3000时的所有日志）
5. **错误信息** （任何红色错误提示）

---

## 🎯 预期修复效果

### 修复前（v3.0.16）:
- ❌ REST API返回401
- ❌ debug.log无日志
- ❌ 已登录用户无法进入应用
- ❌ 登录后陷入循环

### 修复后（v3.0.17）:
- ✅ REST API返回200
- ✅ debug.log显示详细日志
- ✅ 已登录用户自动进入应用
- ✅ 未登录用户正常登录流程
- ✅ 完全支持WPCOM Member Pro

---

## 📝 部署记录

### 部署信息

- **部署时间**: ___________ (填写实际部署时间)
- **执行人**: ___________
- **WordPress版本**: ___________
- **PHP版本**: ___________
- **旧版本**: v3.0.16
- **新版本**: v3.0.17

### 验证结果

- [ ] 验证1 - REST API测试: ⬜ 通过 / ⬜ 失败
- [ ] 验证2 - debug.log检查: ⬜ 通过 / ⬜ 失败
- [ ] 验证3A - 已登录用户: ⬜ 通过 / ⬜ 失败
- [ ] 验证3B - 未登录用户: ⬜ 通过 / ⬜ 失败

### 部署状态

- [ ] ✅ 部署成功
- [ ] ⚠️ 部署完成但有问题（需要进一步调试）
- [ ] ❌ 部署失败（需要回滚）

---

**创建时间**: 2025-12-16
**文档版本**: 1.0
**执行方案**: 方案A - 部署v3.0.17
**批准人**: 用户
**状态**: ⏳ 等待执行
