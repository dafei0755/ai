# Promtail 配置文件
# 日志采集器配置

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # 采集主日志
  - job_name: server
    static_configs:
      - targets:
          - localhost
        labels:
          job: intelligent_project_analyzer
          app: backend
          log_type: server
          __path__: /var/log/app/server.log
    pipeline_stages:
      - multiline:
          firstline: '^\d{4}-\d{2}-\d{2}'  # 日志行起始标记
      - regex:
          expression: '^(?P<timestamp>\S+ \S+) \| (?P<level>\S+)\s+\| (?P<module>\S+):(?P<function>\S+):(?P<line>\d+) - (?P<message>.*)$'
      - labels:
          level:
          module:
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05.000'

  # 采集认证日志
  - job_name: auth
    static_configs:
      - targets:
          - localhost
        labels:
          job: intelligent_project_analyzer
          app: backend
          log_type: auth
          __path__: /var/log/app/auth.log
    pipeline_stages:
      - multiline:
          firstline: '^\d{4}-\d{2}-\d{2}'
      - regex:
          expression: '^(?P<timestamp>\S+ \S+) \| (?P<level>\S+)\s+\| (?P<module>\S+):(?P<function>\S+):(?P<line>\d+) - (?P<message>.*)$'
      - labels:
          level:
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05.000'

  # 采集错误日志
  - job_name: errors
    static_configs:
      - targets:
          - localhost
        labels:
          job: intelligent_project_analyzer
          app: backend
          log_type: errors
          severity: error
          __path__: /var/log/app/errors.log
    pipeline_stages:
      - multiline:
          firstline: '^\d{4}-\d{2}-\d{2}'
      - regex:
          expression: '^(?P<timestamp>\S+ \S+) \| (?P<level>\S+)\s+\| (?P<module>\S+):(?P<function>\S+):(?P<line>\d+) - (?P<message>.*)$'
      - labels:
          level:
          module:
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05.000'

  # 采集性能指标日志
  - job_name: performance
    static_configs:
      - targets:
          - localhost
        labels:
          job: intelligent_project_analyzer
          app: backend
          log_type: performance
          __path__: /var/log/app/performance_metrics.jsonl
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            path: path
            method: method
            duration: duration
            status_code: status_code
      - labels:
          path:
          method:
      - timestamp:
          source: timestamp
          format: RFC3339

  # 采集 LLM 性能指标
  - job_name: llm_metrics
    static_configs:
      - targets:
          - localhost
        labels:
          job: intelligent_project_analyzer
          app: backend
          log_type: llm_metrics
          __path__: /var/log/app/llm_metrics.jsonl
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            model: model
            operation: operation
            duration: duration
            tokens: tokens
            success: success
      - labels:
          model:
          operation:
      - timestamp:
          source: timestamp
          format: RFC3339

  # 采集告警日志
  - job_name: alerts
    static_configs:
      - targets:
          - localhost
        labels:
          job: intelligent_project_analyzer
          app: backend
          log_type: alerts
          severity: critical
          __path__: /var/log/app/alerts.log
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            message: message
            error_detail: error_detail
      - labels:
          message:
      - timestamp:
          source: timestamp
          format: RFC3339
