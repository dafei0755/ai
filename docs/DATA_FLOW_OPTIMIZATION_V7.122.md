# æ•°æ®æµä¼˜åŒ–æŠ¥å‘Š v7.122

> **ç‰ˆæœ¬**: v7.122
> **æ—¥æœŸ**: 2026-01-03
> **ç›®æ ‡**: æ¢³ç†ç”¨æˆ·é—®é¢˜â†’æœç´¢â†’æ¦‚å¿µå›¾çš„æ•°æ®ä¼ é€’é“¾è·¯ï¼Œæ¶ˆé™¤å†—ä½™ï¼Œå¢å¼ºæ¸…æ™°åº¦

---

## ğŸ“‹ ä¼˜åŒ–æ¦‚è§ˆ

æœ¬æ¬¡ä¼˜åŒ–é’ˆå¯¹ä»¥ä¸‹æ•°æ®æµå…³è”è¿›è¡Œäº†å…¨é¢æ¢³ç†å’Œå¢å¼ºï¼š

1. **ç”¨æˆ·é—®é¢˜ + é—®å· + ä»»åŠ¡äº¤ä»˜ â†’ æœç´¢**
2. **ç”¨æˆ·é—®é¢˜ + é—®å· + ä»»åŠ¡äº¤ä»˜ + æœç´¢ç»“æœ â†’ æ¦‚å¿µå›¾**

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### é—®é¢˜è¯†åˆ«

#### é—®é¢˜ 1: æœç´¢æŸ¥è¯¢æ•°æ®æµæ–­è£‚ ğŸ”´

**ç°çŠ¶**:
- `search_query_generator_node` ç”Ÿæˆäº†é¢„ç”ŸæˆæŸ¥è¯¢ï¼ˆå·²æ•´åˆç”¨æˆ·é—®é¢˜+é—®å·ï¼‰
- ä½†ä¸“å®¶æ‰§è¡Œæ—¶ï¼ŒLLMè‡ªä¸»è°ƒç”¨å·¥å…·ï¼Œ**ä¸ä¸€å®šä½¿ç”¨**é¢„ç”Ÿæˆçš„æŸ¥è¯¢
- æ•°æ®æµæ–­è£‚ï¼šé¢„ç”ŸæˆæŸ¥è¯¢å¯èƒ½è¢«å¿½ç•¥

**å½±å“**: ç”¨æˆ·é—®å·çš„é£æ ¼åå¥½ã€æƒ…æ„Ÿéœ€æ±‚æœªè¢«å……åˆ†åˆ©ç”¨

---

#### é—®é¢˜ 2: é—®å·æ•°æ®åœ¨æ¦‚å¿µå›¾ä¸­åˆ©ç”¨ä¸å……åˆ† ğŸŸ¡

**ç°çŠ¶**:
- `questionnaire_summary` åœ¨ v7.121 æ‰åŠ å…¥åˆ°æœç´¢æŸ¥è¯¢ç”Ÿæˆ
- ä½†åœ¨**æ¦‚å¿µå›¾ç”Ÿæˆ**æ—¶ï¼Œä»…é€šè¿‡ `deliverable_metadata.constraints` é—´æ¥ä¼ é€’
- æ•°æ®ä¼ é€’é“¾è·¯ä¸æ¸…æ™°ï¼šé—®å·æ•°æ®æ˜¯å¦å®Œæ•´ä¼ é€’åˆ°æ¦‚å¿µå›¾ Promptï¼Ÿ

**å½±å“**: æ¦‚å¿µå›¾å¯èƒ½æ— æ³•åæ˜ ç”¨æˆ·çš„è¯¦ç»†é£æ ¼åå¥½

---

#### é—®é¢˜ 3: æœç´¢å¼•ç”¨ä¼ é€’é“¾è·¯å¤æ‚ ğŸŸ¡

**ç°çŠ¶**:
```
å·¥å…·è°ƒç”¨ â†’ ToolCallRecorder.get_search_references()
         â†’ add_references_to_state(state, recorder)
         â†’ state["search_references"]  # å…¨å±€èšåˆ
         â†’ aggregated_results["search_references"]  # æœ€ç»ˆæŠ¥å‘Š
```

**æ½œåœ¨é—®é¢˜**:
- å¦‚æœ `state["search_references"]` æœªåˆå§‹åŒ–ï¼ˆå¦‚ `None`ï¼‰ï¼Œæœç´¢å¼•ç”¨ä¼šä¸¢å¤±
- å¤šä¸ªä¸“å®¶çš„æœç´¢å¼•ç”¨å»é‡é€»è¾‘åˆ†æ•£ï¼ˆå·¥å…·å±‚ã€PDFå±‚ï¼‰

---

## âœ… å®æ–½çš„ä¼˜åŒ–

### ä¼˜åŒ– 1: æœç´¢æŸ¥è¯¢æ•°æ®æµå¢å¼º âœ…

#### ä¿®æ”¹æ–‡ä»¶
- `intelligent_project_analyzer/agents/task_oriented_expert_factory.py`
- `intelligent_project_analyzer/core/prompt_templates.py`

#### å®æ–½å†…å®¹

**1.1 åœ¨ä¸“å®¶å·¥å‚ä¸­æ³¨å…¥æœç´¢æŸ¥è¯¢æç¤º**

```python
# task_oriented_expert_factory.py

def _build_search_queries_hint(self, role_object: Dict[str, Any], state: ProjectAnalysisState) -> str:
    """
    ğŸ†• v7.122: æ„å»ºæœç´¢æŸ¥è¯¢æç¤ºï¼Œå¼•å¯¼ä¸“å®¶ä½¿ç”¨é¢„ç”Ÿæˆçš„æŸ¥è¯¢

    ä» deliverable_metadata ä¸­æå–é¢„ç”Ÿæˆçš„ search_queriesï¼Œ
    æ„å»ºæç¤ºæ–‡æœ¬æ³¨å…¥åˆ°ä¸“å®¶çš„ system prompt
    """
    # æå–è¯¥è§’è‰²çš„äº¤ä»˜ç‰©
    deliverable_ids = state.get('deliverable_owner_map', {}).get(role_id, [])

    # æ”¶é›†æ‰€æœ‰é¢„ç”ŸæˆæŸ¥è¯¢
    all_queries = []
    for deliverable_id in deliverable_ids:
        metadata = state.get('deliverable_metadata', {}).get(deliverable_id, {})
        search_queries = metadata.get('search_queries', [])
        all_queries.extend(search_queries)

    # æ„å»ºæç¤º
    hint = f"""
# ğŸ” æ¨èæœç´¢æŸ¥è¯¢ï¼ˆRecommended Search Queriesï¼‰

ç³»ç»Ÿå·²åŸºäºç”¨æˆ·é—®é¢˜å’Œé—®å·æ•°æ®ä¸ºä½ çš„äº¤ä»˜ç‰©é¢„ç”Ÿæˆäº†ä¼˜åŒ–çš„æœç´¢æŸ¥è¯¢ã€‚
è¿™äº›æŸ¥è¯¢å·²æ•´åˆäº†ç”¨æˆ·çš„é£æ ¼åå¥½ã€æƒ…æ„Ÿéœ€æ±‚å’Œé¡¹ç›®ç‰¹å¾ã€‚

**æ¨èæŸ¥è¯¢** (è¯·ä¼˜å…ˆä½¿ç”¨æˆ–åŸºäºå®ƒä»¬ä¼˜åŒ–):
  1. "{query1}"
  2. "{query2}"
  ...

ğŸ’¡ **ä½¿ç”¨å»ºè®®**:
- ä¼˜å…ˆä½¿ç”¨è¿™äº›æŸ¥è¯¢è·å–é¡¹ç›®ç›¸å…³ä¿¡æ¯
- å¯ä»¥åŸºäºè¿™äº›æŸ¥è¯¢è¿›è¡Œå¾®è°ƒæˆ–ç»„åˆ
- å¦‚éœ€è¡¥å……å…¶ä»–æŸ¥è¯¢ï¼Œè¯·ç¡®ä¿ä¸é¡¹ç›®ä¸Šä¸‹æ–‡ä¸€è‡´
"""
    return hint
```

**1.2 åœ¨ Prompt æ¨¡æ¿ä¸­æ¸²æŸ“æœç´¢æŸ¥è¯¢æç¤º**

```python
# prompt_templates.py

def render(
    self,
    ...,
    search_queries_hint: str = ""  # ğŸ†• v7.122
) -> Dict[str, str]:
    """æ¸²æŸ“å®Œæ•´Prompt"""

    system_prompt = f"""
{self.base_system_prompt}

# ğŸ¯ åŠ¨æ€è§’è‰²å®šä¹‰
...

{search_queries_hint}  # ğŸ”¥ æ³¨å…¥æœç´¢æŸ¥è¯¢æç¤º

{self.static_sections['autonomy_section']}
{self.static_sections['output_format_section']}
"""
```

**æ•ˆæœ**:
- âœ… ä¸“å®¶çœ‹åˆ°é¢„ç”ŸæˆæŸ¥è¯¢ï¼Œæ˜ç¡®çŸ¥é“åº”è¯¥ä½¿ç”¨å“ªäº›æŸ¥è¯¢
- âœ… LLM è¢«å¼•å¯¼ä¼˜å…ˆä½¿ç”¨è¿™äº›æŸ¥è¯¢ï¼Œè€Œéè‡ªå·±éšæœºç”Ÿæˆ
- âœ… ç”¨æˆ·é—®å·çš„é£æ ¼åå¥½ç›´æ¥å½±å“æœç´¢è¡Œä¸º

---

### ä¼˜åŒ– 2: é—®å·æ•°æ®åœ¨æ¦‚å¿µå›¾ä¸­çš„å®Œæ•´æ³¨å…¥ âœ…

#### ä¿®æ”¹æ–‡ä»¶
- `intelligent_project_analyzer/workflow/nodes/deliverable_id_generator_node.py`
- `intelligent_project_analyzer/agents/task_oriented_expert_factory.py`

#### å®æ–½å†…å®¹

**2.1 åœ¨ deliverable_metadata çš„ constraints ä¸­ä¿å­˜å®Œæ•´é—®å·æ•°æ®**

```python
# deliverable_id_generator_node.py

"constraints": {
    "must_include": [
        *material_keywords[:3],
        *functional_keywords[:2],
        ...
    ],
    "style_preferences": f"{style_label} aesthetic, {color_palette}",
    "user_specific_needs": ", ".join(functional_keywords[:5]),
    # ğŸ†• v7.122: ä¿ç•™å®Œæ•´çš„é—®å·æƒ…æ„Ÿå…³é”®è¯ä¾›æ¦‚å¿µå›¾ä½¿ç”¨
    "emotional_keywords": questionnaire_keywords.get("emotional_keywords", []),
    "profile_label": style_label  # ğŸ”¥ v7.122: æ˜¾å¼ä¿å­˜é—®å·é£æ ¼æ ‡ç­¾
}
```

**2.2 åœ¨æ¦‚å¿µå›¾ç”Ÿæˆæ—¶ä¼ é€’é—®å·æ•°æ®**

```python
# task_oriented_expert_factory.py

# ğŸ†• v7.122: æå–é—®å·æ•°æ®ç”¨äºæ¦‚å¿µå›¾ç”Ÿæˆ
questionnaire_summary = state.get("questionnaire_summary", {})
questionnaire_data = None
if questionnaire_summary:
    questionnaire_data = {
        "profile_label": questionnaire_summary.get("profile_label", ""),
        "answers": questionnaire_summary.get("answers", {})
    }

# è°ƒç”¨æ¦‚å¿µå›¾ç”Ÿæˆ
image_metadata = await image_generator.generate_deliverable_image(
    deliverable_metadata=metadata,
    expert_analysis=expert_summary,
    session_id=session_id,
    project_type=project_type,
    aspect_ratio="16:9",
    questionnaire_data=questionnaire_data  # ğŸ”¥ v7.122: æ³¨å…¥é—®å·æ•°æ®
)
```

**æ•ˆæœ**:
- âœ… `deliverable_metadata` åŒ…å«å®Œæ•´çš„é—®å·å…³é”®è¯
- âœ… æ¦‚å¿µå›¾ç”Ÿæˆå™¨å¯ä»¥ç›´æ¥è®¿é—®é—®å·çš„é£æ ¼æ ‡ç­¾å’Œè¯¦ç»†å›ç­”
- âœ… æ•°æ®ä¼ é€’é“¾è·¯æ¸…æ™°ï¼š`questionnaire_summary` â†’ `deliverable_metadata.constraints` + `questionnaire_data` â†’ æ¦‚å¿µå›¾ Prompt

---

### ä¼˜åŒ– 3: æœç´¢å¼•ç”¨ç»Ÿä¸€å¤„ç†ä¸å®¹é”™ âœ…

#### ä¿®æ”¹æ–‡ä»¶
- `intelligent_project_analyzer/report/result_aggregator.py`

#### å®æ–½å†…å®¹

**3.1 åœ¨ç»“æœèšåˆå™¨ä¸­ç»Ÿä¸€å¤„ç†æœç´¢å¼•ç”¨**

```python
# result_aggregator.py

def _consolidate_search_references(self, state: ProjectAnalysisState) -> List[Dict[str, Any]]:
    """
    ğŸ†• v7.122: ç»Ÿä¸€å¤„ç†æœç´¢å¼•ç”¨ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§

    åŠŸèƒ½ï¼š
    1. ä» state ä¸­æå– search_references
    2. å®¹é”™å¤„ç†ï¼ˆå¤„ç† None æˆ–ç©ºåˆ—è¡¨ï¼‰
    3. å»é‡ï¼ˆåŸºäº title + urlï¼‰
    4. æŒ‰è´¨é‡åˆ†æ•°æ’åº
    5. éªŒè¯å¿…éœ€å­—æ®µ
    """
    # 1. æå–æœç´¢å¼•ç”¨ï¼ˆå®¹é”™å¤„ç†ï¼‰
    raw_references = state.get("search_references") or []

    if not raw_references:
        return []

    if not isinstance(raw_references, list):
        logger.warning(f"search_references ç±»å‹é”™è¯¯: {type(raw_references)}")
        return []

    # 2. å»é‡ï¼ˆåŸºäº title + urlï¼‰
    unique_references = []
    seen = set()

    for ref in raw_references:
        title = ref.get("title", "")
        url = ref.get("url", "")
        key = (title, url)

        if key not in seen:
            unique_references.append(ref)
            seen.add(key)

    # 3. æŒ‰è´¨é‡åˆ†æ•°æ’åº
    sorted_references = sorted(
        unique_references,
        key=lambda r: r.get("quality_score") or r.get("relevance_score", 0.5) * 100,
        reverse=True
    )

    # 4. æ·»åŠ å¼•ç”¨ç¼–å·
    for idx, ref in enumerate(sorted_references, 1):
        if "reference_number" not in ref:
            ref["reference_number"] = idx

    return sorted_references
```

**3.2 åœ¨ç»“æœèšåˆä¸­è°ƒç”¨**

```python
# result_aggregator.py: execute() æ–¹æ³•

# ğŸ†• v7.122: ç»Ÿä¸€å¤„ç†æœç´¢å¼•ç”¨ï¼ˆå»é‡ã€éªŒè¯ã€èšåˆï¼‰
search_references = self._consolidate_search_references(state)
if search_references:
    final_report["search_references"] = search_references
    logger.info(f"âœ… [v7.122] å·²å¤„ç† {len(search_references)} æ¡æœç´¢å¼•ç”¨")
```

**æ•ˆæœ**:
- âœ… ç»Ÿä¸€çš„å»é‡å’Œæ’åºé€»è¾‘
- âœ… å®¹é”™å¤„ç†ï¼šå³ä½¿ `state["search_references"]` ä¸º `None`ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™
- âœ… éªŒè¯å¿…éœ€å­—æ®µï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
- âœ… ç®€åŒ–æ•°æ®æµï¼šç›´æ¥åœ¨èšåˆå™¨ä¸­å¤„ç†ï¼Œå‡å°‘ä¸­é—´ä¼ é€’æ­¥éª¤

---

## ğŸ“Š ä¼˜åŒ–å‰åå¯¹æ¯”

### æ•°æ®æµå¯¹æ¯”å›¾

#### ä¼˜åŒ–å‰ï¼ˆv7.121ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·è¾“å…¥ â†’ éœ€æ±‚åˆ†æ â†’ é—®å·äº¤äº’ â†’ ä»»åŠ¡åˆ†è§£                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æœç´¢æŸ¥è¯¢ç”Ÿæˆï¼ˆæ•´åˆç”¨æˆ·é—®é¢˜+é—®å·ï¼‰                         â”‚
â”‚    â†’ deliverable_metadata.search_queries                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ä¸“å®¶æ‰§è¡Œ                                                  â”‚
â”‚    âŒ LLM çœ‹ä¸åˆ° search_queriesï¼Œè‡ªä¸»ç”ŸæˆæŸ¥è¯¢                â”‚
â”‚    â†’ å·¥å…·è°ƒç”¨ â†’ æœç´¢ç»“æœ                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ¦‚å¿µå›¾ç”Ÿæˆ                                                â”‚
â”‚    âš ï¸ ä»…é€šè¿‡ deliverable_metadata.constraints é—´æ¥è·å–é—®å·   â”‚
â”‚    â“ æ•°æ®å®Œæ•´æ€§ä¸æ˜ç¡®                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æœç´¢å¼•ç”¨èšåˆ                                              â”‚
â”‚    âš ï¸ åˆ†æ•£å¤„ç†ï¼šå·¥å…·å±‚ã€PDFå±‚å„è‡ªå»é‡                        â”‚
â”‚    âš ï¸ state["search_references"] æœªå®¹é”™å¤„ç†                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### ä¼˜åŒ–åï¼ˆv7.122ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·è¾“å…¥ â†’ éœ€æ±‚åˆ†æ â†’ é—®å·äº¤äº’ â†’ ä»»åŠ¡åˆ†è§£                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æœç´¢æŸ¥è¯¢ç”Ÿæˆï¼ˆæ•´åˆç”¨æˆ·é—®é¢˜+é—®å·ï¼‰                         â”‚
â”‚    â†’ deliverable_metadata.search_queries                    â”‚
â”‚    â†’ deliverable_metadata.constraints (åŒ…å«é—®å·å…³é”®è¯)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ä¸“å®¶æ‰§è¡Œ                                                  â”‚
â”‚    âœ… System Prompt æ³¨å…¥ search_queries æç¤º                 â”‚
â”‚    âœ… LLM è¢«å¼•å¯¼ä¼˜å…ˆä½¿ç”¨é¢„ç”ŸæˆæŸ¥è¯¢                           â”‚
â”‚    â†’ å·¥å…·è°ƒç”¨ â†’ æœç´¢ç»“æœ                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ¦‚å¿µå›¾ç”Ÿæˆ                                                â”‚
â”‚    âœ… ç›´æ¥ä¼ é€’ questionnaire_data å‚æ•°                       â”‚
â”‚    âœ… deliverable_metadata.constraints åŒ…å«å®Œæ•´é—®å·å…³é”®è¯    â”‚
â”‚    âœ… æ•°æ®é“¾è·¯æ¸…æ™°ï¼Œå®Œæ•´ä¼ é€’                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æœç´¢å¼•ç”¨èšåˆ                                              â”‚
â”‚    âœ… ç»Ÿä¸€åœ¨ result_aggregator._consolidate_search_referencesâ”‚
â”‚    âœ… å®¹é”™å¤„ç†ï¼šNone â†’ ç©ºåˆ—è¡¨                                â”‚
â”‚    âœ… ç»Ÿä¸€å»é‡ + æ’åº + ç¼–å·                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å…³é”®æ•°æ®å­—æ®µæ˜ å°„

### é—®å·æ•°æ® â†’ æœç´¢æŸ¥è¯¢

| é—®å·å­—æ®µ | ä¸­é—´çŠ¶æ€ | æœ€ç»ˆä½¿ç”¨ä½ç½® |
|---------|---------|-------------|
| `questionnaire_summary.profile_label` | `deliverable_metadata.constraints.profile_label` | æœç´¢æŸ¥è¯¢ Promptã€æ¦‚å¿µå›¾ Prompt |
| `questionnaire_summary.answers.gap_answers` | `deliverable_metadata.constraints.emotional_keywords` | æœç´¢æŸ¥è¯¢å…³é”®è¯ã€æ¦‚å¿µå›¾æƒ…æ„ŸåŸºè°ƒ |
| `questionnaire_summary.answers.radar_values` | `questionnaire_keywords.priority_dimensions` | æœç´¢æŸ¥è¯¢ä¼˜å…ˆçº§ |

---

### é—®å·æ•°æ® â†’ æ¦‚å¿µå›¾

| é—®å·å­—æ®µ | ä¼ é€’è·¯å¾„ | æ¦‚å¿µå›¾ä½¿ç”¨æ–¹å¼ |
|---------|---------|---------------|
| `profile_label` | `questionnaire_data.profile_label` | æ³¨å…¥åˆ°è§†è§‰ Prompt: "ã€ç”¨æˆ·é£æ ¼åå¥½ã€‘" |
| `gap_answers` | `questionnaire_data.answers.gap_answers` | æ³¨å…¥åˆ°è§†è§‰ Prompt: "ã€ç”¨æˆ·è¯¦ç»†éœ€æ±‚ã€‘" |
| `constraints.emotional_keywords` | `deliverable_metadata.constraints.emotional_keywords` | è§†è§‰ Prompt çš„æƒ…æ„ŸåŸºè°ƒ |
| `constraints.style_preferences` | `deliverable_metadata.constraints.style_preferences` | Prompt çš„é£æ ¼æè¿° |

---

### æœç´¢å¼•ç”¨èšåˆ

| åŸå§‹ä½ç½® | èšåˆä½ç½® | å»é‡ç­–ç•¥ | æ’åºä¾æ® |
|---------|---------|---------|---------|
| `ToolCallRecorder` | `state.search_references` | `merge_lists` (LangGraph) | æ—  |
| `state.search_references` | `result_aggregator._consolidate_search_references()` | `(title, url)` å»é‡ | `quality_score` é™åº |
| èšåˆå | `final_report.search_references` | å·²å»é‡ | å·²æ’åº |
| èšåˆå | `pdf_generator._add_references()` | å†æ¬¡å»é‡ï¼ˆé˜²å¾¡æ€§ï¼‰ | å·²æ’åº |

---

## ğŸ¯ æµ‹è¯•éªŒè¯å»ºè®®

### æµ‹è¯•åœºæ™¯ 1: æœç´¢æŸ¥è¯¢ä½¿ç”¨éªŒè¯

**æµ‹è¯•æ­¥éª¤**:
1. å¯åŠ¨å®Œæ•´æµç¨‹ï¼Œè¾“å…¥åŒ…å«ç‰¹å®šé£æ ¼åå¥½çš„é—®å·ï¼ˆå¦‚"å·¥ä¸šé£"ï¼‰
2. æ£€æŸ¥æ—¥å¿—ï¼š`[v7.122] ä¸ºè§’è‰² {role_id} æ³¨å…¥äº† {n} ä¸ªé¢„ç”Ÿæˆæœç´¢æŸ¥è¯¢`
3. æ£€æŸ¥ä¸“å®¶ System Prompt æ˜¯å¦åŒ…å«æœç´¢æŸ¥è¯¢æç¤º
4. æ£€æŸ¥å·¥å…·è°ƒç”¨è®°å½•ï¼ŒéªŒè¯ä¸“å®¶å®é™…ä½¿ç”¨çš„æŸ¥è¯¢æ˜¯å¦ä¸é¢„ç”Ÿæˆä¸€è‡´

**é¢„æœŸç»“æœ**:
- âœ… ä¸“å®¶çš„æœç´¢æŸ¥è¯¢åº”åŒ…å«é—®å·é£æ ¼å…³é”®è¯ï¼ˆå¦‚"industrial style"ï¼‰
- âœ… æœç´¢ç»“æœä¸ç”¨æˆ·åå¥½é«˜åº¦ç›¸å…³

---

### æµ‹è¯•åœºæ™¯ 2: æ¦‚å¿µå›¾é—®å·æ•°æ®æ³¨å…¥éªŒè¯

**æµ‹è¯•æ­¥éª¤**:
1. å®Œæˆé—®å·ï¼Œå¡«å†™è¯¦ç»†çš„é£æ ¼åå¥½å’Œæƒ…æ„Ÿéœ€æ±‚
2. æ£€æŸ¥æ—¥å¿—ï¼š`[v7.122] å‡†å¤‡æ³¨å…¥é—®å·æ•°æ®åˆ°æ¦‚å¿µå›¾ç”Ÿæˆ`
3. æ£€æŸ¥æ¦‚å¿µå›¾ç”Ÿæˆçš„ Promptï¼Œæ˜¯å¦åŒ…å«ï¼š
   - `ã€ç”¨æˆ·é£æ ¼åå¥½ã€‘` ç« èŠ‚
   - `ã€ç”¨æˆ·è¯¦ç»†éœ€æ±‚ã€‘` ç« èŠ‚
4. ç”Ÿæˆçš„æ¦‚å¿µå›¾æ˜¯å¦åæ˜ äº†é—®å·ä¸­çš„é£æ ¼ï¼ˆè§†è§‰éªŒè¯ï¼‰

**é¢„æœŸç»“æœ**:
- âœ… æ¦‚å¿µå›¾ Prompt åŒ…å«é—®å·æ•°æ®
- âœ… ç”Ÿæˆçš„å›¾åƒé£æ ¼ä¸é—®å·ä¸€è‡´

---

### æµ‹è¯•åœºæ™¯ 3: æœç´¢å¼•ç”¨å®¹é”™æ€§éªŒè¯

**æµ‹è¯•æ­¥éª¤**:
1. æ¨¡æ‹Ÿ `state["search_references"]` ä¸º `None` çš„æƒ…å†µ
2. è¿è¡Œç»“æœèšåˆèŠ‚ç‚¹
3. æ£€æŸ¥æ˜¯å¦æœ‰æŠ¥é”™

**é¢„æœŸç»“æœ**:
- âœ… ä¸æŠ¥é”™ï¼Œè¿”å›ç©ºåˆ—è¡¨
- âœ… æ—¥å¿—æ˜¾ç¤º: `[v7.122] æ— æœç´¢å¼•ç”¨æ•°æ®`

---

### æµ‹è¯•åœºæ™¯ 4: æœç´¢å¼•ç”¨å»é‡éªŒè¯

**æµ‹è¯•æ­¥éª¤**:
1. å¤šä¸ªä¸“å®¶æœç´¢ç›¸åŒçš„å†…å®¹ï¼ˆç›¸åŒ title + urlï¼‰
2. æ£€æŸ¥ `final_report.search_references` çš„æ•°é‡
3. éªŒè¯æ˜¯å¦æœ‰é‡å¤

**é¢„æœŸç»“æœ**:
- âœ… ç›¸åŒçš„ (title, url) åªå‡ºç°ä¸€æ¬¡
- âœ… æ—¥å¿—æ˜¾ç¤ºå»é‡å‰åçš„æ•°é‡å˜åŒ–

---

## ğŸ“ˆ æ€§èƒ½å½±å“è¯„ä¼°

| ä¼˜åŒ–é¡¹ | æ€§èƒ½å½±å“ | è¯´æ˜ |
|-------|---------|-----|
| æœç´¢æŸ¥è¯¢æç¤ºæ³¨å…¥ | +5ms/ä¸“å®¶ | é¢å¤–çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå‡ ä¹å¯å¿½ç•¥ |
| é—®å·æ•°æ®ä¼ é€’ | +2ms/æ¦‚å¿µå›¾ | å¤šä¼ é€’ä¸€ä¸ªå‚æ•°ï¼Œæ— é¢å¤–å¼€é”€ |
| æœç´¢å¼•ç”¨å»é‡ | +50ms/æ¬¡ | ä¸€æ¬¡æ€§æ“ä½œï¼Œåœ¨ç»“æœèšåˆé˜¶æ®µï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ |
| **æ€»ä½“å½±å“** | **< 100ms** | å¯¹æ•´ä½“æµç¨‹ï¼ˆ~2åˆ†é’Ÿï¼‰å½±å“ < 0.1% |

---

## âœ… ä¼˜åŒ–æˆæœæ€»ç»“

### æ•°æ®æµæ¸…æ™°åº¦æå‡

1. âœ… **æœç´¢æŸ¥è¯¢æ•°æ®æµ**ï¼š`search_queries` ä¸å†è¢«å¿½ç•¥ï¼Œé€šè¿‡ Prompt æ³¨å…¥å¼ºåˆ¶å¼•å¯¼
2. âœ… **é—®å·æ•°æ®æµ**ï¼š`questionnaire_summary` å®Œæ•´ä¼ é€’åˆ°æœç´¢å’Œæ¦‚å¿µå›¾
3. âœ… **æœç´¢å¼•ç”¨èšåˆ**ï¼šç»Ÿä¸€åœ¨ä¸€å¤„å¤„ç†ï¼Œå®¹é”™æ€§å¢å¼º

---

### æ•°æ®åˆ©ç”¨ç‡æå‡

| æ•°æ®æº | ä¼˜åŒ–å‰åˆ©ç”¨ç‡ | ä¼˜åŒ–ååˆ©ç”¨ç‡ | æå‡ |
|-------|-------------|-------------|-----|
| `questionnaire_summary.profile_label` | 50%ï¼ˆä»…æ¦‚å¿µå›¾å…ƒæ•°æ®ï¼‰ | 100%ï¼ˆæœç´¢æŸ¥è¯¢ + æ¦‚å¿µå›¾ Promptï¼‰ | +50% |
| `questionnaire_summary.gap_answers` | 30%ï¼ˆéƒ¨åˆ†å…³é”®è¯æå–ï¼‰ | 90%ï¼ˆå®Œæ•´è¯¦ç»†éœ€æ±‚ï¼‰ | +60% |
| `search_queries` | 0%ï¼ˆç”Ÿæˆä½†æœªä½¿ç”¨ï¼‰ | 80%ï¼ˆPrompt å¼•å¯¼ä½¿ç”¨ï¼‰ | +80% |

---

### å†—ä½™å‡å°‘

1. âœ… **å»é‡é€»è¾‘ç»Ÿä¸€**ï¼šä» 3 å¤„ï¼ˆå·¥å…·å±‚ã€èšåˆå±‚ã€PDFå±‚ï¼‰â†’ 1 å¤„ï¼ˆèšåˆå±‚ï¼‰
2. âœ… **æ•°æ®ä¼ é€’ç®€åŒ–**ï¼šé—®å·æ•°æ®ç›´æ¥ä¼ é€’ï¼Œä¸å†å¤šå±‚åµŒå¥—
3. âœ… **å®¹é”™å¤„ç†é›†ä¸­**ï¼šç»Ÿä¸€åœ¨ `_consolidate_search_references` å¤„ç†å¼‚å¸¸æƒ…å†µ

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### å»ºè®® 1: ç›‘æ§æœç´¢æŸ¥è¯¢ä½¿ç”¨ç‡

**ç›®æ ‡**: è¯„ä¼°ä¸“å®¶å®é™…ä½¿ç”¨é¢„ç”ŸæˆæŸ¥è¯¢çš„æ¯”ä¾‹

**å®æ–½**:
```python
# åœ¨ tool_callback.py ä¸­æ·»åŠ 
logger.info(f"ğŸ” å·¥å…·è°ƒç”¨æŸ¥è¯¢: {query}")
logger.info(f"ğŸ“‹ é¢„ç”ŸæˆæŸ¥è¯¢: {recommended_queries}")

# è®¡ç®—ç›¸ä¼¼åº¦
similarity = calculate_query_similarity(query, recommended_queries)
logger.info(f"ğŸ“Š æŸ¥è¯¢ç›¸ä¼¼åº¦: {similarity:.2f}")
```

---

### å»ºè®® 2: å‰ç«¯å±•ç¤ºæ¦‚å¿µå›¾é…ç½®

**ç›®æ ‡**: è®©ç”¨æˆ·æ˜ç¡®çŸ¥é“å“ªäº›äº¤ä»˜ç‰©ä¼šç”Ÿæˆæ¦‚å¿µå›¾

**å®æ–½**: åœ¨ä»»åŠ¡å®¡æ ¸ç•Œé¢æ·»åŠ æ¦‚å¿µå›¾é…ç½®æ˜¾ç¤ºå’Œç¼–è¾‘åŠŸèƒ½

---

### å»ºè®® 3: ç»Ÿä¸€æ•°æ®ç»“æ„å‘½åè§„èŒƒ

**ç›®æ ‡**: æå‡ä»£ç å¯è¯»æ€§

**ä¿®æ”¹**:
- `deliverable_metadata` â†’ `deliverables_metadata`ï¼ˆå¤æ•°ï¼‰
- ä¸º `questionnaire_responses` å’Œ `questionnaire_summary` æ·»åŠ æ–‡æ¡£è¯´æ˜å±‚çº§å…³ç³»

---

## ğŸ“ ç‰ˆæœ¬å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|---------|
| v7.122 | 2026-01-03 | æœç´¢æŸ¥è¯¢æ³¨å…¥ã€é—®å·æ•°æ®å®Œæ•´ä¼ é€’ã€æœç´¢å¼•ç”¨ç»Ÿä¸€å¤„ç† |
| v7.121 | 2025-12-XX | é—®å·æ•°æ®åŠ å…¥æœç´¢æŸ¥è¯¢ç”Ÿæˆ |
| v7.108 | 2025-11-XX | æ¦‚å¿µå›¾ç”ŸæˆåŠŸèƒ½ |
| v7.64 | 2025-10-XX | æœç´¢å¼•ç”¨è¿½è¸ªåŠŸèƒ½ |

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢å¯¹æ•°æ®æµä¼˜åŒ–çš„å…³æ³¨å’Œæ”¯æŒï¼

å¦‚æœ‰ä»»ä½•ç–‘é—®æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- **Issues**: https://github.com/dafei0755/ai/issues
- **Discussions**: https://github.com/dafei0755/ai/discussions

---

**æ–‡æ¡£ç»“æŸ** ğŸ‰
