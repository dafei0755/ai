# 问卷第一步智能化任务数量 - v7.110.0

## 📋 改进概述

**版本**: v7.110.0
**日期**: 2026-01-02
**改进目标**: 将问卷第一步的任务数量从硬编码的5-7个改为基于用户输入复杂度智能评估的3-12个弹性范围

---

## 🎯 核心改进

### 问题
原系统将问卷第一步的任务数量硬编码为固定的5-7个范围，无法根据用户输入的实际复杂度灵活调整：
- 简单需求（如单一功能设计）也被强制拆解为5个任务
- 复杂需求（如多维度文化融合项目）最多只能拆解7个任务
- 无法充分挖掘用户需求，也无法避免过度拆解

### 解决方案
实现智能化任务数量评估系统，根据输入复杂度动态决定任务数量（3-12个弹性范围）

---

## 🔧 技术实现

### 1. 新增 `TaskComplexityAnalyzer` 类

**文件**: [intelligent_project_analyzer/services/core_task_decomposer.py](../intelligent_project_analyzer/services/core_task_decomposer.py#L14-L150)

**功能**: 分析用户输入和结构化数据，智能评估建议的任务数量

**评估维度**:

| 维度 | 权重 | 评估指标 |
|------|------|---------|
| 输入长度 | 15% | <50字=0.2, 50-150字=0.4, 150-300字=0.6, >300字=0.8 |
| 信息维度数 | 35% | 检测12个维度（空间规模、预算、对标、文化、客群、张力、品牌等） |
| 结构化数据深度 | 25% | 检查6个关键字段（design_challenge, character_narrative等） |
| 特殊场景 | 15% | 诗意表达、多元对立、跨界融合、文化深度 |
| 句子数量 | 5% | 反映思考深度 |
| 具体数字 | 5% | 反映精确度 |

**复杂度映射**:

```python
复杂度 < 0.3  → 3-5个任务   # 简单需求
0.3 ≤ 复杂度 < 0.6 → 5-8个任务   # 中等需求
复杂度 ≥ 0.6  → 8-12个任务  # 复杂需求
```

**示例输出**:

```python
{
    "recommended_min": 3,
    "recommended_max": 5,
    "complexity_score": 0.25,
    "reasoning": "输入较简短; 包含2个信息维度; 结构化数据包含2个关键字段"
}
```

---

### 2. 重构 `decompose_core_tasks()` 函数

**改进点**:
1. 调用 `TaskComplexityAnalyzer.analyze()` 动态计算任务数量范围
2. 将推荐范围传递给 LLM prompt
3. 智能截断：如果 LLM 生成任务数超过推荐上限，优先保留高优先级任务
4. 灵活补齐：如果任务数少于推荐最小值，仅记录警告（允许 LLM 自主判断）

**关键日志**:
```log
🎯 [智能任务数量] 推荐范围: 3-5个 (复杂度=0.25)
   分析依据: 输入较简短; 包含2个信息维度; 结构化数据包含2个关键字段
```

---

### 3. 优化回退策略 `_simple_fallback_decompose()`

**改进**:
1. 接收复杂度分析结果作为参数
2. 如果未提供，自动调用 `TaskComplexityAnalyzer.analyze()`
3. 补齐逻辑：补充至推荐最小值（不再固定为5个）
4. 截断逻辑：不超过推荐最大值，优先保留高优先级任务

**关键代码**:
```python
# 智能补齐
if len(tasks) < recommended_min:
    logger.warning(f"当前仅生成 {len(tasks)} 个任务，补充通用任务至{recommended_min}个")
    # 补充逻辑...

# 智能截断
if len(tasks) > recommended_max:
    logger.warning(f"生成了{len(tasks)}个任务，超过推荐上限{recommended_max}，智能截断")
    high_priority_tasks = [t for t in tasks if t.get("priority") == "high"]
    other_tasks = [t for t in tasks if t.get("priority") != "high"]
    tasks = (high_priority_tasks + other_tasks)[:recommended_max]
```

---

### 4. 更新配置文件

**文件**: [intelligent_project_analyzer/config/prompts/core_task_decomposer.yaml](../intelligent_project_analyzer/config/prompts/core_task_decomposer.yaml)

**配置更新**:

```yaml
business_config:
  enable_dynamic_datetime: false
  timeout_seconds: 30
  # 🆕 v7.110.0: 不再固定任务数量，改为自适应评估
  adaptive_task_count: true  # 启用智能任务数量评估
  min_tasks: 3  # 绝对最小值（简单需求）
  max_tasks: 12  # 绝对最大值（复杂需求）
  base_tasks: 5  # 基准值（中等复杂度）
  # 旧版固定值已废弃（保留作为参考）
  # max_tasks: 7
  # min_tasks: 5
```

**Prompt 模板更新**:

```yaml
## 输出质量要求（v7.110.0 智能化）

### 任务数量（🆕 自适应）
- 系统会根据输入复杂度智能评估建议的任务数量范围（3-12个）
- **简单需求**（复杂度<0.3）：生成 **3-5 个任务**
  - 示例：单一功能设计、明确单一主题的项目
- **中等需求**（复杂度0.3-0.6）：生成 **5-8 个任务**
  - 示例：多维度考虑的常规项目
- **复杂需求**（复杂度>0.6）：生成 **8-12 个任务**
  - 示例：多对立概念、跨界融合、深厚文化背景的项目
- ⚠️ 系统会在运行时动态告知具体的任务数量要求，请严格遵守
```

---

### 5. 更新测试用例

**文件**:
- [test_questionnaire_step1.py](../test_questionnaire_step1.py)
- [test_motivation_label_fix.py](../test_motivation_label_fix.py)

**改进**: 将固定断言 `assert 5 <= len(tasks) <= 7` 改为自适应验证 `assert 3 <= len(tasks) <= 12`

**测试输出示例**:
```
✅ 拆解出 5 个任务（合理范围: 3-12）：
```

---

## 📊 测试结果

### 测试用例 1: 文化保护项目
**输入**: "深圳蛇口渔村改造项目，需要在现代化改造的同时保留渔民文化记忆"

**复杂度分析**:
- 复杂度: 0.25
- 建议任务数: 3-5个
- 分析依据: 输入较简短; 包含2个信息维度; 结构化数据包含2个关键字段

**结果**: ✅ 生成5个任务（符合推荐范围）

---

### 测试用例 2: 商业空间设计
**输入**: "设计一个新零售咖啡店，提升品牌影响力和商业价值"

**复杂度分析**:
- 复杂度: 0.21
- 建议任务数: 3-5个
- 分析依据: 输入较简短; 包含2个信息维度; 结构化数据包含1个关键字段

**结果**: ✅ LLM生成7个任务，智能截断为5个（优先保留高优先级任务）

---

### 测试用例 3: 无障碍设计
**输入**: "社区公园无障碍改造，让老人和轮椅使用者都能方便使用"

**复杂度分析**:
- 复杂度: 0.17
- 建议任务数: 3-5个
- 分析依据: 输入较简短; 包含1个信息维度; 结构化数据包含1个关键字段

**结果**: ✅ LLM生成7个任务，智能截断为5个

---

## 🎨 智能截断策略

当 LLM 生成的任务数超过推荐上限时，系统会：

1. **分类任务**: 将任务分为高优先级（high priority）和其他优先级
2. **优先保留**: 优先保留高优先级任务
3. **智能截断**: 从高到低依次保留，直到达到推荐上限
4. **重新编号**: 重新分配任务 ID 和执行顺序

**示例日志**:
```log
⚠️ LLM生成了7个任务，超过推荐上限5，智能截断
✅ [任务拆解完成] 最终生成5个任务
```

---

## 💡 设计考量

### 1. 为什么保留绝对上限12个？
- **用户认知负担**: 超过12个任务，用户难以一次性理解和确认
- **工作流效率**: 过多任务导致后续步骤冗长
- **质量控制**: 12个任务足以覆盖最复杂的多维度项目

### 2. 为什么最小值设为3个？
- **有效拆解**: 少于3个任务失去"拆解"的意义
- **覆盖MECE**: 至少需要3个任务才能覆盖"研究-分析-设计"的基本流程
- **灵活性**: 允许简单需求快速通过第一步

### 3. LLM vs 复杂度分析器的权衡
- **复杂度分析器**: 提供建议范围，约束 LLM 输出
- **LLM**: 在建议范围内自主判断具体任务数量
- **智能截断**: 当 LLM 判断失误时的保险机制

### 4. 为什么不强制补齐最小值？
- **信任 LLM 判断**: 如果 LLM 认为3个任务不够，会自然生成更多
- **避免冗余**: 强制补齐可能生成无意义的通用任务
- **仅在回退策略中补齐**: fallback 场景下才启用补齐逻辑

---

## 🔍 关键改进点总结

| 改进项 | 旧版本 | v7.110.0 |
|--------|--------|---------|
| 任务数量范围 | 固定5-7个 | 自适应3-12个 |
| 评估方式 | 硬编码 | 智能复杂度分析（6个维度） |
| 简单需求 | 强制5个 | 3-5个（灵活） |
| 复杂需求 | 最多7个 | 8-12个（充分挖掘） |
| 超量处理 | 截断为7个 | 智能截断（保留高优先级） |
| 不足处理 | 补齐至5个 | 补齐至推荐最小值 |
| 配置管理 | max_tasks=7, min_tasks=5 | adaptive_task_count=true, 弹性范围 |
| 日志可见性 | 无复杂度信息 | 详细复杂度分析和推理依据 |

---

## 📈 效果预期

1. **简单需求加速**: 单一功能设计类项目可快速完成第一步（3-4个任务）
2. **复杂需求深度**: 多维度文化融合项目可充分拆解（9-12个任务）
3. **中等需求灵活**: 常规项目保持原有5-7个任务的合理范围
4. **LLM质量提升**: 明确的任务数量指导，减少"过度拆解"或"拆解不足"

---

## 🚀 后续优化方向

### 1. 渐进式展示（可选）
对于8个以上任务，可考虑分为"核心任务"和"深度探索任务"两组，避免信息过载

### 2. 用户反馈学习
收集用户调整任务的数据，优化复杂度分析算法的权重

### 3. 项目类型差异化
不同项目类型（文化保护 vs 商业空间）可能需要不同的任务数量基准

### 4. 复杂度可视化
在前端展示复杂度分析结果，帮助用户理解任务数量的合理性

---

## 📝 迁移指南

### 对现有系统的影响

**兼容性**: ✅ 完全向后兼容
- 旧版配置中的 `max_tasks: 7` 和 `min_tasks: 5` 仍然生效
- 新增 `adaptive_task_count: true` 可启用智能模式

**测试更新**: 需要更新测试用例中的任务数量断言
```python
# 旧版
assert 5 <= len(tasks) <= 7

# 新版
assert 3 <= len(tasks) <= 12
```

**日志增强**: 新增复杂度分析日志，便于调试和优化
```log
📊 [TaskComplexityAnalyzer] 复杂度=0.25, 建议任务数=3-5
🎯 [智能任务数量] 推荐范围: 3-5个 (复杂度=0.25)
   分析依据: 输入较简短; 包含2个信息维度; 结构化数据包含2个关键字段
```

---

## 🔗 相关文件

- 核心实现: [intelligent_project_analyzer/services/core_task_decomposer.py](../intelligent_project_analyzer/services/core_task_decomposer.py)
- 配置文件: [intelligent_project_analyzer/config/prompts/core_task_decomposer.yaml](../intelligent_project_analyzer/config/prompts/core_task_decomposer.yaml)
- 测试文件:
  - [test_questionnaire_step1.py](../test_questionnaire_step1.py)
  - [test_motivation_label_fix.py](../test_motivation_label_fix.py)

---

**版本**: v7.110.0
**状态**: ✅ 实施完成并通过测试
**作者**: GitHub Copilot (Claude Sonnet 4.5)
**日期**: 2026-01-02
