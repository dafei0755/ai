# ä¼šè¯å†å²æ¸…ç†æŒ‡å—

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

è¯¥è„šæœ¬ç”¨äºæ¸…ç†ç³»ç»Ÿä¸­æ‰€æœ‰å¼‚å¸¸æˆ–æœªå®Œæ•´æ‰§è¡Œçš„ä¼šè¯æ•°æ®ï¼Œç¡®ä¿å†å²è®°å½•çš„å¹²å‡€æ•´æ´ã€‚

## ğŸ¯ æ¸…ç†æ ‡å‡†

è„šæœ¬ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶æ¸…ç†ä»¥ä¸‹ç±»å‹çš„å¼‚å¸¸ä¼šè¯ï¼š

### 1. çŠ¶æ€å¼‚å¸¸çš„ä¼šè¯
- çŠ¶æ€ä¸ºï¼š`failed`, `error`, `timeout`, `cancelled`, `aborted`

### 2. è¶…æ—¶æœªå®Œæˆçš„ä¼šè¯
- çŠ¶æ€ä¸º `processing` ä½†åˆ›å»ºæ—¶é—´è¶…è¿‡ **24å°æ—¶**

### 3. æµ‹è¯•ä¼šè¯
- é¡¹ç›®åç§°åŒ…å«ä»¥ä¸‹å…³é”®è¯ï¼š
  - ä¸­æ–‡ï¼š`æµ‹è¯•`ã€`æ ·ä¾‹`ã€`ä¸´æ—¶`ã€`è°ƒè¯•`
  - è‹±æ–‡ï¼š`test`ã€`demo`ã€`example`ã€`temp`ã€`tmp`ã€`debug`

### 4. ç©ºä¼šè¯
- åˆ›å»ºè¶…è¿‡ **1å°æ—¶** ä½†æ— ä»»ä½•æ•°æ®ï¼ˆæ— rolesã€dimensionsã€tasksï¼‰

### 5. å¼‚å¸¸ user_id
- `user_id` ä¸ºç©ºæˆ–å€¼ä¸º `null`ã€`undefined`ã€`None`
- **æ³¨æ„**ï¼š`web_user` è¢«è§†ä¸ºæ­£å¸¸å€¼ï¼Œä¸ä¼šè¢«æ¸…ç†

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: ä»…æ‰«æï¼ˆæ¨èé¦–æ¬¡ä½¿ç”¨ï¼‰

å…ˆæ‰«ææŸ¥çœ‹æœ‰å“ªäº›å¼‚å¸¸ä¼šè¯ï¼Œä¸æ‰§è¡Œåˆ é™¤ï¼š

```bash
python scripts/cleanup_session_history.py --dry-run
```

**è¾“å‡ºç¤ºä¾‹**:
```
============================================================
ä¼šè¯å†å²æ¸…ç†å·¥å…·
============================================================

æ¸…ç†æ ‡å‡†:
  1. çŠ¶æ€å¼‚å¸¸ï¼ˆfailed, error, timeoutç­‰ï¼‰
  2. è¶…æ—¶æœªå®Œæˆï¼ˆprocessing > 24å°æ—¶ï¼‰
  3. æµ‹è¯•ä¼šè¯ï¼ˆåŒ…å«æµ‹è¯•å…³é”®è¯ï¼‰
  4. ç©ºä¼šè¯ï¼ˆæ— æ•°æ®ä¸” > 1å°æ—¶ï¼‰
  5. å¼‚å¸¸user_idï¼ˆnull, undefinedç­‰ï¼‰

âœ“ Redisè¿æ¥æˆåŠŸ
âœ“ å½’æ¡£æ•°æ®åº“è¿æ¥æˆåŠŸ

============================================================
æ‰«ææ´»è·ƒä¼šè¯ï¼ˆRedisï¼‰...
============================================================
â†’ æ‰¾åˆ° 15 ä¸ªæ´»è·ƒä¼šè¯
  âœ— abc12345... | alice | æµ‹è¯•é¡¹ç›® | completed
    åŸå› : æµ‹è¯•ä¼šè¯: æµ‹è¯•é¡¹ç›®
  âœ— def67890... | bob | Example | failed
    åŸå› : å¼‚å¸¸çŠ¶æ€: failed

â†’ å‘ç° 2 ä¸ªå¼‚å¸¸æ´»è·ƒä¼šè¯

============================================================
æ‰«æå½’æ¡£ä¼šè¯ï¼ˆSQLiteï¼‰...
============================================================
â†’ æ‰¾åˆ° 50 ä¸ªå½’æ¡£ä¼šè¯
  âœ— ghi11111... | web_user | ä¸´æ—¶æµ‹è¯• | processing
    åŸå› : è¶…æ—¶æœªå®Œæˆï¼ˆ>24å°æ—¶ï¼‰

â†’ å‘ç° 1 ä¸ªå¼‚å¸¸å½’æ¡£ä¼šè¯

âš ï¸  DRY RUN æ¨¡å¼ - ä¸æ‰§è¡Œåˆ é™¤
```

---

### æ–¹æ³•2: äº¤äº’å¼æ¸…ç†

æ‰«æå¹¶æç¤ºç¡®è®¤ååˆ é™¤ï¼š

```bash
python scripts/cleanup_session_history.py
```

**æ‰§è¡Œæµç¨‹**:
1. æ‰«ææ‰€æœ‰ä¼šè¯
2. æ˜¾ç¤ºå¼‚å¸¸ä¼šè¯åˆ—è¡¨
3. ç­‰å¾…ç”¨æˆ·ç¡®è®¤
4. æ‰§è¡Œåˆ é™¤
5. æ˜¾ç¤ºæ¸…ç†æ‘˜è¦

**ç¡®è®¤æç¤º**:
```
============================================================
âš ï¸  å³å°†åˆ é™¤ 3 ä¸ªå¼‚å¸¸ä¼šè¯
============================================================
  æ´»è·ƒä¼šè¯: 2 ä¸ª
  å½’æ¡£ä¼šè¯: 1 ä¸ª

ç¡®è®¤åˆ é™¤ï¼Ÿ[y/N]: y
```

---

### æ–¹æ³•3: è‡ªåŠ¨æ¸…ç†ï¼ˆæ— ç¡®è®¤ï¼‰

è‡ªåŠ¨åˆ é™¤æ‰€æœ‰å¼‚å¸¸ä¼šè¯ï¼Œä¸è¯¢é—®ç¡®è®¤ï¼š

```bash
python scripts/cleanup_session_history.py --auto-confirm
```

æˆ–ç®€å†™ï¼š

```bash
python scripts/cleanup_session_history.py -y
```

**âš ï¸ è­¦å‘Š**: æ­¤æ¨¡å¼å°†ç›´æ¥åˆ é™¤ï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼

---

## ğŸ“Š è¾“å‡ºç¤ºä¾‹

### å®Œæ•´æ‰§è¡Œè¾“å‡º

```bash
$ python scripts/cleanup_session_history.py
============================================================
ä¼šè¯å†å²æ¸…ç†å·¥å…·
============================================================

æ¸…ç†æ ‡å‡†:
  1. çŠ¶æ€å¼‚å¸¸ï¼ˆfailed, error, timeoutç­‰ï¼‰
  2. è¶…æ—¶æœªå®Œæˆï¼ˆprocessing > 24å°æ—¶ï¼‰
  3. æµ‹è¯•ä¼šè¯ï¼ˆåŒ…å«æµ‹è¯•å…³é”®è¯ï¼‰
  4. ç©ºä¼šè¯ï¼ˆæ— æ•°æ®ä¸” > 1å°æ—¶ï¼‰
  5. å¼‚å¸¸user_idï¼ˆnull, undefinedç­‰ï¼‰

âœ“ Redisè¿æ¥æˆåŠŸ
âœ“ å½’æ¡£æ•°æ®åº“è¿æ¥æˆåŠŸ

============================================================
æ‰«ææ´»è·ƒä¼šè¯ï¼ˆRedisï¼‰...
============================================================
â†’ æ‰¾åˆ° 15 ä¸ªæ´»è·ƒä¼šè¯
  âœ— abc12345... | alice | æµ‹è¯•é¡¹ç›® | completed
    åŸå› : æµ‹è¯•ä¼šè¯: æµ‹è¯•é¡¹ç›®
  âœ— def67890... | bob | Example | failed
    åŸå› : å¼‚å¸¸çŠ¶æ€: failed

â†’ å‘ç° 2 ä¸ªå¼‚å¸¸æ´»è·ƒä¼šè¯

============================================================
æ‰«æå½’æ¡£ä¼šè¯ï¼ˆSQLiteï¼‰...
============================================================
â†’ æ‰¾åˆ° 50 ä¸ªå½’æ¡£ä¼šè¯
  âœ— ghi11111... | web_user | Debug Session | processing
    åŸå› : è¶…æ—¶æœªå®Œæˆï¼ˆ>24å°æ—¶ï¼‰

â†’ å‘ç° 1 ä¸ªå¼‚å¸¸å½’æ¡£ä¼šè¯

============================================================
âš ï¸  å³å°†åˆ é™¤ 3 ä¸ªå¼‚å¸¸ä¼šè¯
============================================================
  æ´»è·ƒä¼šè¯: 2 ä¸ª
  å½’æ¡£ä¼šè¯: 1 ä¸ª

ç¡®è®¤åˆ é™¤ï¼Ÿ[y/N]: y

============================================================
åˆ é™¤æ´»è·ƒä¼šè¯ï¼ˆå…± 2 ä¸ªï¼‰...
============================================================
  âœ“ å·²åˆ é™¤: abc12345...
  âœ“ å·²åˆ é™¤: def67890...

â†’ æˆåŠŸåˆ é™¤ 2 ä¸ªæ´»è·ƒä¼šè¯

============================================================
åˆ é™¤å½’æ¡£ä¼šè¯ï¼ˆå…± 1 ä¸ªï¼‰...
============================================================
  âœ“ å·²åˆ é™¤: ghi11111...

â†’ æˆåŠŸåˆ é™¤ 1 ä¸ªå½’æ¡£ä¼šè¯

============================================================
æ¸…ç†æ‘˜è¦
============================================================
æ´»è·ƒä¼šè¯: 15 ä¸ª â†’ åˆ é™¤ 2 ä¸ª
å½’æ¡£ä¼šè¯: 50 ä¸ª â†’ åˆ é™¤ 1 ä¸ª
å¤±è´¥: 0 ä¸ª
============================================================
âœ“ æˆåŠŸæ¸…ç† 3 ä¸ªå¼‚å¸¸ä¼šè¯
```

---

## âš™ï¸ å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | ç®€å†™ | è¯´æ˜ |
|------|------|------|
| `--dry-run` | - | ä»…æ‰«æï¼Œä¸æ‰§è¡Œåˆ é™¤ï¼ˆç”¨äºé¢„è§ˆï¼‰ |
| `--auto-confirm` | `-y` | è‡ªåŠ¨ç¡®è®¤ï¼Œä¸è¯¢é—®ç”¨æˆ· |
| `--help` | `-h` | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ |

---

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. ä¿æŠ¤æ­£å¸¸ä¼šè¯
- `web_user` ä¼šè¯ä¸ä¼šè¢«æ¸…ç†ï¼ˆé™¤éæ˜ç¡®å¼‚å¸¸ï¼‰
- æ­£å¸¸çŠ¶æ€çš„ä¼šè¯ï¼ˆ`completed`, `in_progress`ç­‰ï¼‰ä¸å—å½±å“
- ä»…åˆ é™¤æ˜ç¡®ç¬¦åˆå¼‚å¸¸æ ‡å‡†çš„ä¼šè¯

### 2. å¤šé‡ç¡®è®¤
- é»˜è®¤éœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤ï¼ˆè¾“å…¥ `y`ï¼‰
- `--dry-run` æ¨¡å¼å…è®¸æ— é£é™©é¢„è§ˆ
- è¯¦ç»†æ—¥å¿—è®°å½•æ¯ä¸ªåˆ é™¤æ“ä½œ

### 3. é”™è¯¯å¤„ç†
- å•ä¸ªä¼šè¯åˆ é™¤å¤±è´¥ä¸å½±å“å…¶ä»–ä¼šè¯
- å¼‚å¸¸æƒ…å†µè®°å½•åœ¨ `failed` è®¡æ•°ä¸­
- å®Œæ•´çš„é”™è¯¯å †æ ˆè¿½è¸ª

---

## ğŸ“ æ¸…ç†å»ºè®®

### å®šæœŸæ¸…ç†

å»ºè®®æ¯å‘¨è¿è¡Œä¸€æ¬¡æ¸…ç†è„šæœ¬ï¼š

```bash
# 1. å…ˆæ‰«ææŸ¥çœ‹
python scripts/cleanup_session_history.py --dry-run

# 2. ç¡®è®¤æ— è¯¯åæ‰§è¡Œæ¸…ç†
python scripts/cleanup_session_history.py
```

### è‡ªåŠ¨åŒ–æ¸…ç†ï¼ˆå¯é€‰ï¼‰

å¯ä»¥å°†æ¸…ç†è„šæœ¬æ·»åŠ åˆ° Windows ä»»åŠ¡è®¡åˆ’ç¨‹åºï¼š

```batch
REM æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ¸…ç†
schtasks /create /tn "CleanupSessions" /tr "python D:\11-20\langgraph-design\scripts\cleanup_session_history.py -y" /sc weekly /d SUN /st 02:00
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡ä½¿ç”¨å»ºè®®**ï¼š
   - å…ˆä½¿ç”¨ `--dry-run` æŸ¥çœ‹è¦åˆ é™¤çš„ä¼šè¯
   - ç¡®è®¤æ— è¯¯åå†æ‰§è¡Œåˆ é™¤

2. **æ•°æ®ä¸å¯æ¢å¤**ï¼š
   - åˆ é™¤æ“ä½œä¸å¯é€†
   - å»ºè®®æ¸…ç†å‰å…ˆè¿è¡Œå¤‡ä»½è„šæœ¬

3. **æœåŠ¡åœæ­¢**ï¼š
   - å»ºè®®åœ¨æœåŠ¡åœæ­¢æˆ–ä½å³°æœŸæ‰§è¡Œæ¸…ç†
   - é¿å…æ¸…ç†æ­£åœ¨è¿è¡Œçš„ä¼šè¯

4. **æƒé™è¦æ±‚**ï¼š
   - éœ€è¦ Redis å’Œå½’æ¡£æ•°æ®åº“çš„è®¿é—®æƒé™
   - éœ€è¦èƒ½å¤Ÿå¯¼å…¥é¡¹ç›®æ¨¡å—

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1: Redisè¿æ¥å¤±è´¥

```
âœ— Redisè¿æ¥å¤±è´¥: Connection refused
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ Redis æœåŠ¡æ˜¯å¦è¿è¡Œ
- éªŒè¯ `settings.REDIS_URL` é…ç½®

### é—®é¢˜2: å½’æ¡£æ•°æ®åº“è®¿é—®å¤±è´¥

```
âš  å½’æ¡£æ•°æ®åº“è¿æ¥å¤±è´¥: unable to open database file
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ `settings.ARCHIVE_DB_PATH` è·¯å¾„æ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ–‡ä»¶è®¿é—®æƒé™

### é—®é¢˜3: æ¨¡å—å¯¼å…¥é”™è¯¯

```
ModuleNotFoundError: No module named 'intelligent_project_analyzer'
```

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œè„šæœ¬
- æ£€æŸ¥ Python ç¯å¢ƒæ˜¯å¦æ­£ç¡®

---

## ğŸ“ˆ æ‰©å±•åŠŸèƒ½

### è‡ªå®šä¹‰æ¸…ç†æ ‡å‡†

ç¼–è¾‘è„šæœ¬ä¸­çš„ä»¥ä¸‹å˜é‡ï¼š

```python
# å¼‚å¸¸çŠ¶æ€åˆ—è¡¨
self.ABNORMAL_STATUSES = {
    "failed", "error", "timeout", "cancelled", "aborted"
}

# æµ‹è¯•å…³é”®è¯åˆ—è¡¨
self.TEST_KEYWORDS = [
    "æµ‹è¯•", "test", "demo", "example", "æ ·ä¾‹",
    "ä¸´æ—¶", "temp", "tmp", "è°ƒè¯•", "debug"
]
```

### è°ƒæ•´æ—¶é—´é˜ˆå€¼

```python
# æœªå®Œæˆä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤24å°æ—¶ï¼‰
if datetime.now() - created_time > timedelta(hours=24):

# ç©ºä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤1å°æ—¶ï¼‰
if datetime.now() - created_time > timedelta(hours=1):
```

---

## âœ… éªŒæ”¶æ£€æŸ¥

æ¸…ç†å®Œæˆåï¼ŒéªŒè¯ç»“æœï¼š

```bash
# 1. æ£€æŸ¥æ´»è·ƒä¼šè¯æ•°é‡
redis-cli KEYS "session:*" | wc -l

# 2. æ£€æŸ¥å½’æ¡£ä¼šè¯æ•°é‡
sqlite3 data/archived_sessions.db "SELECT COUNT(*) FROM sessions;"

# 3. æŸ¥çœ‹æ¸…ç†æ—¥å¿—
cat cleanup_session_history.log
```

---

**æ¸…ç†å‰è¯·å¤‡ä»½é‡è¦æ•°æ®ï¼**

```bash
# è¿è¡Œå¤‡ä»½è„šæœ¬
scripts\backup_project_fixed.bat

# ç„¶åæ‰§è¡Œæ¸…ç†
python scripts/cleanup_session_history.py
```
