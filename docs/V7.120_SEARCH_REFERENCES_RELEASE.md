# v7.120 æœç´¢å¼•ç”¨åŠŸèƒ½å‘å¸ƒè¯´æ˜

**å‘å¸ƒæ—¥æœŸ**: 2026-01-03
**ç‰ˆæœ¬**: v7.120
**ç±»å‹**: Bug Fix (å…³é”®ä¿®å¤)

## æ¦‚è¿°

ä¿®å¤äº†æœç´¢å·¥å…·æ‰§è¡Œæ­£å¸¸ä½†å‰ç«¯æ— æ³•æ˜¾ç¤ºæœç´¢å¼•ç”¨çš„é—®é¢˜ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿåœ¨åˆ†ææŠ¥å‘Šä¸­çœ‹åˆ°ä¸“å®¶ä½¿ç”¨çš„å¤–éƒ¨æœç´¢å·¥å…·ç»“æœã€‚

## é—®é¢˜èƒŒæ™¯

### ç”¨æˆ·æŠ¥å‘Š

æœç´¢å¼•ç”¨åŠŸèƒ½æœªåœ¨å‰ç«¯å±•ç¤ºï¼Œç”¨æˆ·æ— æ³•çœ‹åˆ°åˆ†æè¿‡ç¨‹ä¸­ä¸“å®¶ä½¿ç”¨çš„å¤–éƒ¨æœç´¢èµ„æ–™ã€‚

### è¯Šæ–­å‘ç°

é€šè¿‡ç³»ç»ŸåŒ–çš„4å±‚çº§è¯Šæ–­ï¼ˆå·¥å…·è¿é€šæ€§â†’æŸ¥è¯¢ç”Ÿæˆâ†’æœç´¢æ‰§è¡Œâ†’ç»“æœå‘ˆç°ï¼‰ï¼Œç¡®è®¤ï¼š

| å±‚çº§ | æ£€æŸ¥é¡¹ | çŠ¶æ€ |
|------|--------|------|
| 1. å·¥å…·è¿é€šæ€§ | Tavily, Bocha, ArXiv, RAGFlow | âœ… å…¨éƒ¨æ­£å¸¸ |
| 2. æŸ¥è¯¢ç”Ÿæˆ | SearchStrategyGenerator | âœ… æ­£å¸¸ç”Ÿæˆ3ä¸ªæŸ¥è¯¢ |
| 3. æœç´¢æ‰§è¡Œ | å·¥å…·è°ƒç”¨ä¸ç»“æœè¿”å› | âœ… æ­£å¸¸è¿”å›ç»“æœ |
| 4. ç»“æœå‘ˆç° | WebSocketæ¨é€åˆ°å‰ç«¯ | âŒ **ç¼ºå¤±å­—æ®µ** |

**æ ¹æœ¬åŸå› **: WebSocketæ¨é€æ¶ˆæ¯ä¸­æ²¡æœ‰åŒ…å« `search_references` å­—æ®µã€‚

## ä¿®å¤å†…å®¹

### æ ¸å¿ƒä¿®æ”¹

#### 1. åç«¯WebSocketæ¨é€ (server.py)

**ä¿®æ”¹ä½ç½®**: `intelligent_project_analyzer/api/server.py`

##### a) èŠ‚ç‚¹è¾“å‡ºæå– (Lines 1417-1432)

```python
# ğŸ”¥ v7.120: æå–search_referencesï¼ˆå¦‚æœèŠ‚ç‚¹æ›´æ–°äº†æ­¤å­—æ®µï¼‰
update_data = {
    "current_node": node_name,
    "detail": detail,
    "history": history
}

# æ£€æŸ¥å¹¶æå–search_references
if isinstance(node_output, dict) and "search_references" in node_output:
    search_refs = node_output["search_references"]
    if search_refs:  # åªæœ‰éç©ºæ‰æ›´æ–°
        update_data["search_references"] = search_refs
        logger.info(f"ğŸ” [v7.120] èŠ‚ç‚¹ {node_name} æ›´æ–°äº† {len(search_refs)} ä¸ªæœç´¢å¼•ç”¨")
```

**ä½œç”¨**: ä»å·¥ä½œæµèŠ‚ç‚¹è¾“å‡ºä¸­æå–æœç´¢å¼•ç”¨å¹¶å­˜å‚¨åˆ°Redisä¼šè¯ã€‚

##### b) çŠ¶æ€æ›´æ–°å¹¿æ’­ (Lines 1508-1523)

```python
# ğŸ”„ ç›´æ¥ä½¿ç”¨è®¡ç®—å€¼å¹¿æ’­åˆ° WebSocketï¼ˆé¿å… Redis è¯»å–ç«æ€ï¼‰
# ğŸ”¥ v7.120: åŒ…å«search_references
broadcast_data = {
    "type": "status_update",
    "status": current_session["status"],
    "progress": progress,
    "current_node": current_node_name,
    "detail": current_session.get("detail")
}

# æ·»åŠ search_referencesï¼ˆå¦‚æœå­˜åœ¨ï¼‰
search_refs = current_session.get("search_references")
if search_refs:
    broadcast_data["search_references"] = search_refs

await broadcast_to_websockets(session_id, broadcast_data)
```

**ä½œç”¨**: åœ¨æ¯æ¬¡çŠ¶æ€æ›´æ–°æ—¶å®æ—¶æ¨é€æœç´¢å¼•ç”¨åˆ°å‰ç«¯ã€‚

##### c) å®ŒæˆçŠ¶æ€å¹¿æ’­ (Lines 1617-1632)

```python
# ğŸ”¥ å¹¿æ’­å®ŒæˆçŠ¶æ€ï¼ˆv7.120: åŒ…å«search_referencesï¼‰
completion_broadcast = {
    "type": "status_update",
    "status": "completed",
    "progress": 1.0,
    "final_report": final_report or "åˆ†æå®Œæˆ",
    "current_node": updated_session.get("current_node") if updated_session else None,
    "detail": updated_session.get("detail") if updated_session else None
}

# æ·»åŠ search_referencesï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if updated_session and updated_session.get("search_references"):
    completion_broadcast["search_references"] = updated_session["search_references"]
    logger.info(f"ğŸ“š [v7.120] å®Œæˆå¹¿æ’­åŒ…å« {len(updated_session['search_references'])} ä¸ªæœç´¢å¼•ç”¨")
```

**ä½œç”¨**: åˆ†æå®Œæˆæ—¶ç¡®ä¿æ¨é€æ‰€æœ‰ç´¯ç§¯çš„æœç´¢å¼•ç”¨ã€‚

#### 2. å·¥å…·è°ƒç”¨æ—¥å¿—å¢å¼º (tool_callback.py)

**ä¿®æ”¹ä½ç½®**: `intelligent_project_analyzer/agents/tool_callback.py`

##### Lines 98-101: å·¥å…·å¯åŠ¨æ—¥å¿—

```python
# ğŸ”¥ v7.120: å¢å¼ºæ—¥å¿— - æ˜¾ç¤ºå·¥å…·è°ƒç”¨å¼€å§‹
logger.info(f"ğŸ”§ [ToolCallRecorder] Tool START: {tool_name}")
logger.info(f"   Role: {self.role_id}, Deliverable: {self.deliverable_id}")
logger.info(f"   Input: {input_str[:100]}...")
```

##### Lines 126-131: å·¥å…·å®Œæˆæ—¥å¿—

```python
# ğŸ”¥ v7.120: å¢å¼ºæ—¥å¿— - æ˜¾ç¤ºå·¥å…·è°ƒç”¨å®Œæˆ
logger.info(
    f"âœ… [ToolCallRecorder] Tool END: {self.active_tool_call['tool_name']}, "
    f"output_length={len(output)} chars"
)
logger.info(f"   Total calls recorded: {len(self.tool_calls)}")
```

**ä½œç”¨**: ä¾¿äºè¿½è¸ªæœç´¢å·¥å…·çš„è°ƒç”¨å’Œæ‰§è¡ŒçŠ¶æ€ã€‚

#### 3. å‰ç«¯ç±»å‹å®šä¹‰ (types/index.ts)

**ä¿®æ”¹ä½ç½®**: `frontend-nextjs/types/index.ts` (Lines 414-431)

```typescript
/** æœç´¢å¼•ç”¨ - ä¸“å®¶ä½¿ç”¨çš„æœç´¢å·¥å…·ç»“æœ */
export interface SearchReference {
  source_tool: 'tavily' | 'bocha' | 'arxiv' | 'ragflow';  // æœç´¢å·¥å…·æ¥æº
  title: string;                      // ç»“æœæ ‡é¢˜
  url?: string;                       // ç»“æœURLï¼ˆå¯é€‰ï¼‰
  snippet: string;                    // ç»“æœæ‘˜è¦/ç‰‡æ®µ
  relevance_score?: number;           // ç›¸å…³æ€§åˆ†æ•°(0-1)
  quality_score?: number;             // è´¨é‡åˆ†æ•°ï¼ˆå¯é€‰ï¼‰
  content_complete?: boolean;         // å†…å®¹å®Œæ•´æ€§ï¼ˆå¯é€‰ï¼‰
  source_credibility?: string;        // æ¥æºå¯ä¿¡åº¦ï¼ˆå¯é€‰ï¼‰
  deliverable_id: string;             // å…³è”çš„äº¤ä»˜ç‰©ID
  query: string;                      // æœç´¢æŸ¥è¯¢å…³é”®è¯
  timestamp: string;                  // æœç´¢æ—¶é—´æˆ³ï¼ˆISOæ ¼å¼ï¼‰
  llm_relevance_score?: number;       // LLMè¯„ä¼°çš„ç›¸å…³æ€§ï¼ˆå¯é€‰ï¼‰
  llm_scoring_reason?: string;        // LLMè¯„åˆ†ç†ç”±ï¼ˆå¯é€‰ï¼‰
}
```

**ä½œç”¨**: ä¸ºå‰ç«¯ç»„ä»¶æä¾›ç±»å‹å®‰å…¨çš„æœç´¢å¼•ç”¨æ•°æ®ç»“æ„ã€‚

### è¯Šæ–­å·¥å…·

#### 1. å®Œæ•´è¯Šæ–­è„šæœ¬

**æ–‡ä»¶**: `scripts/diagnose_search_tools.py`

**åŠŸèƒ½**:
- 5å±‚çº§ç³»ç»ŸåŒ–è¯Šæ–­
- è‡ªåŠ¨æ£€æµ‹å·¥å…·è¿é€šæ€§
- éªŒè¯è§’è‰²å·¥å…·æ˜ å°„
- æµ‹è¯•æœç´¢æŸ¥è¯¢ç”Ÿæˆ
- æ‰§è¡Œå®é™…æœç´¢æµ‹è¯•
- æ£€æŸ¥å‰ç«¯æ•°æ®æµ

**ä½¿ç”¨**:
```bash
python scripts/diagnose_search_tools.py
```

#### 2. å¿«é€Ÿæ£€æŸ¥è„šæœ¬

**æ–‡ä»¶**: `scripts/quick_check_tools.py`

**åŠŸèƒ½**:
- å¿«é€ŸéªŒè¯å·¥å…·é…ç½®
- æµ‹è¯•å·¥å…·å¯ç”¨æ€§
- ç®€åŒ–çš„è¿é€šæ€§æ£€æŸ¥

**ä½¿ç”¨**:
```bash
python scripts/quick_check_tools.py
```

## æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·¥ä½œæµèŠ‚ç‚¹     â”‚
â”‚  (agent_executor) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ è¿”å› search_references
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  server.py      â”‚
â”‚  æå–å¹¶å­˜å‚¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ å­˜å‚¨åˆ° Redis session
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocket å¹¿æ’­ â”‚
â”‚  status_update  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ æ¨é€ search_references
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ç»„ä»¶       â”‚
â”‚  SearchReferences â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
      å±•ç¤ºæœç´¢å¼•ç”¨
```

## éªŒè¯æ­¥éª¤

### 1. é‡å¯åç«¯æœåŠ¡

```bash
python scripts/run_server.py
```

### 2. æäº¤æµ‹è¯•ä»»åŠ¡

**é‡è¦**: ä½¿ç”¨V4æˆ–V6è§’è‰²ï¼ˆæ‹¥æœ‰å…¨éƒ¨æœç´¢å·¥å…·ï¼‰

- âœ… **V4 (è®¾è®¡ç ”ç©¶å‘˜)** - Tavily, Bocha, ArXiv, RAGFlow
- âœ… **V6 (æ€»å·¥ç¨‹å¸ˆ)** - Tavily, Bocha, ArXiv, RAGFlow
- âŒ **V2 (è®¾è®¡æ€»ç›‘)** - æ— æœç´¢å·¥å…·ï¼ˆè®¾è®¡å†³ç­–ï¼‰

### 3. æ£€æŸ¥åç«¯æ—¥å¿—

æœŸæœ›çœ‹åˆ°ï¼š

```
ğŸ”§ [ToolCallRecorder] Tool START: tavily_search
   Role: 4-1, Deliverable: 4-1_1_143022_abc
   Input: ç”¨æˆ·ç”»åƒ è®¾è®¡æ¡ˆä¾‹ 2024...

âœ… [ToolCallRecorder] Tool END: tavily_search, output_length=1234 chars
   Total calls recorded: 1

ğŸ” [v7.120] èŠ‚ç‚¹ agent_executor æ›´æ–°äº† 5 ä¸ªæœç´¢å¼•ç”¨
ğŸ“š [v7.120] å®Œæˆå¹¿æ’­åŒ…å« 15 ä¸ªæœç´¢å¼•ç”¨
```

### 4. æ£€æŸ¥WebSocketæ¶ˆæ¯

æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network â†’ WS â†’ Messages

æœŸæœ›çœ‹åˆ°ï¼š

```json
{
  "type": "status_update",
  "status": "running",
  "progress": 0.7,
  "current_node": "agent_executor",
  "detail": "ä¸“å®¶åˆ†æä¸­...",
  "search_references": [
    {
      "source_tool": "tavily",
      "title": "ç”¨æˆ·ç”»åƒè®¾è®¡æ–¹æ³•è®º...",
      "url": "https://...",
      "snippet": "...",
      "relevance_score": 0.85,
      "deliverable_id": "4-1_1_143022_abc",
      "query": "ç”¨æˆ·ç”»åƒ è®¾è®¡æ¡ˆä¾‹ 2024",
      "timestamp": "2026-01-03T14:30:22Z"
    }
  ]
}
```

### 5. éªŒè¯å‰ç«¯æ˜¾ç¤º

- åˆ†æé¡µé¢åº”æ˜¾ç¤º `SearchReferences` ç»„ä»¶
- æœç´¢å¼•ç”¨å¡ç‰‡åº”åŒ…å«ï¼šå·¥å…·æ¥æºã€æ ‡é¢˜ã€æ‘˜è¦ã€URLé“¾æ¥
- æ”¯æŒæŒ‰å·¥å…·ç±»å‹ç­›é€‰ï¼ˆTavily/Bocha/ArXiv/RAGFlowï¼‰

## ç›¸å…³æ–‡æ¡£

### è¯Šæ–­ä¸ä¿®å¤

- [æœç´¢å·¥å…·è¯Šæ–­æŠ¥å‘Š](../SEARCH_TOOLS_DIAGNOSTIC_REPORT.md) - å®Œæ•´è¯Šæ–­è¿‡ç¨‹
- [v7.120 WebSocketä¿®å¤è¯¦è§£](../.github/V7.120_SEARCH_REFERENCES_WEBSOCKET_FIX.md) - æŠ€æœ¯å®ç°ç»†èŠ‚

### ä»£ç å‚è€ƒ

**åç«¯æ ¸å¿ƒæ–‡ä»¶**:
- `intelligent_project_analyzer/api/server.py` - WebSocketæ¨é€é€»è¾‘
- `intelligent_project_analyzer/agents/tool_callback.py` - å·¥å…·è°ƒç”¨è®°å½•
- `intelligent_project_analyzer/core/state.py` - search_referenceså­—æ®µå®šä¹‰
- `intelligent_project_analyzer/workflow/main_workflow.py` - è§’è‰²å·¥å…·æ˜ å°„

**å‰ç«¯æ ¸å¿ƒæ–‡ä»¶**:
- `frontend-nextjs/types/index.ts` - SearchReferenceç±»å‹å®šä¹‰
- `frontend-nextjs/components/SearchReferences.tsx` - æœç´¢å¼•ç”¨å±•ç¤ºç»„ä»¶
- `frontend-nextjs/components/report/SearchReferencesDisplay.tsx` - æŠ¥å‘Šé¡µå±•ç¤º

**æœç´¢å·¥å…·å®ç°**:
- `intelligent_project_analyzer/tools/tavily_search.py` - Tavilyç½‘ç»œæœç´¢
- `intelligent_project_analyzer/agents/bocha_search_tool.py` - åšæŸ¥ä¸­æ–‡æœç´¢
- `intelligent_project_analyzer/tools/arxiv_search.py` - ArXivå­¦æœ¯è®ºæ–‡
- `intelligent_project_analyzer/tools/ragflow_kb.py` - RAGFlowçŸ¥è¯†åº“

## å·²çŸ¥é™åˆ¶ä¸è¯´æ˜

### V2è§’è‰²æœç´¢é™åˆ¶

æ ¹æ®ç³»ç»Ÿè®¾è®¡ï¼Œ**V2ï¼ˆè®¾è®¡æ€»ç›‘ï¼‰è§’è‰²ç¦ç”¨æ‰€æœ‰æœç´¢å·¥å…·**ï¼š

```python
# main_workflow.py:2575
role_tool_mapping = {
    "V2": [],  # è®¾è®¡æ€»ç›‘ï¼šç¦æ­¢å¤–éƒ¨æœç´¢
    "V3": ["bocha", "tavily", "ragflow"],
    "V4": ["bocha", "tavily", "arxiv", "ragflow"],
    "V5": ["bocha", "tavily", "ragflow"],
    "V6": ["bocha", "tavily", "arxiv", "ragflow"],
}
```

**è®¾è®¡ç†ç”±**: è®¾è®¡æ€»ç›‘ä½œä¸ºé¡¹ç›®åè°ƒè€…ï¼Œä¾é å†…éƒ¨çŸ¥è¯†å’Œä¸“å®¶å›¢é˜Ÿåä½œï¼Œä¸ç›´æ¥ä½¿ç”¨å¤–éƒ¨æœç´¢å·¥å…·ã€‚

**æµ‹è¯•å»ºè®®**:
- ä½¿ç”¨V4ï¼ˆè®¾è®¡ç ”ç©¶å‘˜ï¼‰æˆ–V6ï¼ˆæ€»å·¥ç¨‹å¸ˆï¼‰è§’è‰²æµ‹è¯•æœç´¢åŠŸèƒ½
- è¿™ä¸¤ä¸ªè§’è‰²æ‹¥æœ‰å…¨éƒ¨4ä¸ªæœç´¢å·¥å…·

### æœç´¢å·¥å…·å¯ç”¨æ€§

| å·¥å…· | çŠ¶æ€ | é…ç½®è¦æ±‚ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|----------|
| Tavily | âœ… | TAVILY_API_KEY | å®æ—¶ç½‘ç»œæœç´¢ |
| Bocha | âœ… | BOCHA_API_KEY | ä¸­æ–‡AIæœç´¢ |
| ArXiv | âœ… | æ— éœ€å¯†é’¥ | å­¦æœ¯è®ºæ–‡ |
| RAGFlow | âœ… | RAGFLOW_API_KEY | çŸ¥è¯†åº“æ£€ç´¢ |

ç¡®ä¿åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ç›¸åº”çš„APIå¯†é’¥ã€‚

## å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**

- WebSocketæ¶ˆæ¯ä¸­ `search_references` ä¸ºå¯é€‰å­—æ®µ
- ä¸å½±å“ç°æœ‰å‰ç«¯ç»„ä»¶çš„æ­£å¸¸è¿è¡Œ
- æ—§ç‰ˆæœ¬å‰ç«¯ä¼šå¿½ç•¥æ­¤å­—æ®µï¼Œä¸ä¼šæŠ¥é”™

## åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–

1. **å‰ç«¯è§’è‰²æç¤º** - å½“é€‰æ‹©V2è§’è‰²æ—¶ï¼Œæ˜¾ç¤º"è®¾è®¡æ€»ç›‘ä¸ä½¿ç”¨å¤–éƒ¨æœç´¢å·¥å…·"æç¤º
2. **å¢é‡æ¨é€** - é¿å…é‡å¤æ¨é€ç›¸åŒçš„æœç´¢å¼•ç”¨ï¼Œå‡å°‘WebSocketæµé‡
3. **è´¨é‡é˜ˆå€¼è°ƒä¼˜** - æ ¹æ®å®é™…ä½¿ç”¨åé¦ˆè°ƒæ•´ç›¸å…³æ€§é˜ˆå€¼ï¼ˆå½“å‰0.6ï¼‰

### é•¿æœŸä¼˜åŒ–

1. **å¯è§†åŒ–å·¥å…·æƒé™** - åœ¨å‰ç«¯æ˜¾ç¤ºæ¯ä¸ªè§’è‰²çš„å·¥å…·æƒé™çŸ©é˜µ
2. **æœç´¢è´¨é‡ç›‘æ§** - æ”¶é›†æœç´¢ç»“æœä½¿ç”¨ç‡ï¼Œä¼˜åŒ–æŸ¥è¯¢ç”Ÿæˆç­–ç•¥
3. **è‡ªå®šä¹‰å·¥å…·é…ç½®** - å…è®¸ç”¨æˆ·ä¸ºç‰¹å®šé¡¹ç›®è‡ªå®šä¹‰è§’è‰²å·¥å…·æ˜ å°„

## å‘å¸ƒæ¸…å•

- [x] ä¿®å¤WebSocketæ¨é€é€»è¾‘
- [x] å¢å¼ºå·¥å…·è°ƒç”¨æ—¥å¿—
- [x] æ·»åŠ å‰ç«¯ç±»å‹å®šä¹‰
- [x] åˆ›å»ºè¯Šæ–­è„šæœ¬
- [x] æ›´æ–°CHANGELOG.md
- [x] ç¼–å†™å‘å¸ƒæ–‡æ¡£
- [ ] æ‰§è¡Œç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯
- [ ] æ›´æ–°ç”¨æˆ·ä½¿ç”¨æ‰‹å†Œ

## è‡´è°¢

æ­¤ä¿®å¤åŸºäºç³»ç»ŸåŒ–çš„è¯Šæ–­æ–¹æ³•è®ºï¼Œé€šè¿‡4å±‚çº§æ’æŸ¥å¿«é€Ÿå®šä½é—®é¢˜æ ¹æºï¼Œç¡®ä¿ä¿®å¤çš„ç²¾å‡†æ€§å’Œå®Œæ•´æ€§ã€‚

---

**å‘å¸ƒç‰ˆæœ¬**: v7.120
**å‘å¸ƒæ—¥æœŸ**: 2026-01-03
**ç»´æŠ¤å›¢é˜Ÿ**: Intelligent Project Analyzer Team
