# Bug Fix: Workflowå¼‚å¸¸ç»ˆæ­¢ - æ­£åˆ™è¡¨è¾¾å¼è¶…æ—¶

**ä¿®å¤æ—¥æœŸ:** 2025-12-11
**ç‰ˆæœ¬:** v7.4.2
**ä¸¥é‡ç¨‹åº¦:** ğŸ”´ Critical (P0)

---

## é—®é¢˜æè¿°

### ç—‡çŠ¶
- å·¥ä½œæµåœ¨ `calibration_questionnaire` èŠ‚ç‚¹å¡ä½è¶…è¿‡1åˆ†é’Ÿ
- è¿›åº¦æ¡åœåœ¨ 40% ("äºŒæ¬¡éªŒè¯é¢†åŸŸé€‚é…æ€§")
- å‰ç«¯æ˜¾ç¤º"å¤±è´¥"çŠ¶æ€
- åç«¯æ—¥å¿—æ˜¾ç¤ºæœ€åä¸€æ¡æ¶ˆæ¯åæ— å“åº”ï¼š
  ```
  15:16:28.738 | ğŸ” [DEBUG] Step B: å¼€å§‹è°ƒç”¨ KeywordExtractor.extract()...
  ```

### å½±å“èŒƒå›´
- **æ‰€æœ‰ç”¨æˆ·** åœ¨æäº¤è®¾è®¡éœ€æ±‚åéƒ½ä¼šé‡åˆ°æ­¤é—®é¢˜
- å·¥ä½œæµæ— æ³•ç»§ç»­æ‰§è¡Œï¼Œç”¨æˆ·ä½“éªŒä¸¥é‡å—æŸ
- ä¼šè¯å¡åœ¨ç­‰å¾…çŠ¶æ€ï¼Œå ç”¨ Redis èµ„æº

---

## æ ¹æœ¬åŸå› åˆ†æ

### 1. é—®é¢˜å®šä½

é€šè¿‡æ—¥å¿—åˆ†æå’Œè°ƒè¯•æµ‹è¯•ï¼Œç¡®å®šé—®é¢˜å‡ºåœ¨ï¼š

**æ–‡ä»¶:** `intelligent_project_analyzer/interaction/questionnaire/context.py`
**ç±»:** `KeywordExtractor`
**æ–¹æ³•:** `extract()` â†’ `_extract_core_concepts()` â†’ æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…

### 2. æŠ€æœ¯åŸå› 

**æ­£åˆ™è¡¨è¾¾å¼ç¾éš¾æ€§å›æº¯ (Catastrophic Backtracking)**

åŸå§‹ä»£ç ä¸­ä½¿ç”¨äº†å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ï¼š

```python
# å±é™©çš„æ­£åˆ™æ¨¡å¼
CONCEPT_PATTERNS = [
    r'"([^""]{2,20})"',  # ä¸­æ–‡å¼•å·
    r'"([^"]{2,20})"',   # è‹±æ–‡å¼•å·
    r'(?:å…·å¤‡|å®ç°|æ‰“é€ |åˆ›å»º|è®¾è®¡)(?:ä¸€ä¸ª)?[ã€Œ"""]?([^ï¼Œã€‚,.\s""]{2,15})[ã€"""]?(?:çš„|å±æ€§|åŠŸèƒ½|ç‰¹æ€§)',  # åŠ¨è¯+æ¦‚å¿µ
    r'(?:è¦æ±‚|éœ€è¦|å¸Œæœ›)[^ï¼Œã€‚]{0,10}([^ï¼Œã€‚,.\s""]{2,15})(?:çš„|å±æ€§|åŠŸèƒ½)',  # éœ€æ±‚+æ¦‚å¿µ
]
```

**é—®é¢˜ç‚¹:**
1. **åµŒå¥—é‡è¯** (`[^ï¼Œã€‚]{0,10}`) å¯¼è‡´æŒ‡æ•°çº§å›æº¯
2. **å¯é€‰åˆ†ç»„** (`(?:ä¸€ä¸ª)?`) å¢åŠ åŒ¹é…è·¯å¾„
3. **å­—ç¬¦ç±»å¦å®š** (`[^""]{2,20}`) åœ¨é•¿æ–‡æœ¬ä¸­æ€§èƒ½å·®
4. **æ–‡æœ¬é•¿åº¦æœªé™åˆ¶** - åŸå§‹é™åˆ¶ (500-2000å­—ç¬¦) ä»ç„¶å¤ªé•¿

### 3. è§¦å‘æ¡ä»¶

å½“ `structured_data` ä¸­çš„å­—æ®µï¼ˆå¦‚ `design_challenge`, `project_task`ï¼‰åŒ…å«ï¼š
- é•¿æ–‡æœ¬ (>500å­—ç¬¦)
- å¤§é‡å¼•å·æˆ–ç‰¹æ®Šå­—ç¬¦
- å¤æ‚çš„ä¸­æ–‡å¥å­ç»“æ„

æ­£åˆ™å¼•æ“ä¼šå°è¯•æ‰€æœ‰å¯èƒ½çš„åŒ¹é…è·¯å¾„ï¼Œå¯¼è‡´ï¼š
- CPU 100% å ç”¨
- çº¿ç¨‹æŒ‚èµ·
- å·¥ä½œæµæ— å“åº”

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹

#### 1. ç®€åŒ–æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼

**ä¿®æ”¹å‰:**
```python
CONCEPT_PATTERNS = [
    r'"([^""]{2,20})"',
    r'"([^"]{2,20})"',
    r'(?:å…·å¤‡|å®ç°|æ‰“é€ |åˆ›å»º|è®¾è®¡)(?:ä¸€ä¸ª)?[ã€Œ"""]?([^ï¼Œã€‚,.\s""]{2,15})[ã€"""]?(?:çš„|å±æ€§|åŠŸèƒ½|ç‰¹æ€§)',
    r'(?:è¦æ±‚|éœ€è¦|å¸Œæœ›)[^ï¼Œã€‚]{0,10}([^ï¼Œã€‚,.\s""]{2,15})(?:çš„|å±æ€§|åŠŸèƒ½)',
]
```

**ä¿®æ”¹å:**
```python
# ğŸ”¥ v7.4.2: ç®€åŒ–æ­£åˆ™æ¨¡å¼ï¼Œé¿å…ç¾éš¾æ€§å›æº¯
CONCEPT_PATTERNS = [
    r'"([^""]{2,15})"',  # é™åˆ¶é•¿åº¦åˆ°15
    r'"([^"]{2,15})"',
    r'ã€Œ([^ã€]{2,15})ã€',
    r'ã€([^ã€‘]{2,15})ã€‘',
    # ç§»é™¤å¤æ‚çš„åŠ¨è¯+æ¦‚å¿µæ¨¡å¼
]
```

**æ”¹è¿›:**
- âœ… ç§»é™¤åµŒå¥—é‡è¯å’Œå¯é€‰åˆ†ç»„
- âœ… å‡å°‘åŒ¹é…é•¿åº¦ (20 â†’ 15)
- âœ… ç§»é™¤å¤æ‚çš„åŠ¨è¯+æ¦‚å¿µæ¨¡å¼

#### 2. æ›´ä¸¥æ ¼çš„æ–‡æœ¬é•¿åº¦é™åˆ¶

**ä¿®æ”¹å‰:**
```python
safe_text = text[:2000] if len(text) > 2000 else text
safe_challenge = design_challenge[:500] if len(design_challenge) > 500 else design_challenge
```

**ä¿®æ”¹å:**
```python
# è¾“å…¥æ–‡æœ¬
safe_text = text[:500] if len(text) > 500 else text  # 2000 â†’ 500

# structured_data å­—æ®µ
if len(structured_data[key]) > 300:  # 500 â†’ 300
    structured_data[key] = structured_data[key][:300]
```

**æ”¹è¿›:**
- âœ… è¾“å…¥æ–‡æœ¬é™åˆ¶: 2000 â†’ 500 å­—ç¬¦
- âœ… ç»“æ„åŒ–å­—æ®µé™åˆ¶: 500 â†’ 300 å­—ç¬¦
- âœ… æ·»åŠ æ›´å¤šå­—æ®µé™åˆ¶ (character_narrative, core_tension)

#### 3. é™åˆ¶åŒ¹é…æ¬¡æ•°

**ä¿®æ”¹å‰:**
```python
matches = re.findall(pattern, safe_text)
concepts.extend(matches)
```

**ä¿®æ”¹å:**
```python
matches = re.findall(pattern, safe_text[:500])  # åªåœ¨å‰500å­—ç¬¦åŒ¹é…
concepts.extend(matches[:5])  # æ¯ä¸ªæ¨¡å¼æœ€å¤šå–5ä¸ª
```

**æ”¹è¿›:**
- âœ… é™åˆ¶åŒ¹é…èŒƒå›´åˆ°å‰500å­—ç¬¦
- âœ… æ¯ä¸ªæ¨¡å¼æœ€å¤šå–5ä¸ªç»“æœ
- âœ… æ€»å¤„ç†æ•°é‡é™åˆ¶åˆ°20ä¸ª

#### 4. æ·»åŠ ç±»å‹æ£€æŸ¥å’Œå¼‚å¸¸å¤„ç†

**ä¿®æ”¹å:**
```python
if design_challenge and isinstance(design_challenge, str):
    safe_challenge = design_challenge[:300]
    try:
        bracket_matches = re.findall(r'\[([^\]]{2,15})\]', safe_challenge)
        concepts.extend(bracket_matches[:5])
    except Exception as e:
        logger.warning(f"âš ï¸ Error extracting from design_challenge: {e}")
```

**æ”¹è¿›:**
- âœ… æ·»åŠ ç±»å‹æ£€æŸ¥ (`isinstance`)
- âœ… æ·»åŠ å¼‚å¸¸æ•è·
- âœ… è®°å½•è­¦å‘Šæ—¥å¿—

---

## ä¿®å¤æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. **[intelligent_project_analyzer/interaction/questionnaire/context.py](intelligent_project_analyzer/interaction/questionnaire/context.py)**
   - ä¿®æ”¹ `CONCEPT_PATTERNS` (ç¬¬82-90è¡Œ)
   - ä¿®æ”¹ `extract()` æ–¹æ³• (ç¬¬109-123è¡Œ)
   - ä¿®æ”¹ `_extract_keywords_simple()` æ–¹æ³• (ç¬¬221-265è¡Œ)
   - ä¿®æ”¹ `_identify_domain()` æ–¹æ³• (ç¬¬267-306è¡Œ)
   - ä¿®æ”¹ `_extract_core_concepts()` æ–¹æ³• (ç¬¬308-368è¡Œ)

### æ–°å¢çš„æ–‡ä»¶

2. **[debug_keyword_extractor.py](debug_keyword_extractor.py)**
   - è°ƒè¯•è„šæœ¬ï¼Œç”¨äºé‡ç°å’Œæµ‹è¯•é—®é¢˜

3. **[BUG_FIX_REGEX_TIMEOUT.md](BUG_FIX_REGEX_TIMEOUT.md)**
   - æœ¬æ–‡æ¡£

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ–¹æ³•

1. **å•å…ƒæµ‹è¯•** (ä½¿ç”¨ debug_keyword_extractor.py)
   ```bash
   python debug_keyword_extractor.py
   ```

   **é¢„æœŸç»“æœ:**
   ```
   âœ… KeywordExtractor.extract() completed in <1.0s
   ```

2. **é›†æˆæµ‹è¯•** (å®Œæ•´å·¥ä½œæµ)
   - æäº¤è®¾è®¡éœ€æ±‚
   - è§‚å¯Ÿ `calibration_questionnaire` èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸é€šè¿‡
   - æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "Step C: KeywordExtractor.extract() å®Œæˆ"

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹è¿› |
|------|--------|--------|------|
| æ‰§è¡Œæ—¶é—´ | >60s (è¶…æ—¶) | <0.1s | **600x+** |
| æ–‡æœ¬å¤„ç†é•¿åº¦ | 2000å­—ç¬¦ | 500å­—ç¬¦ | **4x å‡å°‘** |
| æ­£åˆ™æ¨¡å¼æ•°é‡ | 6ä¸ª | 4ä¸ª | **33% å‡å°‘** |
| åŒ¹é…ç»“æœæ•°é‡ | æ— é™åˆ¶ | æœ€å¤š20ä¸ª | **å¯æ§** |

---

## åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸ (P1)

1. **æ·»åŠ è¶…æ—¶ä¿æŠ¤**
   - ä½¿ç”¨ `threading.Timer` æˆ– `signal.alarm` (Linux)
   - å¦‚æœ `extract()` è¶…è¿‡ 5ç§’ï¼Œå¼ºåˆ¶è¿”å›ç©ºç»“æœ

2. **æ·»åŠ ç›‘æ§æŒ‡æ ‡**
   - è®°å½• `extract()` æ‰§è¡Œæ—¶é—´
   - ç»Ÿè®¡è¶…æ—¶æ¬¡æ•°
   - å‘é€å‘Šè­¦

### ä¸­æœŸ (P2)

3. **æ›¿æ¢æ­£åˆ™è¡¨è¾¾å¼**
   - ä½¿ç”¨ `jieba` åˆ†è¯ (æ›´å¯é )
   - ä½¿ç”¨ NLP åº“ (å¦‚ `spaCy`) æå–å…³é”®è¯
   - ä½¿ç”¨ LLM æå–æ ¸å¿ƒæ¦‚å¿µ (æ›´å‡†ç¡®)

4. **ä¼˜åŒ–ç¼“å­˜ç­–ç•¥**
   - ä½¿ç”¨ Redis ç¼“å­˜æå–ç»“æœ
   - æ·»åŠ  TTL (1å°æ—¶)
   - å‡å°‘é‡å¤è®¡ç®—

### é•¿æœŸ (P3)

5. **é‡æ„ KeywordExtractor**
   - åˆ†ç¦»å…³æ³¨ç‚¹ (é¢†åŸŸè¯†åˆ« / å…³é”®è¯æå– / æ¦‚å¿µæå–)
   - ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ”¯æŒå¤šç§æå–æ–¹æ³•
   - æ·»åŠ å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–

---

## å›å½’æµ‹è¯•æ¸…å•

- [ ] æäº¤ç®€å•éœ€æ±‚ (50å­—ä»¥å†…)
- [ ] æäº¤ä¸­ç­‰éœ€æ±‚ (200å­—)
- [ ] æäº¤å¤æ‚éœ€æ±‚ (500å­—+)
- [ ] æäº¤åŒ…å«å¤§é‡å¼•å·çš„éœ€æ±‚
- [ ] æäº¤åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„éœ€æ±‚
- [ ] æ£€æŸ¥æ‰€æœ‰ä¼šè¯æ˜¯å¦æ­£å¸¸å®Œæˆ
- [ ] æ£€æŸ¥ Redis ä¸­æ— å¡ä½çš„ä¼šè¯
- [ ] æ£€æŸ¥æ—¥å¿—ä¸­æ— æ­£åˆ™é”™è¯¯

---

## ç›¸å…³é“¾æ¥

- **Issue:** #XXX (å¾…åˆ›å»º)
- **Commit:** (å¾…æäº¤)
- **è¯Šæ–­æŠ¥å‘Š:** [DIAGNOSTIC_REPORT.md](DIAGNOSTIC_REPORT.md)
- **æµ‹è¯•è„šæœ¬:** [debug_keyword_extractor.py](debug_keyword_extractor.py)

---

## æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**æ­£åˆ™è¡¨è¾¾å¼æ€§èƒ½é—®é¢˜**ï¼Œç”±å¤æ‚çš„æ¨¡å¼å’Œé•¿æ–‡æœ¬è¾“å…¥å¯¼è‡´ã€‚ä¿®å¤æ–¹æ¡ˆé€šè¿‡ï¼š

1. âœ… ç®€åŒ–æ­£åˆ™æ¨¡å¼
2. âœ… ä¸¥æ ¼é™åˆ¶æ–‡æœ¬é•¿åº¦
3. âœ… é™åˆ¶åŒ¹é…æ¬¡æ•°
4. âœ… æ·»åŠ å¼‚å¸¸å¤„ç†

å°†æ‰§è¡Œæ—¶é—´ä» **>60ç§’** é™ä½åˆ° **<0.1ç§’**ï¼Œå½»åº•è§£å†³äº†å·¥ä½œæµå¡é¡¿é—®é¢˜ã€‚

**ä¿®å¤çŠ¶æ€:** âœ… å·²å®Œæˆ
**éœ€è¦é‡å¯æœåŠ¡:** âœ… æ˜¯ (ä¿®æ”¹äº†æ ¸å¿ƒä»£ç )
