# 📚 文档更新协议

**创建日期：** 2025-12-11
**版本：** v1.0
**目的：** 建立系统化的文档更新机制，确保每次修改都有迹可循，避免重复犯错

---

## 🎯 核心原则

### 1. 迭代思维

> **每次走过的弯路不要再走，修复的bug不要再出现问题**

- 每次修改都是学习机会
- 记录问题的根因，而不只是症状
- 记录修复方案，而不只是代码变更
- 记录防范措施，避免再次犯错

### 2. 文档即记忆

> **文档不是负担，而是团队资产**

- 今天的文档，是明天的参考
- 完善的文档，避免重复劳动
- 系统化的文档，建立知识库

### 3. 强制更新

> **修改代码必须更新文档，没有例外**

- 代码变更 = 文档更新
- 问题修复 = 历史记录
- 新增功能 = 规范补充

---

## 📁 核心文档体系

### 1. 开发规范文档

**文件：** [.github/DEVELOPMENT_RULES.md](.github/DEVELOPMENT_RULES.md)

**内容：**
- 代码复用规则
- 数据格式契约
- 前后端规范
- **历史问题追踪**（最重要！）
- TypeScript/ESLint 规范
- LLM 提示词规范
- 问卷系统规范

**更新时机：**
- ✅ 每次修复问题后
- ✅ 每次发现新的陷阱后
- ✅ 每次建立新的规范后

### 2. 变更前检查清单

**文件：** [.github/PRE_CHANGE_CHECKLIST.md](.github/PRE_CHANGE_CHECKLIST.md)

**内容：**
- 修改前必读文档
- 修改前检查项
- **修改后必做：文档更新**（强制）
- 禁止事项

**使用时机：**
- ✅ 每次修改代码前
- ✅ 每次提交代码前

### 3. 项目架构文档

**文件：** [CLAUDE.md](CLAUDE.md)

**内容：**
- 项目概述
- 技术栈
- 开发命令
- 架构概览
- 目录结构
- 常见陷阱

**更新时机：**
- ✅ 架构变更时
- ✅ 新增模块时
- ✅ 工作流变更时

### 4. 修复记录文档

**文件：** `BUG_FIX_*.md`, `QUALITY_*.md`, `DIAGNOSTIC_*.md`

**内容：**
- 问题症状
- 根本原因
- 修复方案
- 测试计划
- 效果对比

**创建时机：**
- ✅ 重大问题修复后
- ✅ 质量问题诊断后
- ✅ 性能优化后

---

## 🔄 文档更新流程

### 步骤1：修改代码前

1. **阅读相关文档**
   - [ ] 阅读 [DEVELOPMENT_RULES.md](.github/DEVELOPMENT_RULES.md)
   - [ ] 检查「历史问题追踪」章节
   - [ ] 阅读 [PRE_CHANGE_CHECKLIST.md](.github/PRE_CHANGE_CHECKLIST.md)

2. **搜索类似问题**
   - [ ] 在 `DEVELOPMENT_RULES.md` 中搜索关键词
   - [ ] 在 `BUG_FIX_*.md` 文件中搜索
   - [ ] 在代码注释中搜索版本标记

3. **评估影响范围**
   - [ ] 搜索所有调用点
   - [ ] 评估是否影响其他模块
   - [ ] 考虑向后兼容性

### 步骤2：修改代码

1. **添加版本标记**
   ```python
   # 🔥 v7.5.0: 修复Pydantic模型类型不匹配
   # ✅ v7.4.3: 修复变量作用域错误
   ```

2. **添加必要注释**
   - 说明修改的原因
   - 说明修改的影响
   - 引用相关文档

3. **遵循代码规范**
   - 使用统一的格式化函数
   - 遵循类型标注要求
   - 遵循命名规范

### 步骤3：修改代码后（强制）

#### A. 更新 DEVELOPMENT_RULES.md

**位置：** 第8章「历史问题追踪」

**模板：**
```markdown
#### 问题 X.X.X：问题简短描述

**症状**：
- 用户看到的现象
- 日志中的错误信息

**根因**：
- 问题的根本原因
- 为什么会出现这个问题

**修复方案 (vX.X.X)**：
```代码示例```

**效果**：修复前后的对比数据（如果有）

**涉及文件**：
- `path/to/file.py` (第X行)
- `path/to/file.tsx` (第Y行)

**防范措施**：
- 如何避免再次出现
- 相关的检查项
```

**更新步骤：**
1. 在对应章节添加新的问题记录
2. 更新「更新记录」表格
3. 如果是新类型的问题，创建新的子章节

#### B. 创建修复文档（重大问题）

**文件命名：**
- `BUG_FIX_vX.X.X.md` - Bug修复
- `QUALITY_FIX_*.md` - 质量问题修复
- `DIAGNOSTIC_*.md` - 问题诊断报告

**内容结构：**
1. 问题描述（症状、影响范围）
2. 根本原因分析
3. 修复方案（详细代码示例）
4. 测试计划
5. 效果对比
6. 后续优化建议

#### C. 更新相关专题文档

**场景1：修改了 API**
- 更新 API 文档
- 更新前端类型定义
- 更新后端 Pydantic 模型

**场景2：修改了数据模型**
- 更新数据契约文档
- 更新 TypeScript 类型
- 更新 Pydantic 模型

**场景3：修改了工作流**
- 更新 [CLAUDE.md](CLAUDE.md)
- 更新架构图（如果有）
- 更新节点说明

### 步骤4：测试验证

1. **单元测试**
   ```bash
   # 前端
   cd frontend-nextjs && npm test

   # 后端
   python -m pytest tests/ -v
   ```

2. **集成测试**
   ```bash
   python tests/test_workflow_fix.py
   ```

3. **回归测试**
   - 确保没有破坏已有功能
   - 测试边界情况
   - 测试性能影响

### 步骤5：Git 提交

1. **提交信息规范**
   ```
   feat(module): 简短描述修改内容

   - 详细描述修改的内容
   - 修复的问题
   - 影响的范围

   Fixes #123
   ```

2. **提交内容检查**
   - [ ] 代码已通过测试
   - [ ] 文档已更新
   - [ ] 没有调试语句
   - [ ] 没有未完成的 TODO

---

## 📊 文档更新检查清单

### 每次修改必须完成

- [ ] ✅ 代码已添加版本标记和注释
- [ ] ✅ **DEVELOPMENT_RULES.md 已更新**
- [ ] ✅ 创建了修复文档（如果是重大问题）
- [ ] ✅ 更新了相关专题文档
- [ ] ✅ 测试验证通过
- [ ] ✅ Git 提交信息规范

---

## 🎓 今日修复记录（2025-12-11）

### 修复1：工作流卡顿问题 (v7.4.3)

**问题：** 工作流在 calibration_questionnaire 节点卡住
**根因：** 变量作用域错误
**修复：** 将 `user_input` 定义移到所有代码块之前
**文档：**
- ✅ 已更新 DEVELOPMENT_RULES.md (问题 8.0.1)
- ✅ 已创建 BUG_FIX_V7.4.3.md

### 修复2：专家输出验证失败 (v7.5.0)

**问题：** Pydantic模型类型不匹配，触发降级策略
**根因：** `content: str` 但LLM返回 `dict`
**修复：** 使用 `Union[str, Dict]` 并添加 `@validator` 自动序列化
**效果：** 验证成功率从60%提升到95%
**文档：**
- ✅ 已更新 DEVELOPMENT_RULES.md (问题 8.0.2)
- ✅ 已创建 QUALITY_ISSUES_DIAGNOSIS.md
- ✅ 已创建 QUALITY_FIX_SUMMARY.md

### 建立的文档机制

1. ✅ 更新了 DEVELOPMENT_RULES.md，添加「重要原则」说明
2. ✅ 更新了 PRE_CHANGE_CHECKLIST.md，强调文档更新的强制性
3. ✅ 创建了 DOCUMENTATION_UPDATE_PROTOCOL.md（本文档）

---

## 🚀 后续行动

### 短期（立即执行）

1. **重启后端服务**
   ```bash
   python -B -m uvicorn intelligent_project_analyzer.api.server:app --host 0.0.0.0 --port 8000
   ```

2. **测试修复效果**
   - 提交新的设计需求
   - 观察专家输出验证日志
   - 检查前端报告显示

3. **监控指标**
   - 验证成功率
   - 降级策略使用次数
   - 交付物缺失警告

### 中期（持续执行）

1. **每次修改都更新文档**
   - 遵循本协议的流程
   - 记录问题和修复方案
   - 添加防范措施

2. **定期回顾文档**
   - 每周回顾历史问题追踪
   - 总结常见问题模式
   - 优化开发规范

3. **持续改进**
   - 根据实际情况调整流程
   - 补充新的规范和陷阱
   - 完善文档体系

---

## 📞 联系方式

**维护者：** AI Assistant
**最后更新：** 2025-12-11
**版本：** v1.0

**反馈渠道：**
- 在 DEVELOPMENT_RULES.md 中添加新的问题记录
- 在 PRE_CHANGE_CHECKLIST.md 中补充检查项
- 创建新的专题文档

---

## 📖 相关文档

- [DEVELOPMENT_RULES.md](.github/DEVELOPMENT_RULES.md) - 开发规范
- [PRE_CHANGE_CHECKLIST.md](.github/PRE_CHANGE_CHECKLIST.md) - 变更前检查清单
- [CLAUDE.md](CLAUDE.md) - 项目架构文档
- [README.md](README.md) - 项目说明
- [BUG_FIX_V7.4.3.md](BUG_FIX_V7.4.3.md) - 工作流卡顿修复
- [QUALITY_ISSUES_DIAGNOSIS.md](QUALITY_ISSUES_DIAGNOSIS.md) - 质量问题诊断
- [QUALITY_FIX_SUMMARY.md](QUALITY_FIX_SUMMARY.md) - 质量修复总结
