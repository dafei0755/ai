# 任务审批界面搜索和概念图配置修复 - 快速验证指南

## 修复完成状态

✅ **所有修改已完成并通过单元测试**

## 快速验证步骤

### 步骤1：重启服务器（重要）

修改了后端Python代码，需要重启服务器以加载新代码：

```bash
# Windows
kill_python.bat
start_server_py313.bat

# 或者
python run_server_production.py
```

### 步骤2：创建新会话测试

1. 访问前端应用
2. 创建新的分析会话
3. 选择 **普通模式 (normal)**
4. 完成问卷步骤
5. 进入 **任务审批界面**

### 步骤3：验证UI显示

在任务审批界面，检查每个交付物是否显示以下内容：

#### ✅ 应该显示的内容：

**1. 搜索指令区域**
- 🔍 紫色Search图标
- "搜索指令:" 标签
- 3个编号的搜索查询输入框（可编辑）
- 示例：
  ```
  🔍 搜索指令:
  1. [整体设计方案 设计案例]
  2. [整体设计方案 最佳实践]
  3. [整体设计方案 研究资料]
  ```

**2. 概念图配置区域**
- 🖼️ 绿色ImageIcon图标
- "概念图配置:" 标签
- "生成数量: 1 张 (普通模式不可修改)"
- 如果是深度思考模式，应显示可编辑的数量（1-10张）

**3. 概念图方向设置（项目级）**
- 🖼️ "概念图方向（适用于所有交付物）"
- 下拉选择框（16:9, 9:16, 1:1, 4:3, 21:9）

### 步骤4：检查后端日志

在服务器日志中查找以下关键信息：

**成功匹配日志**：
```
🔍 [交付物匹配] 角色: V2_设计总监_2-1 (标准化: 2-1)
  🔎 正在匹配交付物: 整体设计方案
  ✅ 精确匹配成功: 2-1_1_143022_abc (owner: V2_设计总监_2-1)
  📦 已添加交付物: 2-1_1_143022_abc
    - 搜索查询数: 3
    - 概念图配置: {'count': 1, 'editable': False, 'max_count': 1}
```

**降级匹配日志（如果出现）**：
```
  ⚠️ 精确匹配失败，尝试按名称匹配
  ⚠️ 降级匹配成功（仅名称）: 2-1_1_143022_abc
    - 期望角色: 2-1
    - 实际角色: 3-1
```

**失败日志（不应该出现）**：
```
  ❌ 所有匹配尝试失败，创建默认配置
```

### 步骤5：功能测试

1. **编辑搜索查询**
   - 点击"修改任务"按钮
   - 修改搜索查询内容
   - 点击"保存并继续"
   - 检查修改是否保存

2. **调整概念图数量**（仅深度思考模式）
   - 切换到深度思考模式创建新会话
   - 在任务审批界面调整概念图数量（1-10）
   - 保存并验证

3. **修改概念图方向**
   - 选择不同的宽高比（16:9, 1:1等）
   - 保存并验证

## 常见问题排查

### Q1: 仍然看不到搜索查询和概念图配置

**可能原因**：
1. 服务器未重启 → 重启服务器
2. 使用的是旧会话 → 创建新会话测试
3. `search_query_generator_node` 未执行 → 检查工作流日志

**排查步骤**：
```bash
# 检查日志中是否有以下内容：
grep "search_query_generator" logs/server.log
grep "交付物匹配" logs/server.log
```

### Q2: 只看到部分交付物的配置

**可能原因**：
- 部分交付物匹配失败但降级方案未生效

**排查步骤**：
- 查看日志中的"⚠️ 降级匹配"或"❌ 所有匹配尝试失败"
- 检查 `deliverable_metadata` 是否包含所有交付物

### Q3: 看到"默认配置"的搜索查询

**特征**：
- 搜索查询格式为："{交付物名称} 设计案例"
- 概念图数量固定为1张

**说明**：
- 这是兜底方案，说明精确匹配和降级匹配都失败了
- 检查日志中的"❌ 所有匹配尝试失败"记录
- 查看 `deliverable_metadata` 的 owner_role 字段格式

## 验证检查清单

### 后端验证
- [ ] 服务器已重启
- [ ] 日志显示"✅ 精确匹配成功"（或"⚠️ 降级匹配"）
- [ ] 每个角色的 `role_deliverables` 非空
- [ ] 每个deliverable包含3个搜索查询
- [ ] 每个deliverable包含concept_image_config

### 前端验证
- [ ] 任务审批界面显示"搜索指令"区域（紫色Search图标）
- [ ] 任务审批界面显示"概念图配置"区域（绿色ImageIcon图标）
- [ ] 搜索查询可以编辑（修改任务模式下）
- [ ] 概念图数量显示正确（普通=1张不可编辑）
- [ ] 项目级概念图方向选择框可见

### 功能验证
- [ ] 可以修改搜索查询并保存
- [ ] 可以修改概念图方向并保存
- [ ] 深度思考模式可以调整概念图数量（1-10）
- [ ] 修改后的配置正确传递到后续节点

## 回滚方案（如果修复失败）

如果修复导致问题，可以回滚到修复前版本：

```bash
git diff HEAD~1 intelligent_project_analyzer/interaction/role_task_unified_review.py
git checkout HEAD~1 intelligent_project_analyzer/interaction/role_task_unified_review.py
```

然后重启服务器。

## 成功标志

✅ **修复成功的标志**：
1. 任务审批界面完整显示所有配置项
2. 日志中无"❌ 所有匹配尝试失败"错误
3. 用户可以正常修改搜索查询和概念图配置
4. 修改后的配置正确保存并传递到专家执行阶段

## 联系支持

如果遇到问题，请提供：
1. 服务器日志（特别是"交付物匹配"相关日志）
2. 前端控制台错误（如果有）
3. 会话ID和使用的分析模式（普通/深度思考）
