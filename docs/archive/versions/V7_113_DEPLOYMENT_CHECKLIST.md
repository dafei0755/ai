# v7.113 部署验证清单 ✅

**版本**: v7.113
**部署日期**: _________
**部署人**: _________

---

## 📋 部署前检查

### 代码修改确认
- [x] **后端**: `intelligent_project_analyzer/api/server.py` (2处修改)
  - [x] Line 758-759: StructuredReportResponse 模型扩展
  - [x] Line 3313-3314: get_analysis_report 数据提取

- [x] **前端类型**: `frontend-nextjs/types/index.ts` (1处修改)
  - [x] Line 309-319: search_references 类型定义

- [x] **前端组件**:
  - [x] `frontend-nextjs/components/SearchReferences.tsx` (212行)
  - [x] `frontend-nextjs/components/ExpertSearchReferences.tsx` (260行)

- [x] **前端集成**: `frontend-nextjs/app/report/[sessionId]/page.tsx`
  - [x] Line 29: 导入 ExpertSearchReferences
  - [x] Line 912-925: 在 renderContent 中集成组件

---

## 🚀 部署步骤

### Step 1: 重启后端服务器
```bash
# 停止当前服务器（Ctrl+C）
cd d:\11-20\langgraph-design
python run_server_production.py
```

**验证点**:
- [ ] 服务器成功启动
- [ ] 看到: `INFO: Uvicorn running on http://0.0.0.0:8000`
- [ ] 无报错信息

---

### Step 2: 重启前端服务器
```bash
cd frontend-nextjs
npm run dev
```

**验证点**:
- [ ] 前端编译成功
- [ ] 看到: `Ready on http://localhost:3000`
- [ ] 无 TypeScript 错误
- [ ] 无组件导入错误

---

### Step 3: 快速验证（后端API）
```bash
python test_search_fix.py
```

**期望输出**:
```
✅ 字段验证通过: search_references 存在
   状态: 列表
   数量: X 条引用
🎉 修复验证成功！
```

**验证结果**: [ ] 通过 / [ ] 失败

---

### Step 4: 浏览器验证（前端集成）

#### 4.1 打开报告页面
1. [ ] 访问: `http://localhost:3000/report/<session-id>`
2. [ ] 页面成功加载
3. [ ] 无 Console 错误

#### 4.2 检查搜索引用章节
1. [ ] 滚动到页面底部
2. [ ] 看到分隔线（灰色虚线）
3. [ ] 看到"搜索引用"章节标题
4. [ ] 看到专家分组卡片

#### 4.3 Network验证
1. [ ] 打开开发者工具（F12）
2. [ ] 切换到 Network 标签
3. [ ] 刷新页面
4. [ ] 找到: `GET /api/analysis/report/<session-id>`
5. [ ] 点击 → Response 标签
6. [ ] 搜索: `"search_references"`
7. [ ] 确认字段存在且有数据

#### 4.4 Console验证
在浏览器 Console 中执行：
```javascript
console.log(report.structured_report?.search_references);
```

**期望结果**:
- [ ] 输出数组对象
- [ ] 每个元素包含: source_tool, title, query, deliverable_id 等字段

---

## 🧪 功能测试

### 测试场景 1: 有搜索引用的会话
**前提**: 选择一个调用了搜索工具的会话

**测试步骤**:
1. [ ] 访问报告页面
2. [ ] 滚动到底部
3. [ ] 确认显示"搜索引用"章节
4. [ ] 点击专家卡片展开/收起
5. [ ] 检查搜索工具图标显示正确（🔍🌐📚🗂️）
6. [ ] 点击外部链接，新标签打开
7. [ ] 检查移动端响应式布局

**结果**: [ ] 通过 / [ ] 失败

---

### 测试场景 2: 无搜索引用的会话
**前提**: 选择一个未调用搜索工具的会话

**测试步骤**:
1. [ ] 访问报告页面
2. [ ] 滚动到底部
3. [ ] 确认**不显示**"搜索引用"章节
4. [ ] 页面其他部分正常显示

**结果**: [ ] 通过 / [ ] 失败

---

### 测试场景 3: 多专家搜索
**前提**: 选择一个多专家各自使用搜索工具的会话

**测试步骤**:
1. [ ] 访问报告页面
2. [ ] 展开多个专家的搜索引用
3. [ ] 确认每个专家的引用正确分组
4. [ ] 确认统计数据正确（如"博查 3条"）
5. [ ] 检查是否有重复引用

**结果**: [ ] 通过 / [ ] 失败

---

## 📊 数据完整性验证

### 后端日志检查
在服务器日志中查找以下关键点：

#### 1. 搜索工具调用
```
🔍 博查搜索: query='...', count=X
✅ 博查搜索成功: 返回 X 条结果
```
- [ ] 看到搜索工具调用日志

#### 2. 工具调用记录
```
🔧 [v7.64] <role-id> 启用工具调用记录器
✅ Tool completed: bocha_search, output_length=XXX
```
- [ ] 看到工具记录日志

#### 3. 搜索引用提取
```
📚 [v7.64] 提取了 X 条搜索引用
✅ Added X new references to state (total: Y)
```
- [ ] 看到引用提取日志

#### 4. API返回
```
✅ 成功解析结构化报告，包含 X 个章节
```
- [ ] 看到报告解析成功

---

## 🔧 故障排查

### 问题 1: 字段不存在
**症状**: API响应中缺少 search_references 字段

**排查**:
- [ ] 服务器是否重启？
- [ ] server.py 修改是否保存？
- [ ] 检查 Line 758-759 和 3313-3314

**解决**: 重启服务器，重新验证

---

### 问题 2: 前端组件不显示
**症状**: 页面无"搜索引用"章节

**排查**:
- [ ] Console 是否有错误？
- [ ] 组件导入是否正确（Line 29）？
- [ ] 数据是否为空（`search_references.length === 0`）？

**解决**: 检查导入语句，查看 Console 错误

---

### 问题 3: 数据为 null 或空数组
**症状**: search_references 存在但无数据

**排查**:
- [ ] 该会话是否调用了搜索工具？
- [ ] 后端日志是否有"📚 [v7.64] 提取了 X 条搜索引用"？
- [ ] 搜索工具 API 是否配置正确？

**解决**: 运行新的分析任务，确保搜索工具正常工作

---

## ✅ 部署验证总结

### 必须通过的检查
- [ ] 后端服务器重启成功
- [ ] 前端服务器重启成功
- [ ] test_search_fix.py 验证通过
- [ ] API响应包含 search_references 字段
- [ ] 前端页面显示搜索引用章节
- [ ] 功能测试场景 1、2 通过

### 可选优化检查
- [ ] 移动端响应式测试
- [ ] 多浏览器兼容性测试（Chrome、Firefox、Safari）
- [ ] 性能测试（大量引用场景）

---

## 📝 部署记录

### 部署环境
- **后端服务器**: _________
- **前端服务器**: _________
- **Python版本**: _________
- **Node版本**: _________

### 部署结果
- **开始时间**: _________
- **结束时间**: _________
- **部署状态**: [ ] 成功 / [ ] 失败 / [ ] 部分成功

### 遇到的问题
1. _________________________________________________________
2. _________________________________________________________
3. _________________________________________________________

### 解决方案
1. _________________________________________________________
2. _________________________________________________________
3. _________________________________________________________

---

## 🎉 部署完成确认

**签字确认**:
- 开发人员: _________ 日期: _________
- 测试人员: _________ 日期: _________
- 部署人员: _________ 日期: _________

**备注**: _________________________________________________________

---

**版本**: v7.113
**文档**: V7_113_DEPLOYMENT_CHECKLIST.md
**状态**: ✅ 生产就绪
