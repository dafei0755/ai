# 任务分配逻辑修复 - 禁止平均分配

## 问题描述

之前的系统存在"平均分配"问题：
- 无论角色重要性如何，都给每个角色分配大约相同数量的任务（例如8个任务分给4个角色，每人2个）
- 导致核心角色（如V2设计总监）和支持角色（如V4研究员）承担的任务量相同
- 不符合实际项目中"核心角色承担更多责任"的原则

## 根本原因

提示词配置中缺少**任务量分配策略**的明确指导，LLM默认采用"平均分配"的方式。

## 修复方案

### 1️⃣ 配置文件修改

**文件**：`intelligent_project_analyzer/config/prompts/dynamic_project_director_v2.yaml`

**修改内容**：

#### 添加交付物数量分配策略

```yaml
### 2. deliverables (交付物清单)

**📊 交付物数量分配策略（根据角色权重灵活分配）**：

🎯 **核心角色**（权重 ≥2.5 或 V2设计总监）
- 交付物数量：**4-6个**
- 职责：承担项目的核心设计/整合任务
- 示例：V2设计总监（必选且必须承担最多任务）、主责V3专家

🔸 **重要角色**（权重 2.0-2.4）
- 交付物数量：**2-3个**
- 职责：承担关键领域的专业分析
- 示例：V3领域专家、V4研究员

🔹 **支持角色**（权重 1.5-1.9）
- 交付物数量：**1-2个**
- 职责：提供特定方面的支撑
- 示例：V4基础研究、V5场景专家

⚪ **辅助角色**（权重 <1.5）
- 交付物数量：**1个**
- 职责：仅在有明确需求时选择，聚焦单一问题
- 示例：V6实施顾问（非必需时）

**⚠️ 分配原则**：
- ❌ **禁止平均主义**：不要给所有角色分配相同数量的任务！
- ✅ **责任对等**：任务量应与角色在项目中的重要性成正比
- ✅ **核心主导**：V2设计总监和高权重V3专家应承担明显更多的交付物
- ✅ **总量合理**：整个项目的交付物总数建议12-25个
```

#### 修改"避免的问题"部分

```yaml
**🚫 避免的问题**

1. **任务模糊**: ❌"分析相关内容" ✅"分析三代同堂家庭的代际冲突与和谐共处策略"
2. **平均分配**: ❌ 给每个角色都分配2个任务 ✅ 核心角色5个任务，支持角色1-2个任务
3. **重复交付**: 确保每个角色的deliverables不重复
4. **缺少标准**: 所有deliverables必须有success_criteria
5. **依赖缺失**: 明确角色间的dependencies
6. **任务量失衡**: V2设计总监必须是任务量最多的角色（4-6个交付物）
```

---

### 2️⃣ 代码逻辑修改

**文件**：`intelligent_project_analyzer/agents/dynamic_project_director.py`

#### 修改1：`_build_user_prompt_with_weights` 方法

在用户提示词中明确任务量分配要求：

```python
📊 **任务量分配要求（重要）**：
- **禁止平均分配**：不要给每个角色分配相同数量的任务！
- **核心角色**（权重≥2.5 或 V2设计总监）：分配 **4-6个交付物**
- **重要角色**（权重2.0-2.4）：分配 **2-3个交付物**
- **支持角色**（权重1.5-1.9）：分配 **1-2个交付物**
- **辅助角色**（权重<1.5）：分配 **1个交付物**
- V2设计总监必须是任务量最多的角色
```

#### 修改2：`_generate_weight_explanation` 方法

增强权重说明，直接显示每个角色的建议任务量：

```python
def _generate_weight_explanation(self, weights: Dict[str, float]) -> str:
    # ...
    for role, weight in sorted_weights:
        # 根据权重推荐任务量
        if weight >= 2.5:
            task_recommendation = "→ 建议分配 **4-6个交付物**（核心角色）"
        elif weight >= 2.0:
            task_recommendation = "→ 建议分配 **2-3个交付物**（重要角色）"
        elif weight >= 1.5:
            task_recommendation = "→ 建议分配 **1-2个交付物**（支持角色）"
        else:
            task_recommendation = "→ 建议分配 **1个交付物**（辅助角色）"

        lines.append(f"- **{role}**: {weight:.1f} {task_recommendation}")
    # ...
```

---

## 修改效果

### 修复前（平均分配）

```
任务2-5: 健康管理中心全场景空间与公共体验总设计师 (2个任务)
- 符合医疗与健康检测流程的空间设计
- 多元套餐需求融合

任务4-1: 智慧健康中心国际案例与竞品分析研究员 (2个任务)
- 全球标杆案例的系统拆解
- 合规实践与室内体验空间形态对应关系
```

### 修复后（灵活分配）

```
任务2-5: 健康管理中心全场景空间与公共体验总设计师 (5个任务)
- 符合医疗与健康检测流程的空间设计
- 多元套餐需求融合
- 公共体验区动线优化
- 隐私分级空间规划
- 整体空间整合与协调

任务4-1: 智慧健康中心国际案例与竞品分析研究员 (1个任务)
- 全球标杆案例系统拆解与本土化适配建议
```

---

## 核心原则

1. **权重对应任务量**：
   - 权重 ≥2.5：4-6个交付物（核心）
   - 权重 2.0-2.4：2-3个交付物（重要）
   - 权重 1.5-1.9：1-2个交付物（支持）
   - 权重 <1.5：1个交付物（辅助）

2. **V2设计总监特殊规则**：
   - 无论权重多少，必须分配 **4-6个交付物**
   - 作为项目的核心整合角色，承担最多任务

3. **禁止平均主义**：
   - 不同角色的任务量应有**明显差异**
   - 核心角色的交付物数量应是支持角色的 **3-5倍**

---

## 验证方法

启动服务后提交新需求，检查：

1. V2设计总监的交付物数量是否为 4-6个
2. 高权重角色的交付物数量是否明显多于低权重角色
3. 不同角色的任务量是否有明显差异（不再是平均分配）

---

## 文件修改清单

- ✅ `intelligent_project_analyzer/config/prompts/dynamic_project_director_v2.yaml`
- ✅ `intelligent_project_analyzer/agents/dynamic_project_director.py`

---

**修改完成日期**：2025-12-08
**修复类型**：任务分配逻辑优化
**影响范围**：所有新创建的项目分析会话
