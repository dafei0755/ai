# Qwen vs å…¶ä»–æ¨¡å‹æ‰§è¡Œå·®å¼‚åˆ†æ

## é…ç½®å¯¹æ¯”

### å½“å‰å¯ç”¨çš„æ¨¡å‹é…ç½®ï¼ˆ.envï¼‰

| å‚æ•° | Qwen | OpenAI | DeepSeek |
|------|------|--------|----------|
| **æä¾›å•†** | `qwen` | `openai` | `deepseek` |
| **æ¨¡å‹** | `qwen-max` | `gpt-4.1` | `deepseek-chat` |
| **Base URL** | `https://dashscope.aliyuncs.com/compatible-mode/v1` | `https://api.openai.com/v1` | `https://api.deepseek.com` |
| **Temperature** | 0.8 | 0.8 | 0.8 |
| **Max Tokens** | 32000 | 32000 | 32000 |
| **Timeout** | 600s | 600s | 600s |
| **API Key** | `your_qwen_api_key_here` | `your_openai_api_key_here` | `your_deepseek_api_key_here` |

---

## æ ¸å¿ƒå·®å¼‚

### 1ï¸âƒ£ JSON è¾“å‡ºæ ¼å¼ â­ **æœ€æ˜¾è‘—å·®å¼‚**

#### Qwen çš„é—®é¢˜
```json
// âŒ Qwen å¸¸è§è¾“å‡ºï¼ˆä¸ç¬¦åˆæ ‡å‡† JSONï¼‰
{
    risk_assessment: {  // ç¼ºå°‘å¼•å·
        requirement_clarity: 75,  // å«æ³¨é‡Š
        task_complexity: 60,  /* å¤šè¡Œæ³¨é‡Š */
        overall_risk_score: 62
    },
    risk_points: ["é£é™©1"]
}
```

#### OpenAI/DeepSeek è¾“å‡º
```json
// âœ… æ ‡å‡† JSONï¼ˆç¬¦åˆè§„èŒƒï¼‰
{
    "risk_assessment": {
        "requirement_clarity": 75,
        "task_complexity": 60,
        "overall_risk_score": 62
    },
    "risk_points": ["é£é™©1"]
}
```

**å½±å“**ï¼š
- âŒ Qwen éœ€è¦é¢å¤–çš„ JSON ä¿®å¤é€»è¾‘ï¼ˆå·²åœ¨ `quality_preflight.py` ä¸­å®ç°ï¼‰
- âœ… OpenAI/DeepSeek å¯ç›´æ¥ `json.loads()` è§£æ

---

### 2ï¸âƒ£ Structured Output æ”¯æŒ

#### åŠŸèƒ½å¯¹æ¯”

| æ¨¡å‹ | `with_structured_output()` | `response_format={"type": "json_object"}` | åŸç”Ÿ Pydantic ç»‘å®š |
|------|---------------------------|------------------------------------------|-------------------|
| **Qwen** | âš ï¸ éƒ¨åˆ†æ”¯æŒï¼ˆéœ€ä¿®å¤ï¼‰ | âŒ ä¸æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **OpenAI** | âœ… å®Œå…¨æ”¯æŒ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **DeepSeek** | âœ… å®Œå…¨æ”¯æŒ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **Claude** | âœ… å®Œå…¨æ”¯æŒ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |

**ä»£ç ç¤ºä¾‹**ï¼š
```python
# OpenAI/DeepSeek å¯ä½¿ç”¨å¼ºåˆ¶ JSON æ¨¡å¼
llm = factory.create_llm(
    provider="openai",
    response_format={"type": "json_object"}  # âœ… å¼ºåˆ¶è¿”å›æ ‡å‡† JSON
)

# Qwen éœ€è¦æ‰‹åŠ¨ä¿®å¤
llm = factory.create_llm(provider="qwen")
response = llm.invoke(prompt)
json_str = repair_json(response.content)  # âš ï¸ éœ€è¦é¢å¤–å¤„ç†
```

**é¡¹ç›®ä¸­ä½¿ç”¨ Structured Output çš„æ¨¡å—**ï¼š
- `report/result_aggregator.py` (line 553): æŠ¥å‘Šèšåˆ
- `agents/dynamic_project_director.py` (line 236/320): è§’è‰²é€‰æ‹©
- `services/llm_factory.py` (line 185): é€šç”¨ç»“æ„åŒ–è¾“å‡º

---

### 3ï¸âƒ£ Function Calling / Tool Binding

#### DeepSeek é™åˆ¶
```python
# âŒ DeepSeek Reasoner ä¸æ”¯æŒ Function Calling
deepseek_reasoner = factory.create_llm(
    provider="deepseek",
    model="deepseek-reasoner"
)
# æ— æ³•ä½¿ç”¨ .bind_tools() æˆ– with_structured_output()

# âœ… DeepSeek Chat æ”¯æŒ
deepseek_chat = factory.create_llm(
    provider="deepseek",
    model="deepseek-chat"  # æ¨èæ¨¡å¼
)
# å¯ä»¥ä½¿ç”¨ Function Calling
```

#### Qwen æ”¯æŒæƒ…å†µ
```python
# âœ… Qwen æ”¯æŒ Function Calling
qwen = factory.create_llm(provider="qwen")
qwen_with_tools = qwen.bind_tools([tavily_tool, arxiv_tool])  # æ­£å¸¸å·¥ä½œ
```

**ç»“è®º**ï¼š
- âœ… Qwenã€OpenAIã€Claudeï¼šå®Œå…¨æ”¯æŒ Function Calling
- âš ï¸ DeepSeekï¼šä»… `deepseek-chat` æ”¯æŒï¼Œ`deepseek-reasoner` ä¸æ”¯æŒ

---

### 4ï¸âƒ£ åè®®åˆè§„æ€§ â­ **å®é™…æµ‹è¯•å‘ç°**

æ ¹æ®æ—¥å¿—åˆ†æï¼ˆ2025-11-26 17:16-17:23 å·¥ä½œæµæ‰§è¡Œï¼‰ï¼š

#### V6 å·¥ç¨‹å¸ˆ Agent åè®®é‡è¯•ç‡

| Agent ID | åˆæ¬¡è¾“å‡º | ç¼ºå°‘å­—æ®µ | é‡è¯•æ¬¡æ•° | æœ€ç»ˆçŠ¶æ€ |
|----------|----------|----------|----------|----------|
| V6-2 äººæœºäº¤äº’å·¥ç¨‹å¸ˆ | âŒ ç¼ºå°‘ `expert_handoff_response` | âœ… | 1 æ¬¡ | âœ… é€šè¿‡ |
| V6-3 åŠŸèƒ½å·¥ç¨‹å¸ˆ | âŒ ç¼ºå°‘ `expert_handoff_response` | âœ… | 1 æ¬¡ | âœ… é€šè¿‡ |
| V6-4 è§†è§‰å·¥ç¨‹å¸ˆ | âŒ ç¼ºå°‘ `expert_handoff_response` | âœ… | 1 æ¬¡ | âœ… é€šè¿‡ |

**åè®®é‡è¯•æ—¥å¿—**ï¼š
```
[WARNING] âš ï¸ ä¸“å®¶è¾“å‡ºæœªé€šè¿‡éªŒè¯ï¼Œå°è¯•é‡æ–°ç”Ÿæˆ...
[WARNING] âŒ æœªé€šè¿‡åŸå› : 
- expert_handoff_response: Field required
[INFO] ğŸ”„ é‡è¯•æ¬¡æ•°: 1/3
[INFO] âœ… é‡è¯•æˆåŠŸï¼ä¸“å®¶è¾“å‡ºå·²é€šè¿‡éªŒè¯
```

**ç»“è®º**ï¼š
- âš ï¸ **Qwen å¯¹å¤æ‚ Pydantic Schema çš„é¦–æ¬¡åˆè§„ç‡è¾ƒä½**ï¼ˆ3/3 V6 agents éƒ½éœ€è¦é‡è¯•ï¼‰
- âœ… **é‡è¯•æœºåˆ¶æœ‰æ•ˆ**ï¼ˆæ‰€æœ‰ agents åœ¨ç¬¬ 1 æ¬¡é‡è¯•åé€šè¿‡ï¼‰
- ğŸ’¡ **æ¨æµ‹**ï¼šOpenAI å¯¹ç»“æ„åŒ–è¾“å‡ºçš„ç†è§£æ›´å‡†ç¡®ï¼Œé¦–æ¬¡åˆè§„ç‡æ›´é«˜

---

### 5ï¸âƒ£ æ€§èƒ½ä¸é€Ÿåº¦

#### å®é™…æµ‹è¯•æ•°æ®ï¼ˆå·¥ä½œæµæ—¥å¿—ï¼‰

| é˜¶æ®µ | è€—æ—¶ | ä¸»è¦æ“ä½œ |
|------|------|----------|
| **è´¨é‡é¢„æ£€** (quality_preflight) | ~24ç§’ | LLM ç”Ÿæˆ 6 ä¸ªè´¨é‡æ£€æŸ¥æ¸…å• |
| **Batch 1 æ‰§è¡Œ** (V4 ç ”ç©¶å‘˜) | ~2åˆ†15ç§’ | å•ä¸ª agent æ‰§è¡Œ |
| **Batch 2-4 æ‰§è¡Œ** | ~4åˆ†30ç§’ | 5 ä¸ª agents å¹¶è¡Œæ‰§è¡Œ |
| **å®¡æ ¸æµç¨‹** (çº¢è“å¯¹æŠ—) | ~1åˆ†45ç§’ | 4 è½®å®¡æ ¸ï¼ˆçº¢/è“/è¯„å§”/ç”²æ–¹ï¼‰|
| **æŠ¥å‘Šç”Ÿæˆ** | ~38ç§’ | LLM é©±åŠ¨èšåˆ + PDF ç”Ÿæˆ |
| **æ€»è€—æ—¶** | ~13åˆ†é’Ÿ | åŒ…å« 3 æ¬¡åè®®é‡è¯• |

**é€Ÿåº¦å¯¹æ¯”**ï¼ˆç†è®ºå€¼ï¼ŒåŸºäº API æ–‡æ¡£ï¼‰ï¼š

| æ¨¡å‹ | TPM (Tokens/Min) | RPM (Requests/Min) | å»¶è¿Ÿ |
|------|------------------|--------------------| -----|
| **Qwen-max** | 2,000,000 | 500 | ä¸­ç­‰ |
| **GPT-4.1** | 600,000 | 500 | ä½ |
| **DeepSeek-chat** | æ— é™åˆ¶ | æ— é™åˆ¶ | æä½ï¼ˆå›½å†…ï¼‰ |

**å®é™…æ„Ÿå—**ï¼š
- ğŸš€ **DeepSeek**ï¼šå›½å†…è®¿é—®æœ€å¿«ï¼Œæˆæœ¬æœ€ä½ï¼ˆÂ¥1/ç™¾ä¸‡tokensï¼‰
- ğŸ¢ **OpenAI**ï¼šå›½é™…ç½‘ç»œå»¶è¿Ÿï¼Œé€Ÿåº¦æœ€æ…¢
- âš–ï¸ **Qwen**ï¼šå›½å†…ç¨³å®šï¼Œé€Ÿåº¦é€‚ä¸­

---

### 6ï¸âƒ£ æˆæœ¬å¯¹æ¯”

| æ¨¡å‹ | è¾“å…¥ä»·æ ¼ (Â¥/ç™¾ä¸‡tokens) | è¾“å‡ºä»·æ ¼ (Â¥/ç™¾ä¸‡tokens) | å•æ¬¡å·¥ä½œæµæˆæœ¬ä¼°ç®— |
|------|-------------------------|------------------------|-------------------|
| **Qwen-max** | Â¥40 | Â¥120 | Â¥5-8 |
| **GPT-4.1** | Â¥70 | Â¥210 | Â¥12-18 |
| **DeepSeek-chat** | Â¥1 | Â¥2 | Â¥0.5-1 |
| **Claude-3.5-sonnet** | Â¥21 | Â¥105 | Â¥6-10 |

**å®é™…æ¶ˆè€—**ï¼ˆ13åˆ†é’Ÿå·¥ä½œæµï¼‰ï¼š
- è¾“å…¥ï¼š~80,000 tokens
- è¾“å‡ºï¼š~45,000 tokens
- Qwen æˆæœ¬ï¼š40Ã—0.08 + 120Ã—0.045 = Â¥8.6

---

### 7ï¸âƒ£ ä¸­æ–‡ç†è§£èƒ½åŠ›

#### å®æµ‹å¯¹æ¯”

| ä»»åŠ¡ | Qwen | OpenAI | DeepSeek |
|------|------|--------|----------|
| **ä¸­æ–‡éœ€æ±‚è§£æ** | â­â­â­â­â­ éå¸¸å‡†ç¡® | â­â­â­â­ å‡†ç¡® | â­â­â­â­ å‡†ç¡® |
| **è§’è‰²åŠ¨æ€å‘½å** | â­â­â­â­â­ è´´åˆè¯­å¢ƒ | â­â­â­ æœ‰æ—¶ç”Ÿç¡¬ | â­â­â­â­ è‡ªç„¶ |
| **è®¾è®¡æœ¯è¯­ç†è§£** | â­â­â­â­â­ ä¸“ä¸š | â­â­â­â­ è¾ƒä¸“ä¸š | â­â­â­â­ è¾ƒä¸“ä¸š |
| **å¤šè½®å¯¹è¯è¿è´¯æ€§** | â­â­â­â­ è¿è´¯ | â­â­â­â­â­ éå¸¸è¿è´¯ | â­â­â­â­ è¿è´¯ |

**ç¤ºä¾‹**ï¼ˆè§’è‰²åŠ¨æ€å‘½åï¼‰ï¼š
```python
# Qwen è¾“å‡º
"ç”°å›­ç”Ÿæ´»æ–¹å¼é¡¾é—®"  # âœ… è´´åˆ"æ°‘å®¿"åœºæ™¯
"äººæœºäº¤äº’ä½“éªŒè®¾è®¡å¸ˆ"  # âœ… ä¸“ä¸šæœ¯è¯­å‡†ç¡®

# OpenAI è¾“å‡º
"Rural Lifestyle Consultant"  # âš ï¸ è‹±æ–‡æ€ç»´
"ç”°å›­ä½“éªŒä¸“å®¶"  # âœ… å¯æ¥å—
```

---

### 8ï¸âƒ£ è‡ªåŠ¨é™çº§ç­–ç•¥

é¡¹ç›®é…ç½®çš„é™çº§é“¾ï¼š
```
Qwen (ä¸») â†’ OpenAI (å¤‡é€‰1) â†’ DeepSeek (å¤‡é€‰2)
```

**è§¦å‘æ¡ä»¶**ï¼š
- API Key æ— æ•ˆ
- ç½‘ç»œè¶…æ—¶ï¼ˆ600sï¼‰
- Rate Limit é™æµ
- æœåŠ¡ä¸å¯ç”¨

**ä»£ç å®ç°**ï¼š
```python
# .env é…ç½®
LLM_AUTO_FALLBACK=true

# å·¥å‚è‡ªåŠ¨åˆ‡æ¢
if qwen_failed:
    logger.warning("âš ï¸ Qwen è°ƒç”¨å¤±è´¥ï¼Œåˆ‡æ¢åˆ° OpenAI")
    llm = create_llm(provider="openai")
```

---

## æ¨èä½¿ç”¨åœºæ™¯

### ğŸ† æ¨è Qwen çš„åœºæ™¯
1. âœ… **ä¸­æ–‡ä¸ºä¸»çš„é¡¹ç›®åˆ†æ**ï¼ˆè¯­ä¹‰ç†è§£æœ€å‡†ç¡®ï¼‰
2. âœ… **æˆæœ¬æ•æ„Ÿ**ï¼ˆæ¯” OpenAI ä¾¿å®œ 50%ï¼‰
3. âœ… **å›½å†…ç½‘ç»œç¯å¢ƒ**ï¼ˆç¨³å®šæ€§é«˜ï¼‰
4. âœ… **æ”¯æŒ Function Calling**ï¼ˆå·¥å…·è°ƒç”¨æ­£å¸¸ï¼‰

### âš ï¸ Qwen çš„åŠ£åŠ¿
1. âŒ **JSON æ ¼å¼ä¸è§„èŒƒ**ï¼ˆéœ€è¦é¢å¤–ä¿®å¤é€»è¾‘ï¼‰
2. âŒ **é¦–æ¬¡åè®®åˆè§„ç‡ä½**ï¼ˆéœ€è¦é‡è¯•æœºåˆ¶ï¼‰
3. âŒ **ä¸æ”¯æŒåŸç”Ÿ Structured Output**ï¼ˆéœ€æ‰‹åŠ¨è§£æï¼‰

### ğŸ¯ æ¨è OpenAI çš„åœºæ™¯
1. âœ… **è¦æ±‚æé«˜çš„ç»“æ„åŒ–è¾“å‡º**ï¼ˆStructured Output æœ€ä½³ï¼‰
2. âœ… **å›½é™…åŒ–é¡¹ç›®**ï¼ˆå¤šè¯­è¨€æ··åˆï¼‰
3. âœ… **å¤æ‚é€»è¾‘æ¨ç†**ï¼ˆo1-preview æ€è€ƒæ¨¡å‹ï¼‰

### ğŸš€ æ¨è DeepSeek çš„åœºæ™¯
1. âœ… **é«˜å¹¶å‘éœ€æ±‚**ï¼ˆæ—  Rate Limitï¼‰
2. âœ… **æˆæœ¬æœ€ä½**ï¼ˆä»… Â¥1/ç™¾ä¸‡tokensï¼‰
3. âœ… **å›½å†…å¿«é€Ÿå“åº”**ï¼ˆå»¶è¿Ÿæœ€ä½ï¼‰
4. âš ï¸ ä½†ä¸æ”¯æŒ `deepseek-reasoner` çš„ Function Calling

---

## é¡¹ç›®å½“å‰çŠ¶æ€

### å·²å®ç°çš„ Qwen å…¼å®¹æ€§ä¿®å¤

1. **quality_preflight.py** (line 210-237)ï¼š
   - âœ… ç§»é™¤æ³¨é‡Šï¼ˆå•è¡Œ/å¤šè¡Œï¼‰
   - âœ… ä¿®å¤ç¼ºå°‘å¼•å·çš„é”®å
   - âœ… é™çº§åˆ°é»˜è®¤å€¼

2. **specialized_agent_factory.py**ï¼š
   - âœ… åè®®é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
   - âœ… å­—æ®µéªŒè¯å¤±è´¥æ—¶è‡ªåŠ¨é‡æ–°ç”Ÿæˆ

3. **multi_llm_factory.py**ï¼š
   - âœ… è‡ªåŠ¨é™çº§é“¾ï¼ˆqwen â†’ openai â†’ deepseekï¼‰
   - âœ… ç»Ÿä¸€å‚æ•°é…ç½®ï¼ˆtemperature/max_tokens/timeoutï¼‰

### æœªä¼˜åŒ–çš„éƒ¨åˆ†

1. **Structured Output**ï¼š
   - âš ï¸ `report/result_aggregator.py` ä½¿ç”¨ `with_structured_output()`ï¼Œå¯èƒ½å¯¹ Qwen ä¸å‹å¥½
   - ğŸ’¡ å»ºè®®ï¼šæ”¹ä¸ºæ‰‹åŠ¨ JSON è§£æ + Pydantic éªŒè¯

2. **V6 Agents Prompt**ï¼š
   - âš ï¸ V6 agents 100% éœ€è¦åè®®é‡è¯•
   - ğŸ’¡ å»ºè®®ï¼šä¼˜åŒ– prompt å¼ºè°ƒ `expert_handoff_response` å¿…å¡«

3. **è§’è‰²é…ç½®å ä½ç¬¦**ï¼š
   - âš ï¸ æ‰€æœ‰è§’è‰² YAML ç¼ºå°‘ `{{project_brief}}`ã€`{{batch_info}}` å ä½ç¬¦
   - ğŸ’¡ å»ºè®®ï¼šåœ¨ `config/roles/*.yaml` ä¸­æ·»åŠ åŠ¨æ€æ³¨å…¥æ ‡è®°

---

## åˆ‡æ¢æ¨¡å‹çš„æ–¹æ³•

### æ–¹æ³• 1ï¼šä¿®æ”¹ .envï¼ˆæ¨èï¼‰
```bash
# åˆ‡æ¢åˆ° OpenAI
LLM_PROVIDER=openai

# åˆ‡æ¢åˆ° DeepSeek
LLM_PROVIDER=deepseek

# åˆ‡æ¢å› Qwen
LLM_PROVIDER=qwen
```

### æ–¹æ³• 2ï¼šä»£ç ä¸­æ‰‹åŠ¨æŒ‡å®š
```python
# åœ¨ç‰¹å®šèŠ‚ç‚¹å¼ºåˆ¶ä½¿ç”¨ OpenAI
llm = self.llm_factory.create_llm(
    provider="openai",  # è¦†ç›– .env é…ç½®
    temperature=0.3
)
```

### æ–¹æ³• 3ï¼šåŠ¨æ€é™çº§ï¼ˆè‡ªåŠ¨ï¼‰
```python
# .env å¯ç”¨è‡ªåŠ¨é™çº§
LLM_AUTO_FALLBACK=true

# å·¥å‚ä¼šè‡ªåŠ¨å°è¯•ï¼šqwen â†’ openai â†’ deepseek
llm = factory.create_with_fallback()
```

---

## æ€»ç»“

| ç»´åº¦ | Qwen | OpenAI | DeepSeek |
|------|------|--------|----------|
| **JSON è§„èŒƒæ€§** | â­â­ éœ€ä¿®å¤ | â­â­â­â­â­ å®Œç¾ | â­â­â­â­â­ å®Œç¾ |
| **ä¸­æ–‡ç†è§£** | â­â­â­â­â­ æœ€ä½³ | â­â­â­â­ è‰¯å¥½ | â­â­â­â­ è‰¯å¥½ |
| **åè®®åˆè§„ç‡** | â­â­â­ éœ€é‡è¯• | â­â­â­â­â­ é«˜ | â­â­â­â­ é«˜ |
| **é€Ÿåº¦ï¼ˆå›½å†…ï¼‰** | â­â­â­â­ å¿« | â­â­ æ…¢ | â­â­â­â­â­ æœ€å¿« |
| **æˆæœ¬** | â­â­â­â­ é€‚ä¸­ | â­â­ è´µ | â­â­â­â­â­ æœ€ä¾¿å®œ |
| **Structured Output** | â­â­ éƒ¨åˆ†æ”¯æŒ | â­â­â­â­â­ å®Œå…¨æ”¯æŒ | â­â­â­â­â­ å®Œå…¨æ”¯æŒ |
| **Function Calling** | â­â­â­â­â­ æ”¯æŒ | â­â­â­â­â­ æ”¯æŒ | â­â­â­â­ Chatæ¨¡å¼æ”¯æŒ |

**é¡¹ç›®å»ºè®®**ï¼š
- ğŸ† **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨ **OpenAI** æˆ– **DeepSeek**ï¼ˆç¨³å®šæ€§æœ€é«˜ï¼‰
- ğŸ§ª **å¼€å‘æµ‹è¯•**ï¼šä½¿ç”¨ **Qwen**ï¼ˆæˆæœ¬ä½ï¼Œä¸­æ–‡å¥½ï¼‰
- ğŸš€ **é«˜å¹¶å‘åœºæ™¯**ï¼šä½¿ç”¨ **DeepSeek**ï¼ˆé€Ÿåº¦å¿«ï¼Œæ— é™æµï¼‰
- âœ… **å½“å‰é…ç½®**ï¼ˆQwen + è‡ªåŠ¨é™çº§ï¼‰ï¼šå¹³è¡¡äº†æˆæœ¬ã€é€Ÿåº¦ä¸ç¨³å®šæ€§
