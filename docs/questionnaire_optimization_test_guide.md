# 问卷任务优化 - 快速测试指南

## 🎯 测试目标

验证P0、P1、P2三项优化是否正常工作，确认问卷数据（confirmed_core_tasks）在整个流程中得到有效利用。

---

## 📋 测试前准备

### 1. 确保环境运行
```powershell
# 启动后端服务
python -m intelligent_project_analyzer.main

# 启动前端（另一个终端）
cd frontend-nextjs
npm run dev
```

### 2. 检查日志级别
确保 `logger` 设置为 `INFO` 或 `DEBUG`，以便查看验证日志。

---

## 🧪 测试场景

### **场景1：正常流程测试（完整问卷）**

**目标**：验证所有优化在标准流程中正常工作

#### 步骤：
1. **新建会话**，选择"问卷模式"
2. **问卷Step 1**：确认2-3个核心任务
   - 示例任务："空间规划与动线设计"、"无障碍设施配置"
3. **问卷Step 2**：填写雷达图（随意填写）
4. **问卷Step 3**：选择性补充（可留空）
5. **提交问卷**，等待系统生成概念图

#### 预期结果：

**✅ P1验证（权重计算增强）**
查找日志关键词：`[权重计算] 融合问卷任务后关键词数`
```
🔍 [权重计算] 融合问卷任务后关键词数: 35
```
- 关键词数应 > 项目原始关键词数（通常增加10-20个）

**✅ P0验证（任务对齐）**
查找日志关键词：`[任务对齐]`
- **成功情况**：无警告日志（说明覆盖率 ≥ 40%）
- **警告情况**（如果出现）：
  ```
  ⚠️ [任务对齐] 交付物对核心任务的覆盖率仅32.5%，可能存在任务遗漏
  ```
  这表示选择的角色交付物与核心任务关键词重合度较低

**✅ P2验证（优先级传递）**
在LLM调用日志中查找System Prompt，应包含：
```markdown
## 📌 任务优先级指引

用户在问卷中确认了以下核心任务，这些是项目的重点关注方向：

**1. 空间规划与动线设计**
   - 优化医院内部的空间布局和患者动线

**2. 无障碍设施配置**
   - 确保所有区域符合无障碍设计标准

**执行建议：**
- 在分析时，优先围绕这些核心任务展开
```

---

### **场景2：边界测试（跳过问卷）**

**目标**：验证优化在无问卷数据时不影响正常流程

#### 步骤：
1. 新建会话，选择"聊天模式"（跳过问卷）
2. 直接发送项目描述：
   ```
   我想设计一个社区医院的室内空间，请帮我分析
   ```
3. 等待系统响应

#### 预期结果：

**✅ 自动降级**
查找日志：
- `[权重计算]` - 应使用原始关键词（无融合问卷数据的日志）
- `[任务对齐]` - 无验证日志（因为无confirmed_core_tasks）
- 专家Prompt中 - 无"📌 任务优先级指引"部分

**✅ 正常执行**
- 系统正常选择专家角色
- 专家正常生成分析
- 最终生成概念图

---

### **场景3：压力测试（大量核心任务）**

**目标**：验证性能和覆盖率计算准确性

#### 步骤：
1. 新建会话，问卷模式
2. **Step 1**：确认5-8个核心任务（尽量多）
3. 完成问卷并提交

#### 预期结果：

**✅ 性能表现**
- 关键词提取时间 < 50ms（查看日志时间戳）
- Prompt生成不明显延迟

**✅ 覆盖率计算**
- 如果任务过多，更容易触发"覆盖率不足"警告
- 这是正常现象（说明验证机制在工作）

---

### **场景4：任务覆盖率不足触发**

**目标**：故意制造不匹配场景，验证警告机制

#### 步骤：
1. 新建会话，问卷模式
2. **Step 1**：确认非常专业的任务
   - 示例："量子纠缠态空间设计"、"超导材料应用分析"
3. 完成问卷（系统会选择常规设计角色）

#### 预期结果：

**✅ 触发警告**
日志应出现：
```
⚠️ [任务对齐] 交付物对核心任务的覆盖率仅15.3%，可能存在任务遗漏
```

**✅ 不阻断流程**
- 系统继续执行（警告不中断流程）
- 最终仍生成概念图（可能质量不佳，符合预期）

---

## 🔍 日志查看位置

### 后端日志
```powershell
# 实时查看
tail -f server_log.txt  # Linux/Mac
Get-Content server_log.txt -Wait  # PowerShell

# 搜索关键词
cat server_log.txt | grep "权重计算"
cat server_log.txt | grep "任务对齐"
```

### LLM调用日志
查找包含"System Prompt"的日志，验证是否注入任务优先级指引。

---

## ✅ 验收标准

| 测试项 | 验证方式 | 期望结果 |
|--------|---------|---------|
| P1：权重增强 | 查找"融合问卷任务后关键词数" | 有日志且数量增加 |
| P0：任务对齐 | 查找"任务对齐" | 正常场景无警告 |
| P2：优先级传递 | 检查System Prompt | 包含"📌 任务优先级指引" |
| 边界保护 | 跳过问卷测试 | 无报错，正常执行 |
| 性能 | 时间戳对比 | 无明显延迟 |

---

## 🐛 常见问题排查

### 问题1：日志中没有"融合问卷任务后关键词数"
**可能原因**：
- 日志级别设置过高（只显示WARNING）
- confirmed_core_tasks为空（检查问卷数据是否正确传递）

**解决方法**：
```python
# 在 role_weight_calculator.py 中临时调整日志级别
logger.setLevel(logging.INFO)
```

### 问题2：专家Prompt中没有"任务优先级指引"
**可能原因**：
- confirmed_core_tasks未传递到ExpertPromptTemplate.render()
- _build_task_priority_section()返回了空字符串

**排查步骤**：
1. 在`project_director.py`中打断点，检查`expert_context`是否包含confirmed_core_tasks
2. 在`prompt_templates.py`中添加日志：
   ```python
   logger.info(f"🔍 state中的confirmed_core_tasks: {state.get('confirmed_core_tasks')}")
   ```

### 问题3：任务对齐警告频繁出现
**可能原因**：
- 40%阈值设置过高
- 关键词提取算法过于严格

**调整方法**：
在`dynamic_project_director.py`中修改阈值：
```python
if coverage < 0.3:  # 降低到30%
    logger.warning(...)
```

---

## 📊 测试报告模板

```markdown
## 测试报告

**测试日期**：2025-02-26
**测试人员**：[姓名]
**环境**：Python 3.10, FastAPI, Next.js

### 场景1：正常流程
- [ ] P1验证通过
- [ ] P0验证通过
- [ ] P2验证通过

### 场景2：边界测试
- [ ] 跳过问卷正常工作
- [ ] 无报错或异常

### 场景3：压力测试
- [ ] 性能表现正常
- [ ] 覆盖率计算准确

### 场景4：不匹配场景
- [ ] 警告正常触发
- [ ] 流程不中断

### 问题记录
[记录遇到的任何问题]

### 总体评价
[ ] 通过 / [ ] 有问题需要修复
```

---

**最后更新**：2025-02-26
**版本**：v1.0
