# 角色任务审核功能实现测试方案

**实施时间**: 2025-11-29
**版本**: v1.0

---

## 一、实现内容总结

### 1.1 新增组件

**RoleTaskReviewModal.tsx**
- 专用的角色任务审核模态框
- 支持查看角色列表和任务分配
- 支持编辑任务（添加/修改/删除）
- 支持三种操作：确认、修改任务、修改角色选择
- 不展示决策说明（作为系统内部思考）

### 1.2 修改文件

**page.tsx**
- 添加 `roleTaskReviewData` 和 `showRoleTaskReview` 状态
- 修改初始状态检测逻辑（Line 173-176）
- 修改 WebSocket 消息处理逻辑（Line 371-373）
- 添加 `handleRoleTaskReview` 函数（Line 499-549）
- 添加 RoleTaskReviewModal 组件（Line 1049）
- 修改 ConfirmationModal 条件（Line 1042）避免冲突

### 1.3 功能实现

✅ **确认角色和任务**
- 用户点击"确认继续"
- 发送 `{ action: "approve" }`
- 工作流继续执行

✅ **修改任务分配**
- 用户点击"修改任务分配"进入编辑模式
- 可以修改、添加、删除任务
- 保存后发送 `{ action: "approve", modifications: {...} }`
- 后端应用修改后继续执行

✅ **修改角色选择**
- 用户点击"修改角色选择"
- 发送 `{ action: "modify_roles" }`
- 返回项目总监重新规划

❌ **不实现的功能**（按用户要求）
- 更换策略（change_strategy）
- 拒绝重新规划（reject）
- 展示决策说明（decision_explanation）作为系统内部思考

---

## 二、测试场景

### 2.1 基本场景测试

#### **场景1: 查看并直接确认**

**步骤**:
1. 启动分析流程
2. 等待到达角色审核阶段
3. 查看角色列表和任务分配
4. 点击"确认继续"

**预期结果**:
- ✅ 模态框正确显示角色和任务
- ✅ 统计信息正确（角色数、任务数）
- ✅ 点击确认后工作流继续
- ✅ 控制台输出: "✅ 直接确认角色和任务"

#### **场景2: 修改任务后确认**

**步骤**:
1. 到达角色审核阶段
2. 点击"修改任务分配"进入编辑模式
3. 修改某个角色的任务描述
4. 添加一个新任务
5. 删除一个任务
6. 点击"保存并继续"

**预期结果**:
- ✅ 进入编辑模式，任务可编辑
- ✅ 修改、添加、删除操作正常
- ✅ 保存后发送正确格式的 modifications
- ✅ 控制台输出: "📝 提交 X 个角色的任务修改"
- ✅ 后端正确应用修改

**验证修改格式**:
```json
{
  "action": "approve",
  "modifications": {
    "2-1": ["修改后的任务1", "修改后的任务2", "新增任务3"],
    "3-1": ["修改后的任务A"]
  }
}
```

#### **场景3: 修改角色选择**

**步骤**:
1. 到达角色审核阶段
2. 点击"修改角色选择"

**预期结果**:
- ✅ 发送 `{ action: "modify_roles" }`
- ✅ 控制台输出: "🔄 请求修改角色选择"
- ✅ 状态更新为"正在重新规划角色选择..."
- ✅ 工作流返回项目总监节点重新规划

### 2.2 边界测试

#### **场景4: 取消编辑**

**步骤**:
1. 点击"修改任务分配"进入编辑模式
2. 修改一些任务
3. 点击"取消"

**预期结果**:
- ✅ 退出编辑模式
- ✅ 所有修改被撤销
- ✅ 恢复到原始数据

#### **场景5: 空任务处理**

**步骤**:
1. 进入编辑模式
2. 添加一个新任务但不填写内容
3. 保存

**预期结果**:
- ✅ 空任务被自动过滤
- ✅ 不会提交空字符串任务

#### **场景6: 无修改时保存**

**步骤**:
1. 进入编辑模式
2. 不做任何修改
3. 保存

**预期结果**:
- ✅ 检测到无修改
- ✅ 发送 `{ action: "approve" }` 而非带 modifications
- ✅ 控制台输出: "✅ 未检测到任务修改，直接确认"

### 2.3 UI/UX 测试

#### **场景7: 角色展开/折叠**

**步骤**:
1. 查看角色列表
2. 点击角色头部折叠/展开

**预期结果**:
- ✅ 点击后正确展开/折叠
- ✅ 默认全部展开
- ✅ 动画流畅

#### **场景8: 数据展示完整性**

**检查项**:
- ✅ 角色ID显示正确
- ✅ 动态角色名称显示
- ✅ 任务列表显示
- ✅ 关注领域（focus_areas）显示
- ✅ 预期输出（expected_output）显示
- ✅ 依赖关系（dependencies）显示
- ✅ 统计信息准确

---

## 三、测试步骤

### 3.1 准备工作

```bash
# 1. 启动后端服务
cd d:\11-20\langgraph-design
python intelligent_project_analyzer/api/server.py

# 2. 启动前端服务（新终端）
cd frontend-nextjs
npm run dev
```

### 3.2 测试执行

**测试用例1: 基本确认流程**

```bash
# 1. 访问 http://localhost:3000
# 2. 输入测试用户输入
curl -X POST http://localhost:8000/api/analysis/start \
  -H "Content-Type: application/json" \
  -d '{"user_input": "我是一位32岁不婚独立女性，对Audrey Hepburn有深深的迷恋，希望打造一个兼具英伦气质和现代松弛感的75平米一居室，预算60万"}'

# 3. 获取 session_id，访问分析页面
# http://localhost:3000/analysis/[session_id]

# 4. 等待到达角色审核阶段
# 5. 检查模态框是否正确显示
# 6. 点击"确认继续"
# 7. 检查工作流是否继续
```

**测试用例2: 任务修改流程**

```bash
# 1-4. 同上
# 5. 点击"修改任务分配"
# 6. 修改第一个角色的第一个任务
# 7. 添加一个新任务
# 8. 删除第二个任务
# 9. 点击"保存并继续"
# 10. 检查控制台日志是否显示修改信息
# 11. 检查后端日志是否接收到正确格式
```

**测试用例3: 角色选择修改流程**

```bash
# 1-4. 同上
# 5. 点击"修改角色选择"
# 6. 检查是否返回项目总监节点
# 7. 检查是否重新生成角色选择
```

### 3.3 日志验证

**前端控制台应显示**:
```
📋 检测到待审核的角色任务
🚀 开始提交角色任务审核... { action: 'approve', modifications: {...} }
📝 提交 2 个角色的任务修改
✅ 角色任务审核完成,工作流继续执行
```

**后端日志应显示**:
```
[INFO] 📥 User decision received (dict): approve
[INFO] 📝 User provided task modifications for 2 roles
[INFO]   - 更新 2-1 的 3 个任务
[INFO] ✅ User approved role selection and task assignment
```

---

## 四、验收标准

### 4.1 必须满足（P0）

- ✅ 角色审核阶段正确触发 RoleTaskReviewModal
- ✅ 不再使用 ConfirmationModal 处理角色审核
- ✅ "确认继续"功能正常
- ✅ "修改任务分配"功能正常
- ✅ "修改角色选择"功能正常
- ✅ 任务修改格式符合后端要求
- ✅ 后端正确应用任务修改

### 4.2 应该满足（P1）

- ✅ UI显示完整（角色名称、任务、统计信息）
- ✅ 编辑体验流畅（添加/修改/删除任务）
- ✅ 取消编辑功能正常
- ✅ 空任务自动过滤
- ✅ 控制台日志完整

### 4.3 可以满足（P2）

- ✅ 角色展开/折叠动画流畅
- ✅ 深色模式兼容
- ✅ 响应式布局适配

---

## 五、已知限制

1. **不展示决策说明**: `decision_explanation` 作为系统内部思考，不在UI显示
2. **不支持策略切换**: 未实现 `change_strategy` 操作
3. **不支持完全拒绝**: 未实现 `reject` 操作
4. **不支持角色编辑**: 只能修改任务，不能直接在UI编辑角色选择

这些是按照用户需求有意不实现的功能。

---

## 六、后续优化建议

### 6.1 短期优化

1. **添加确认对话框**: 修改角色选择前弹出确认对话框
2. **任务验证**: 检查任务描述长度和内容合理性
3. **加载状态**: 提交时显示加载动画

### 6.2 中期优化

1. **任务拖拽排序**: 支持拖拽调整任务顺序
2. **任务优先级**: 支持修改任务优先级
3. **历史对比**: 显示修改前后对比

### 6.3 长期优化

1. **可视化依赖关系**: 使用图表展示角色依赖
2. **智能推荐**: 根据项目类型推荐任务
3. **协作编辑**: 多人同时审核和编辑

---

**测试负责人**: 待定
**测试时间**: 2025-11-29
**测试状态**: 待测试
