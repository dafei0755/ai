# 历史记录上下文菜单功能测试指南

## ✅ 已实现的功能

### 1. 首页历史记录 (http://localhost:3000)
- ✅ 自动加载真实会话记录（从 Redis）
- ✅ 显示最近 10 条会话
- ✅ 每条记录显示：
  - 用户输入的前 100 个字符
  - 创建时间（月/日 时:分）
- ✅ 鼠标悬停显示 3 个小点按钮（⋮）
- ✅ 点击 3 个小点弹出上下文菜单

### 2. 分析页面历史记录 (http://localhost:3000/analysis/[sessionId])
- ✅ 自动加载真实会话记录
- ✅ 排除当前会话
- ✅ 显示"当前会话"和"历史记录"两个区域
- ✅ 相同的 3 个小点菜单功能

### 3. 上下文菜单功能
- ✅ **重命名**：显示输入框（功能开发中）
- ✅ **置顶**：显示提示（功能开发中）
- ✅ **分享**：✅ 完全可用 - 复制链接到剪贴板
- ✅ **删除**：显示确认对话框（功能开发中）

## 🧪 测试步骤

### 测试 1：首页历史记录菜单

1. 打开浏览器访问：http://localhost:3000
2. 查看左侧边栏"最近记录"区域
3. 应该看到 8 条真实会话记录（不是 V1/V2/V3）
4. 鼠标悬停在任意一条记录上
5. 右侧应该出现 3 个小点按钮（⋮）
6. 点击 3 个小点
7. 应该弹出包含 4 个选项的菜单：
   - 重命名 ✏️
   - 置顶 📌
   - 分享 🔗
   - 删除 🗑️

### 测试 2：测试"分享"功能

1. 在首页的历史记录上点击 3 个小点
2. 点击"分享"
3. 应该看到提示："会话链接已复制到剪贴板"
4. 打开记事本，按 Ctrl+V 粘贴
5. 应该看到类似这样的链接：
   ```
   http://localhost:3000/analysis/api-20251128184007-635a11f7
   ```

### 测试 3：分析页面历史记录菜单

1. 启动一个新分析或访问现有会话：
   http://localhost:3000/analysis/api-20251128184007-635a11f7
2. 查看左侧边栏
3. 应该看到两个区域：
   - "当前会话"：显示当前会话 ID
   - "历史记录"：显示其他会话（不包括当前）
4. 鼠标悬停在历史记录上
5. 测试 3 个小点菜单（步骤同上）

### 测试 4：点击外部关闭菜单

1. 打开 3 个小点菜单
2. 点击菜单外的任意位置
3. 菜单应该自动关闭

### 测试 5：点击历史记录跳转

1. 在首页或分析页
2. 点击任意历史记录（不是 3 个小点按钮）
3. 应该跳转到该会话的分析页面

## 🐛 已知问题

### 1. 中文文本显示为乱码 ⚠️
**现象**：历史记录显示为 `\u8e47\u51a8...` 这样的 Unicode 转义序列

**原因**：后端 JSON 序列化时没有正确处理中文编码

**影响**：不影响功能使用，只是文本显示不友好

**解决方案**：需要修复后端 `/api/sessions` 接口的 JSON 响应处理

### 2. 部分功能待开发 🚧
- 重命名功能：点击后显示"重命名功能即将推出"
- 置顶功能：点击后显示"置顶功能即将推出"
- 删除功能：点击后显示"删除功能即将推出"

只有"分享"功能完全可用。

## 📊 API 验证

可以使用以下命令验证后端 API：

```bash
# 获取所有会话列表
curl -s "http://127.0.0.1:8000/api/sessions" | python -m json.tool

# 应该返回类似这样的数据：
{
    "total": 8,
    "sessions": [
        {
            "session_id": "api-20251128184007-635a11f7",
            "status": "waiting_for_input",
            "mode": "dynamic",
            "created_at": "2025-11-28T18:40:07.565393",
            "user_input": "..."
        },
        ...
    ]
}
```

## ✅ 功能验收标准

### 必须通过：
- [x] 首页左侧显示真实历史记录（不是 V1/V2/V3）
- [x] 悬停时显示 3 个小点按钮
- [x] 点击 3 个小点弹出 4 项菜单
- [x] "分享"功能可以复制链接
- [x] 点击外部可以关闭菜单
- [x] 点击历史记录可以跳转

### 可选（下一步优化）：
- [ ] 修复中文乱码问题
- [ ] 实现重命名功能
- [ ] 实现置顶功能
- [ ] 实现删除功能

## 🎯 下一步开发计划

如果需要实现剩余的功能，需要：

1. **后端添加新的 API 接口**：
   - `PATCH /api/sessions/{session_id}` - 更新会话（重命名、置顶）
   - `DELETE /api/sessions/{session_id}` - 删除会话

2. **前端更新**：
   - 调用新 API
   - 更新本地会话列表
   - 显示成功/失败提示

3. **修复中文乱码**：
   - 后端：确保 JSON 响应使用 UTF-8 编码
   - 或在 FastAPI 响应中设置 `ensure_ascii=False`
