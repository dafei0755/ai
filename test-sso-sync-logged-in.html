<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>SSOåŒæ­¥çŠ¶æ€æµ‹è¯•ï¼ˆå·²ç™»å½•åœºæ™¯ï¼‰</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0052a3;
    }
    .result {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
    .warning { color: orange; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ğŸ” SSOåŒæ­¥çŠ¶æ€æµ‹è¯•ï¼ˆå·²ç™»å½•åœºæ™¯ï¼‰</h1>

  <div class="test-section">
    <h2>æµ‹è¯•è¯´æ˜</h2>
    <p>æ­¤æµ‹è¯•ç”¨äºè¯Šæ–­"åœ¨WordPresså·²ç™»å½•çš„æƒ…å†µä¸‹ï¼Œåº”ç”¨è¿˜æ˜¯ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ"çš„é—®é¢˜ã€‚</p>
    <p><strong>å‰ææ¡ä»¶ï¼š</strong>è¯·ç¡®ä¿ä½ å·²ç»åœ¨ <a href="https://www.ucppt.com/login" target="_blank">www.ucppt.com</a> ç™»å½•</p>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•1ï¼šæ£€æŸ¥WordPressç™»å½•çŠ¶æ€</h2>
    <button onclick="testWordPressLogin()">ğŸ” æ£€æŸ¥WordPressç™»å½•çŠ¶æ€</button>
    <div id="wp-login-result" class="result" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•2ï¼šæ£€æŸ¥SSOåŒæ­¥çŠ¶æ€</h2>
    <button onclick="testSSOSyncStatus()">ğŸ”„ æ£€æŸ¥SSOåŒæ­¥çŠ¶æ€</button>
    <div id="sso-sync-result" class="result" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•3ï¼šæ£€æŸ¥æœ¬åœ°Token</h2>
    <button onclick="testLocalToken()">ğŸ“¦ æ£€æŸ¥æœ¬åœ°Token</button>
    <div id="local-token-result" class="result" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•4ï¼šæ¨¡æ‹ŸSSOæ£€æµ‹é€»è¾‘</h2>
    <button onclick="simulateSSOCheck()">âš™ï¸ æ¨¡æ‹ŸSSOæ£€æµ‹</button>
    <div id="sso-check-result" class="result" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•5ï¼šè¿ç»­ç›‘æ§ï¼ˆ10ç§’é—´éš”ï¼‰</h2>
    <button onclick="startMonitoring()">â–¶ï¸ å¼€å§‹ç›‘æ§</button>
    <button onclick="stopMonitoring()">â¸ï¸ åœæ­¢ç›‘æ§</button>
    <div id="monitoring-result" class="result" style="display:none;"></div>
  </div>

  <script>
    let monitoringInterval = null;
    let monitoringCount = 0;

    // æµ‹è¯•1ï¼šæ£€æŸ¥WordPressç™»å½•çŠ¶æ€
    async function testWordPressLogin() {
      const result = document.getElementById('wp-login-result');
      result.style.display = 'block';
      result.textContent = 'æ­£åœ¨æ£€æŸ¥WordPressç™»å½•çŠ¶æ€...';

      try {
        const response = await fetch('https://www.ucppt.com/wp-json/wp/v2/users/me', {
          credentials: 'include'  // é‡è¦ï¼šæºå¸¦Cookie
        });

        if (response.ok) {
          const user = await response.json();
          result.innerHTML = `<span class="success">âœ… WordPresså·²ç™»å½•</span>\n\nç”¨æˆ·ä¿¡æ¯ï¼š\n${JSON.stringify(user, null, 2)}`;
        } else if (response.status === 401) {
          result.innerHTML = `<span class="error">âŒ WordPressæœªç™»å½•</span>\n\nçŠ¶æ€ç ï¼š${response.status}\nå“åº”ï¼š${await response.text()}`;
        } else {
          result.innerHTML = `<span class="warning">âš ï¸ çŠ¶æ€æœªçŸ¥</span>\n\nçŠ¶æ€ç ï¼š${response.status}\nå“åº”ï¼š${await response.text()}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ è¯·æ±‚å¤±è´¥</span>\n\né”™è¯¯ï¼š${error.message}`;
      }
    }

    // æµ‹è¯•2ï¼šæ£€æŸ¥SSOåŒæ­¥çŠ¶æ€
    async function testSSOSyncStatus() {
      const result = document.getElementById('sso-sync-result');
      result.style.display = 'block';
      result.textContent = 'æ­£åœ¨æ£€æŸ¥SSOåŒæ­¥çŠ¶æ€...';

      try {
        const response = await fetch('https://www.ucppt.com/wp-json/nextjs-sso/v1/sync-status', {
          credentials: 'include',  // é‡è¦ï¼šæºå¸¦Cookie
          headers: {
            'Accept': 'application/json'
          }
        });

        const data = await response.json();

        let statusClass = 'warning';
        let statusIcon = 'âš ï¸';
        if (data.logged_in) {
          statusClass = 'success';
          statusIcon = 'âœ…';
        } else {
          statusClass = 'error';
          statusIcon = 'âŒ';
        }

        result.innerHTML = `<span class="${statusClass}">${statusIcon} SSOåŒæ­¥è¿”å›</span>\n\n${JSON.stringify(data, null, 2)}\n\n<strong>åˆ†æï¼š</strong>\n${data.logged_in ? 'âœ… WordPressç™»å½•çŠ¶æ€æ­£ç¡®ä¼ é€’' : 'âŒ WordPressç™»å½•çŠ¶æ€æœªæ­£ç¡®ä¼ é€’ï¼ˆè¿™æ˜¯é—®é¢˜æ ¹æºï¼ï¼‰'}`;
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ è¯·æ±‚å¤±è´¥</span>\n\né”™è¯¯ï¼š${error.message}`;
      }
    }

    // æµ‹è¯•3ï¼šæ£€æŸ¥æœ¬åœ°Token
    function testLocalToken() {
      const result = document.getElementById('local-token-result');
      result.style.display = 'block';

      const token = localStorage.getItem('wp_jwt_token');
      const user = localStorage.getItem('wp_jwt_user');
      const timestamp = localStorage.getItem('wp_jwt_token_timestamp');

      if (token) {
        const tokenAge = timestamp ? Date.now() - parseInt(timestamp) : null;
        const tokenAgeSeconds = tokenAge ? Math.floor(tokenAge / 1000) : null;

        result.innerHTML = `<span class="success">âœ… æœ¬åœ°Tokenå­˜åœ¨</span>\n\nToken: ${token.substring(0, 50)}...\n\nç”¨æˆ·ä¿¡æ¯ï¼š\n${user}\n\næ—¶é—´æˆ³ï¼š${timestamp}\nTokenå¹´é¾„ï¼š${tokenAgeSeconds}ç§’\n\n<strong>åˆ†æï¼š</strong>\n${tokenAge > 30000 ? 'âš ï¸ Tokenå¹´é¾„ > 30ç§’ï¼ŒSSOæ£€æµ‹ä¼šæ¸…é™¤' : 'âœ… Tokenå¹´é¾„ < 30ç§’ï¼ŒSSOæ£€æµ‹ä¼šä¿ç•™'}`;
      } else {
        result.innerHTML = `<span class="error">âŒ æœ¬åœ°Tokenä¸å­˜åœ¨</span>\n\nè¿™å¯èƒ½æ˜¯å¯¼è‡´è‡ªåŠ¨è·³è½¬çš„åŸå› ã€‚`;
      }
    }

    // æµ‹è¯•4ï¼šæ¨¡æ‹ŸSSOæ£€æµ‹é€»è¾‘
    async function simulateSSOCheck() {
      const result = document.getElementById('sso-check-result');
      result.style.display = 'block';
      result.textContent = 'æ­£åœ¨æ¨¡æ‹ŸSSOæ£€æµ‹é€»è¾‘...';

      let log = '';

      // Step 1: æ£€æŸ¥æœ¬åœ°Token
      const token = localStorage.getItem('wp_jwt_token');
      const userStr = localStorage.getItem('wp_jwt_user');
      const timestamp = localStorage.getItem('wp_jwt_token_timestamp');

      log += '=== Step 1: æ£€æŸ¥æœ¬åœ°Token ===\n';
      if (!token || !userStr) {
        log += 'âŒ æœ¬åœ°æ— Tokenæˆ–ç”¨æˆ·ä¿¡æ¯\n';
        log += 'ç»“æœï¼šä¸ä¼šè§¦å‘æ¸…é™¤é€»è¾‘\n';
        result.textContent = log;
        return;
      }

      const user = JSON.parse(userStr);
      const localUserId = user.user_id;
      const tokenAge = timestamp ? Date.now() - parseInt(timestamp) : Infinity;

      log += `âœ… æœ¬åœ°Tokenå­˜åœ¨\n`;
      log += `ç”¨æˆ·IDï¼š${localUserId}\n`;
      log += `Tokenå¹´é¾„ï¼š${Math.floor(tokenAge / 1000)}ç§’\n\n`;

      // Step 2: æ£€æŸ¥SSOçŠ¶æ€
      log += '=== Step 2: æ£€æŸ¥SSOçŠ¶æ€ ===\n';
      try {
        const response = await fetch('https://www.ucppt.com/wp-json/nextjs-sso/v1/sync-status', {
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });

        const data = await response.json();
        log += `SSOè¿”å›ï¼š${JSON.stringify(data)}\n\n`;

        // Step 3: åˆ¤æ–­é€»è¾‘
        log += '=== Step 3: åˆ¤æ–­é€»è¾‘ ===\n';

        if (!data.logged_in && localUserId) {
          log += 'âš ï¸ æ£€æµ‹åˆ°WordPressæœªç™»å½•ï¼Œä½†æœ¬åœ°æœ‰ç”¨æˆ·Token\n';

          if (tokenAge > 30000) {
            log += `âŒ Tokenå¹´é¾„ ${Math.floor(tokenAge / 1000)}ç§’ > 30ç§’\n`;
            log += 'ğŸ”¥ <strong>ç»“æœï¼šä¼šæ¸…é™¤Tokenï¼Œè§¦å‘è·³è½¬åˆ°ç™»å½•é¡µï¼</strong>\n\n';
            log += 'è¿™å°±æ˜¯ä½ é‡åˆ°çš„é—®é¢˜ï¼';
          } else {
            log += `âœ… Tokenå¹´é¾„ ${Math.floor(tokenAge / 1000)}ç§’ <= 30ç§’\n`;
            log += 'ç»“æœï¼šè·³è¿‡æ¸…é™¤ï¼ˆæ—¶é—´çª—å£ä¿æŠ¤ï¼‰\n';
          }
        } else if (data.logged_in && localUserId !== data.user_id) {
          log += 'âš ï¸ æ£€æµ‹åˆ°ç”¨æˆ·åˆ‡æ¢\n';
          log += `æœ¬åœ°ç”¨æˆ·ï¼š${localUserId}\n`;
          log += `WordPressç”¨æˆ·ï¼š${data.user_id}\n`;
          log += 'ç»“æœï¼šä¼šè·å–æ–°Token\n';
        } else if (data.logged_in) {
          log += 'âœ… WordPresså·²ç™»å½•ï¼Œç”¨æˆ·IDåŒ¹é…\n';
          log += 'ç»“æœï¼šä¸ä¼šè§¦å‘ä»»ä½•æ“ä½œ\n';
        } else {
          log += 'âœ… æœ¬åœ°æ— Tokenï¼ŒWordPressä¹Ÿæœªç™»å½•\n';
          log += 'ç»“æœï¼šæ­£å¸¸çŠ¶æ€\n';
        }

      } catch (error) {
        log += `âŒ SSOæ£€æµ‹å¤±è´¥ï¼š${error.message}\n`;
      }

      result.innerHTML = log;
    }

    // æµ‹è¯•5ï¼šè¿ç»­ç›‘æ§
    function startMonitoring() {
      if (monitoringInterval) {
        alert('ç›‘æ§å·²åœ¨è¿è¡Œä¸­');
        return;
      }

      monitoringCount = 0;
      const result = document.getElementById('monitoring-result');
      result.style.display = 'block';
      result.textContent = 'å¼€å§‹ç›‘æ§SSOçŠ¶æ€ï¼ˆæ¯10ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰...\n\n';

      const check = async () => {
        monitoringCount++;
        const timestamp = new Date().toLocaleTimeString();

        try {
          const response = await fetch('https://www.ucppt.com/wp-json/nextjs-sso/v1/sync-status', {
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
          });

          const data = await response.json();
          const status = data.logged_in ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•';

          result.textContent += `[${timestamp}] ç¬¬${monitoringCount}æ¬¡æ£€æŸ¥ - ${status} - user_id: ${data.user_id}\n`;
          result.scrollTop = result.scrollHeight;

        } catch (error) {
          result.textContent += `[${timestamp}] ç¬¬${monitoringCount}æ¬¡æ£€æŸ¥ - âŒ å¤±è´¥: ${error.message}\n`;
        }
      };

      check();  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
      monitoringInterval = setInterval(check, 10000);
    }

    function stopMonitoring() {
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
        monitoringInterval = null;
        const result = document.getElementById('monitoring-result');
        result.textContent += `\nç›‘æ§å·²åœæ­¢ï¼ˆå…±${monitoringCount}æ¬¡æ£€æŸ¥ï¼‰`;
      }
    }
  </script>
</body>
</html>
