<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>v3.0.15 æµè§ˆå™¨ç«¯æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            background: #252526;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 {
            color: #4ec9b0;
            margin-top: 0;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.2s;
        }
        button:hover {
            background: #1177bb;
        }
        button:disabled {
            background: #3c3c3c;
            cursor: not-allowed;
        }
        .result {
            background: #1e1e1e;
            border-left: 4px solid #4ec9b0;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-family: 'Consolas', 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success {
            border-left-color: #4ec9b0;
            color: #4ec9b0;
        }
        .error {
            border-left-color: #f48771;
            color: #f48771;
        }
        .warning {
            border-left-color: #dcdcaa;
            color: #dcdcaa;
        }
        .info {
            border-left-color: #569cd6;
            color: #569cd6;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #2d2d30;
            border-radius: 6px;
        }
        .test-section h2 {
            color: #569cd6;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª WordPress SSO v3.0.15 æµè§ˆå™¨ç«¯æµ‹è¯•</h1>
        <p>è¿™ä¸ªå·¥å…·ä¼šåœ¨æµè§ˆå™¨ä¸­æµ‹è¯•å®Œæ•´çš„SSOæµç¨‹ï¼Œç¡®ä¿Cookieæ­£ç¡®ä¼ é€’</p>

        <div class="test-section">
            <h2>æµ‹è¯• 1: WordPress REST API</h2>
            <button onclick="testWordPressAPI()">æµ‹è¯• WordPress Token è·å–</button>
            <div id="wordpress-result"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯• 2: Python åç«¯</h2>
            <button onclick="testPythonBackend()">æµ‹è¯• Python å¥åº·æ£€æŸ¥</button>
            <div id="python-result"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯• 3: Token éªŒè¯</h2>
            <button id="verify-btn" onclick="testTokenVerify()" disabled>éªŒè¯ Tokenï¼ˆéœ€å…ˆå®Œæˆæµ‹è¯•1ï¼‰</button>
            <div id="verify-result"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯• 4: å®Œæ•´æµç¨‹æ¨¡æ‹Ÿ</h2>
            <button onclick="testFullFlow()">æ¨¡æ‹Ÿç”¨æˆ·ç‚¹å‡»"ç«‹å³ä½¿ç”¨"æŒ‰é’®</button>
            <div id="flow-result"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯• 5: Next.js åº”ç”¨æµ‹è¯•</h2>
            <button onclick="openNextApp()">åœ¨æ–°çª—å£æ‰“å¼€åº”ç”¨ï¼ˆæ¨¡æ‹Ÿå®£ä¼ é¡µæŒ‰é’®ï¼‰</button>
            <p style="color: #858585; font-size: 14px;">
                ç‚¹å‡»åä¼šåœ¨æ–°çª—å£æ‰“å¼€åº”ç”¨ï¼Œè¯·æŸ¥çœ‹æ–°çª—å£çš„æ§åˆ¶å°æ—¥å¿—
            </p>
        </div>
    </div>

    <script>
        let currentToken = null;

        async function testWordPressAPI() {
            const resultDiv = document.getElementById('wordpress-result');
            resultDiv.innerHTML = '<div class="result info">æ­£åœ¨æµ‹è¯•...</div>';

            try {
                const response = await fetch('https://www.ucppt.com/wp-json/nextjs-sso/v1/get-token', {
                    method: 'GET',
                    credentials: 'include', // å…³é”®: å‘é€Cookie
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const statusCode = response.status;
                console.log('[Test] WordPress API Status:', statusCode);

                if (statusCode === 200) {
                    const data = await response.json();
                    currentToken = data.token;

                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… æµ‹è¯•é€šè¿‡ï¼
                            HTTPçŠ¶æ€ç : ${statusCode}
                            Tokené•¿åº¦: ${data.token ? data.token.length : 0} å­—ç¬¦
                            ç”¨æˆ·ID: ${data.user?.ID || 'N/A'}
                            ç”¨æˆ·å: ${data.user?.user_login || 'N/A'}

                            å®Œæ•´å“åº”:
                            ${JSON.stringify(data, null, 2)}
                        </div>
                    `;

                    document.getElementById('verify-btn').disabled = false;
                } else if (statusCode === 401) {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            âŒ æµ‹è¯•å¤±è´¥ï¼
                            HTTPçŠ¶æ€ç : 401 (æœªç™»å½•)

                            åŸå› åˆ†æ:
                            1. æ‚¨æœªåœ¨ WordPress ç™»å½•
                            2. æˆ– WPCOM Member Pro çš„ Cookie ä¸è¢« WordPress è¯†åˆ«

                            è§£å†³æ–¹æ¡ˆ:
                            1. è®¿é—® https://www.ucppt.com
                            2. ä½¿ç”¨ WPCOM ç”¨æˆ·ä¸­å¿ƒç™»å½•
                            3. ç¡®è®¤å³ä¸Šè§’æ˜¾ç¤ºç”¨æˆ·å
                            4. è¿”å›æ­¤é¡µé¢é‡æ–°æµ‹è¯•
                        </div>
                    `;
                } else {
                    const text = await response.text();
                    resultDiv.innerHTML = `
                        <div class="result error">
                            âŒ æ„å¤–çš„çŠ¶æ€ç : ${statusCode}
                            å“åº”å†…å®¹: ${text}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ ç½‘ç»œé”™è¯¯: ${error.message}
                    </div>
                `;
                console.error('[Test] WordPress API Error:', error);
            }
        }

        async function testPythonBackend() {
            const resultDiv = document.getElementById('python-result');
            resultDiv.innerHTML = '<div class="result info">æ­£åœ¨æµ‹è¯•...</div>';

            try {
                const response = await fetch('http://127.0.0.1:8000/health', {
                    method: 'GET'
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… æµ‹è¯•é€šè¿‡ï¼
                            Pythonåç«¯è¿è¡Œæ­£å¸¸
                            çŠ¶æ€: ${data.status}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            âŒ Pythonåç«¯çŠ¶æ€å¼‚å¸¸
                            HTTPçŠ¶æ€ç : ${response.status}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ Pythonåç«¯æ— æ³•è¿æ¥
                        é”™è¯¯: ${error.message}

                        è¯·å¯åŠ¨åç«¯æœåŠ¡:
                        python -m uvicorn intelligent_project_analyzer.api.server:app --host 0.0.0.0 --port 8000
                    </div>
                `;
                console.error('[Test] Python Backend Error:', error);
            }
        }

        async function testTokenVerify() {
            const resultDiv = document.getElementById('verify-result');

            if (!currentToken) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·å…ˆå®Œæˆæµ‹è¯•1è·å–Token</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="result info">æ­£åœ¨éªŒè¯Token...</div>';

            try {
                const response = await fetch('http://127.0.0.1:8000/api/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… TokenéªŒè¯æˆåŠŸï¼
                            ç”¨æˆ·å: ${data.user?.username || 'N/A'}
                            ç”¨æˆ·ID: ${data.user?.user_id || 'N/A'}

                            å®Œæ•´å“åº”:
                            ${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    resultDiv.innerHTML = `
                        <div class="result error">
                            âŒ TokenéªŒè¯å¤±è´¥
                            HTTPçŠ¶æ€ç : ${response.status}
                            é”™è¯¯ä¿¡æ¯: ${JSON.stringify(errorData, null, 2)}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ TokenéªŒè¯å¼‚å¸¸: ${error.message}
                    </div>
                `;
                console.error('[Test] Token Verify Error:', error);
            }
        }

        async function testFullFlow() {
            const resultDiv = document.getElementById('flow-result');
            resultDiv.innerHTML = '<div class="result info">å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...</div>';

            let log = 'å®Œæ•´æµç¨‹æ—¥å¿—:\n\n';

            // æ­¥éª¤1: è·å–Token
            log += 'æ­¥éª¤1: è°ƒç”¨ WordPress REST API è·å– Token...\n';
            try {
                const tokenResponse = await fetch('https://www.ucppt.com/wp-json/nextjs-sso/v1/get-token', {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Accept': 'application/json' }
                });

                log += `  çŠ¶æ€ç : ${tokenResponse.status}\n`;

                if (tokenResponse.status === 200) {
                    const tokenData = await tokenResponse.json();
                    log += `  âœ… Tokenè·å–æˆåŠŸ\n`;
                    log += `  Tokené•¿åº¦: ${tokenData.token.length}\n\n`;

                    // æ­¥éª¤2: éªŒè¯Token
                    log += 'æ­¥éª¤2: éªŒè¯ Token...\n';
                    const verifyResponse = await fetch('http://127.0.0.1:8000/api/auth/verify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${tokenData.token}`
                        }
                    });

                    log += `  çŠ¶æ€ç : ${verifyResponse.status}\n`;

                    if (verifyResponse.ok) {
                        const verifyData = await verifyResponse.json();
                        log += `  âœ… TokenéªŒè¯æˆåŠŸ\n`;
                        log += `  ç”¨æˆ·: ${verifyData.user.username}\n\n`;

                        log += 'æ­¥éª¤3: æ¨¡æ‹Ÿè·³è½¬åˆ° /analysis\n';
                        log += '  âœ… åº”è¯¥è‡ªåŠ¨è·³è½¬åˆ°åˆ†æé¡µé¢\n\n';

                        log += 'ğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡ï¼\n';
                        log += '\nä¸‹ä¸€æ­¥: åœ¨å®é™…åº”ç”¨ä¸­æµ‹è¯•ï¼ˆç‚¹å‡»"æµ‹è¯•5"ï¼‰';

                        resultDiv.innerHTML = `<div class="result success">${log}</div>`;
                    } else {
                        log += `  âŒ TokenéªŒè¯å¤±è´¥\n`;
                        resultDiv.innerHTML = `<div class="result error">${log}</div>`;
                    }
                } else if (tokenResponse.status === 401) {
                    log += '  âŒ WordPressæœªç™»å½•\n';
                    log += '\nè¯·å…ˆç™»å½• https://www.ucppt.com';
                    resultDiv.innerHTML = `<div class="result error">${log}</div>`;
                } else {
                    log += `  âŒ æ„å¤–é”™è¯¯\n`;
                    resultDiv.innerHTML = `<div class="result error">${log}</div>`;
                }
            } catch (error) {
                log += `  âŒ å¼‚å¸¸: ${error.message}\n`;
                resultDiv.innerHTML = `<div class="result error">${log}</div>`;
            }
        }

        function openNextApp() {
            const appUrl = 'http://localhost:3000';
            console.log('[Test] Opening Next.js app in new window:', appUrl);

            const newWindow = window.open(appUrl, '_blank', 'noopener,noreferrer');

            const resultDiv = document.getElementById('flow-result');
            if (newWindow) {
                resultDiv.innerHTML = `
                    <div class="result success">
                        âœ… æ–°çª—å£å·²æ‰“å¼€ï¼

                        è¯·åœ¨æ–°çª—å£çš„æ§åˆ¶å°æŸ¥çœ‹ä»¥ä¸‹æ—¥å¿—:
                        1. [AuthContext] å°è¯•é€šè¿‡ WordPress REST API è·å– Token...
                        2. [AuthContext] âœ… é€šè¿‡ REST API è·å–åˆ° Tokenï¼ŒéªŒè¯ä¸­...
                        3. [AuthContext] âœ… REST API Token éªŒè¯æˆåŠŸ
                        4. [AuthContext] ğŸ”€ æ£€æµ‹åˆ°å·²ç™»å½•ï¼Œè·³è½¬åˆ°åˆ†æé¡µé¢

                        å¦‚æœçœ‹åˆ°ä»¥ä¸Šæ—¥å¿—ï¼Œè¯´æ˜v3.0.15å·¥ä½œæ­£å¸¸ï¼
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ å¼¹çª—è¢«æµè§ˆå™¨æ‹¦æˆª
                        è¯·å…è®¸æ­¤ç½‘ç«™çš„å¼¹çª—åé‡è¯•
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæç¤º
        window.addEventListener('load', () => {
            console.log('[v3.0.15 Test Tool] Ready. Start testing!');
        });
    </script>
</body>
</html>
